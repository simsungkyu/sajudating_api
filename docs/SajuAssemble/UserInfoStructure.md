# 1페이지 요약: 유저 정보(명식 대상) 표준 구조

## A) 유저 기본 식별/메타(필수 최소)

| 필드 | 설명 |
|------|------|
| `user_id` | 내부 식별자(문자열) |
| `created_at`, `updated_at` | 생성/수정 시각 |
| `data_version` | 유저 데이터 포맷 버전 |
| `rule_set` | 계산 룰셋/유파 식별자(예: korean_standard_v1) |
| `engine_version` | 계산 엔진 버전(재현성/디버깅용) |

---

## B) 입력 정보(필수: "명식 계산의 원본")

이 블록이 진짜 원본 입력이고, 나머지는 여기서 파생됨.

| 필드 | 형식/설명 |
|------|-----------|
| `birth.date` | YYYY-MM-DD |
| `birth.time` | HH:mm (모르면 "unknown") |
| `birth.time_precision` | minute \| hour \| unknown |
| `timezone` | 예: Asia/Seoul |
| `calendar` | solar \| lunar |
| (음력일 때) `is_leap_month` | boolean |
| (선택) `location` | city/lat/lon (절기/시각 보정에 필요하면) |
| (선택) `gender` | 해석 텍스트/카드에 필요하면 |

---

## C) 원국 결과(필수: "4기둥 고정 결과")

| 필드 | 설명 |
|------|------|
| `pillars.y` / `pillars.m` / `pillars.d` / `pillars.h` | 간지 문자열(예: 庚午) |
| (선택) `dm` | 일간(예: 甲) |

> 사실상 `pillars.d`에서 stem만 뽑으면 되지만 편의상 저장해도 됨.  
> 여기까지가 "유저 명식의 뼈대" (항상 있어야 함).

---

## C') 지장간 — 원천 팩트

지장간 item을 **"원천 팩트"**로 다룸. 의미가 명확하고 L/M/H 등급화가 쉬움.

**최소 스키마(추천):**

| 필드 | 설명 |
|------|------|
| `k` | `"지장간"` |
| `n` | `<숨은 천간>` (예: 癸) |
| `where` | `["월지.지장간.본기"]` 처럼 **어느 지지의 지장간인지 + 슬롯**(본기/중기/여기) |
| `w` | 0~100, **그 지지 내부에서의 비중**(합=100 권장) |

**예시:**

```json
{ "id": "hid_mB_1", "k": "지장간", "n": "己", "where": ["월지.지장간.본기"], "w": 60 }
{ "id": "hid_mB_2", "k": "지장간", "n": "癸", "where": ["월지.지장간.중기"], "w": 30 }
{ "id": "hid_mB_3", "k": "지장간", "n": "辛", "where": ["월지.지장간.여기"], "w": 10 }
```

**포인트:** `월지.지장간` 내부에서 합이 100이 되게 유지하면, 해석/정렬/임계값이 안정적임.

---

## D) 계산 결과(권장: items 정본)

모든 계산 항목은 `items[]` 하나로 통일 (십성/관계/오행/신살/격국/용신/육친/강약/확신 등).

**items[] 공통 필드(최소):**

| 필드 | 설명 |
|------|------|
| `k` | 카테고리(예: 지장간, 십성, 관계, 오행, 신살, 격국, 용신, 육친, 강약, 확신) |
| `n` | 이름(예: 정재, 충, 토, 도화, 정재격, 수, 부친, 중화, 전체) |
| `where` | 위치 토큰 배열(예: ["월간"], ["일지-년지"], ["월지.지장간"]) — 없으면 생략 가능 |
| `w` | 0~100 가중치(필요한 항목만, 없으면 생략) |
| `sys` | 룰/방법(유파 갈리는 항목에 권장: 신살/용신/격국/강약/확신) |

---

## E) 검색/트리거용 캐시(선택: tokens)

카드 선택을 빠르고 단순하게 하려면 items → tokens를 생성해서 사용  
(저장해도 되고, 런타임 생성해도 됨).

| 필드 | 설명 |
|------|------|
| `tokens[]` | 문자열 토큰 배열 |

**예:** `십성:정재@월간#H`, `관계:충@일지-년지#H`, `오행:토#H`, `신살:도화@일지`, `확신:용신#L`

런타임에서는 `tokenSet = Set(tokens)` 만들어서 O(1) 조회.

---

## F) 최소 예시(JSON)

```json
{
  "user_id": "u_123",
  "data_version": 1,
  "rule_set": "korean_standard_v1",
  "engine_version": "saju-calc@0.1.0",
  "created_at": "2026-02-01T10:00:00+09:00",

  "input": {
    "birth": { "date": "1990-01-01", "time": "10:00", "time_precision": "hour" },
    "timezone": "Asia/Seoul",
    "calendar": "solar",
    "is_leap_month": false,
    "gender": "unknown"
  },

  "pillars": { "y": "庚午", "m": "己丑", "d": "甲子", "h": "丁卯" },

  "items": [
    { "k": "십성", "n": "정재", "where": ["월간"], "w": 78 },
    { "k": "관계", "n": "충", "where": ["일지-년지"], "w": 100 },
    { "k": "오행", "n": "토", "w": 72 },
    { "k": "신살", "n": "도화", "where": ["일지"], "sys": "common_v1" },
    { "k": "강약", "n": "중화", "w": 52, "sys": "simple_weight_v1" },
    { "k": "확신", "n": "전체", "w": 80 }
  ],

  "tokens": [
    "십성:정재",
    "십성:정재@월간",
    "십성:정재#H",
    "관계:충@일지-년지#H",
    "오행:토#H",
    "신살:도화@일지",
    "강약:중화#M",
    "확신:전체#H"
  ]
}
```

---

## G) 카드 조건이 "무엇을 비교하나" (유저 데이터 관점)

| 연산 | 방법 |
|------|------|
| **존재/위치/등급** | tokens로: `tokenSet.has("십성:정재@월간#H")` |
| **정밀 숫자(w)** | items로(예외): 특정 카드만 items에서 `w >= 85` 같은 추가 조건 |
