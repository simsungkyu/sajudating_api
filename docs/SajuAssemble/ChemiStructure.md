# 0) 궁합 데이터의 핵심 정의

궁합(2인)은 3개의 토큰 집합을 동시에 다룬다.

- **A_tokens**: A 원국(개인) 토큰 Set
- **B_tokens**: B 원국(개인) 토큰 Set
- **P_tokens**: A↔B 상호작용(궁합) 토큰 Set ← 궁합의 핵심

궁합 카드는 기본적으로 P_tokens로 선택하고, 필요하면 A/B 토큰도 조건으로 같이 본다.

---

# 1) 궁합 items 설계 규칙

## 1-1) 궁합 items는 "상호작용 facts"만 담는다

개인 facts(십성/오행/신살 등)는 A/B에 이미 있으니, 궁합 items에는 이런 것만 넣는다:

- 관계 이벤트(충/합/형/파/해/삼합/천간합 등): A의 특정 위치 ↔ B의 특정 위치
- 보완/상극 같은 테마적 상호작용(오행 상보, 기질 상충 등)
- 테마 점수(소통/갈등/재정/성장 등)
- 확신(신뢰도) / 입력 품질(출생시간 불명 등)

## 1-2) 궁합 item 최소 스키마(추천)

```json
{
  "k": "궁합",
  "n": "충",
  "where": ["A.일지-B.일지"],
  "w": 90,
  "sys": "pair_v1"
}
```

- **k**: 고정 `"궁합"` (단순하게 시작)
- **n**: 이벤트/테마 이름(예: 충, 합, 오행상보, 소통점수)
- **where**: 반드시 A/B 주체를 포함
- **w**: 강도/영향(0~100) (필요 없는 항목은 생략 가능)
- **sys**: 궁합 계산 룰 버전(유파/정책 차이 대비)

where 표준은 아래 "위치 규칙" 섹션에서 고정한다.

---

# 2) 궁합 tokens 생성 규칙

## 2-1) 토큰 문법(궁합 전용)

```
궁합:<이름>[@<A/B 위치쌍>][#<L|M|H>][~<sys>]
```

예:

- `궁합:충@A.일지-B.일지#H`
- `궁합:천간합@A.일간-B.월간#M`
- `궁합:소통점수#M`
- `궁합:확신#L~pair_v1`

## 2-2) items → tokens 생성(궁합도 동일 원칙)

궁합 item 1개에서 기본적으로 아래를 만든다:

- **존재**: `궁합:n`
- **위치**: `궁합:n@where` (where가 있으면)
- **등급**: `궁합:n#L/M/H` (w가 있으면)
- **위치+등급**: `궁합:n@where#L/M/H` (where & w)
- **(선택) sys 포함**: `...~sys`

## 2-3) 등급(L/M/H) 기준(궁합 공통 기본)

- **L**: 0–49
- **M**: 50–69
- **H**: 70–100

(나중에 테마 점수만 별도 기준을 쓰고 싶으면 sys로 구분)

---

# 3) 궁합 where(위치) 표준 규칙

## 3-1) 개인 위치 표준(재사용)

년간/년지/월간/월지/일간/일지/시간/시지

지장간: `월지.지장간`, 더 세분 시 `월지.지장간.본기/중기/여기`

## 3-2) 궁합 위치쌍 표준

항상 `A.<pos>-B.<pos>` 형태로 고정

예:

- `A.일지-B.일지`
- `A.일간-B.월간`
- `A.월지.지장간-B.일간`

**중요**: 궁합은 "A↔B" 방향이 있으니, 쌍을 정렬하지 말고 항상 A쪽이 먼저로 고정(재현성/디버깅 쉬움).

---

# 4) 궁합 카드 데이터 정의 및 룰

## 4-1) 궁합 카드는 별도로 두는 게 좋다

카드 문장도 "개인 성향"이 아니라 "두 사람 관계" 톤이고, 조건도 P_tokens를 보게 되므로 **scope:"pair"**로 분리하는 걸 추천.

## 4-2) 궁합 카드 스키마(추천)

```json
{
  "card_id": "pair_conflict_001",
  "scope": "pair",
  "status": "published",
  "rule_set": "korean_standard_v1",

  "title": "생활 리듬 충돌 가능성",
  "tags": ["conflict", "communication"],
  "priority": 60,

  "trigger": {
    "all": [
      { "src": "P", "token": "궁합:충#H" }
    ],
    "any": [
      { "src": "P", "token": "궁합:충@A.일지-B.일지#H" },
      { "src": "P", "token": "궁합:형#H" }
    ],
    "not": [
      { "src": "P", "token": "궁합:확신#L" }
    ]
  },

  "score": {
    "base": 50,
    "bonus_if": [
      { "src": "P", "token": "궁합:소통점수#H", "add": 10 }
    ],
    "penalty_if": [
      { "src": "P", "token": "궁합:갈등점수#H", "sub": 10 }
    ]
  },

  "content": {
    "summary": "일상 루틴/속도 차이로 부딪힐 수 있어요. 규칙을 정하면 안정적으로 갈 가능성이 큽니다.",
    "questions": [
      "갈등이 생기면 바로 대화로 푸는 편인가요, 시간을 두는 편인가요?",
      "생활 루틴에서 서로 양보가 어려운 포인트가 있나요?"
    ]
  }
}
```

### src 의미(중요)

- **src:"P"** = 궁합 토큰 Set (P_tokens)
- **src:"A"** = A 개인 토큰 Set (A_tokens)
- **src:"B"** = B 개인 토큰 Set (B_tokens)

이렇게 하면 궁합 카드에서 이런 것도 가능:

"궁합 충이 강하고, A가 신강이면 갈등 시 밀어붙이기 쉬움" 같은 조건 → `{ "src": "A", "token": "강약:신강#H" }` 같이 추가

---

# 5) 궁합 카드 선택(전체 로직 요약)

**Step 1) 개인 계산**

- A 입력 → A_items 생성 → A_tokens 생성(Set)
- B 입력 → B_items 생성 → B_tokens 생성(Set)

**Step 2) 궁합 상호작용 계산**

- A/B 원국을 사용해 P_items 생성(충합/오행상보/테마점수/확신 등)
- P_items → P_tokens 생성(Set)

**Step 3) 궁합 카드 탐색**

모든 `scope="pair"` 카드에 대해:

1. **not** 먼저 체크(하나라도 있으면 탈락)
2. **all** 체크(전부 있어야 통과)
3. **any** 체크(있으면 하나 이상 만족해야 통과)

※ 각 조건은 (src, token)에 해당하는 Set에서 `has(token)`로 조회

**Step 4) 정렬/컷/중복 제한(권장)**

- priority + score로 정렬
- 태그/도메인별 최대 N장 제한
- 갈등류 카드가 과다 노출되지 않게 `cooldown_group` 같은 장치 권장

**Step 5) 출력(권장 UX)**

- A 개인 카드 Top N
- B 개인 카드 Top N
- 궁합 카드 Top M  
  ("각자 성향 + 관계 포인트" 구성이 체감이 가장 좋음)

---

# 6) 구현 팁(운영 안정성)

- **정본은 items**: 언제든 재현 가능해야 함
- **P_tokens는 파생 캐시**: 저장해도 되고 런타임 생성해도 됨
- **룰/유파가 갈리는 건** 반드시 `sys`와 `궁합:확신` 토큰으로 가드
- **입력 품질(출생시간 불명 등)이 낮으면**:
  - `궁합:확신#L` 토큰을 넣고
  - 카드에서 단정 톤을 막는 not/가드레일로 제어
