<!-- 사주/토큰 기반 카드 정의·트리거·로직 및 운영 규칙 문서. -->

# 카드 데이터 구조 (Card Data Structure)

사주/토큰 기반 카드 정의·트리거·로직 및 운영 규칙 문서.

---

## 1) 카드 데이터 정의 (권장 스키마)

### A. 카드의 목적

한 장의 카드는 **"특정 조건(토큰/아이템)이 만족되면"** 선택되어  
요약 / 해석 포인트 / 질문을 제공하는 **단위 콘텐츠**이다.

### B. Card JSON (권장)

```json
{
  "card_id": "십성_정재_강함_v1",
  "version": 1,
  "status": "published",
  "rule_set": "korean_standard_v1",

  "title": "정재가 강하게 드러남",
  "category": "십성",
  "tags": ["money", "planning", "responsibility"],
  "domains": ["personality", "work"],

  "priority": 60,
  "cooldown_group": "money_core",
  "max_per_user": 1,

  "trigger": {
    "all": [
      { "token": "십성:정재" },
      { "token": "십성:정재#H" }
    ],
    "any": [
      { "token": "십성:정재@월간" },
      { "token": "십성:정재@월지.지장간" }
    ],
    "not": [
      { "token": "확신:십성#L" }
    ]
  },

  "score": {
    "base": 50,
    "bonus_if": [
      { "token": "십성:정재@월간#H", "add": 20 },
      { "token": "오행:토#H", "add": 10 }
    ],
    "penalty_if": [
      { "token": "관계:충#H", "sub": 10 }
    ]
  },

  "content": {
    "summary": "현실적인 계획과 자원 관리 성향이 강해질 수 있습니다.",
    "points": [
      "장점: 예산/일정/루틴을 세우고 지키는 데 강점이 생기기 쉽습니다.",
      "주의: 안정 추구가 강해지면 변화 대응이 늦어질 수 있습니다."
    ],
    "questions": [
      "요즘 '관리 부담'이 크게 느껴지는 영역(일/돈/시간)이 있나요?",
      "계획은 잘 세우는데 실행이 끊기는 패턴이 있다면 어떤 상황에서 그래요?"
    ],
    "guardrails": [
      "단정 표현(반드시/무조건) 금지",
      "민감한 개인사 질문은 선택형으로"
    ]
  },

  "debug": {
    "description": "정재 HIGH + (월간 또는 월지 지장간)에서 발견되면 선택"
  }
}
```

### C. 필드 설명 (핵심만)

| 구분 | 필드 | 설명 |
|------|------|------|
| 배포/버전 | `card_id`, `version`, `status`, `rule_set` | 배포·버전·룰셋 관리 |
| 분류 | `category`, `tags`, `domains` | 분류 / 필터 / 중복 제거 / 노출 제어 |
| 정렬 | `priority` | 기본 우선순위 (선택 후 정렬에 사용) |
| 조건 | `trigger` | 적용 조건 (아래 로직 참조) |
| 점수 | `score` | (선택) 매칭 강도에 따른 가감점 → "상위 N장 선택"에 유용 |
| 노출 | `content` | 사용자에게 보여줄 텍스트·질문 |
| 제한 | `cooldown_group`, `max_per_user` | 같은 계열 카드 과다 노출 방지 (선택) |

---

## 2) 카드 조건 (Trigger) 정의

### A. 기본 단위 = token

카드는 **유저 토큰 집합(tokenSet)**에 대해 조건을 평가한다.

**토큰 예:**

- `십성:정재@월간#H`
- `관계:충@일지-년지#H`
- `신살:도화@일지`
- `확신:전체#M`

### B. trigger 의미

| 키 | 의미 |
|----|------|
| `all` | 전부 만족해야 함 (AND) |
| `any` | 하나라도 만족하면 됨 (OR). 비어 있으면 검사 생략(= 항상 통과) |
| `not` | 하나라도 만족하면 탈락 (NOT) |

---

## 3) 카드 데이터 전체 로직 요약 (End-to-End)

### Step 0. 입력

- **유저 입력:** 생년월일시 / 달력 / 타임존 등

### Step 1. 명식 계산 → items 생성 (정본)

4기둥, 일간, 지장간, 십성, 오행, 관계, 신살(선택), 강약/격국/용신(선택) 등을  
모두 `items[]`로 생성 (필요한 항목만 `w` 0~100 포함).

### Step 2. items → tokens 컴파일 (파생)

- **규칙:** `k:n`, `k:n@where`, `k:n#L/M/H`, `k:n@where#L/M/H` (+ 필요 시 `~sys`)
- **결과:** `tokens[]`
- **런타임:** `tokenSet = Set(tokens)` 생성

### Step 3. 카드 트리거 평가 (탐색)

모든 published 카드에 대해:

1. `not` 먼저 확인 → 있으면 즉시 탈락
2. `all` 확인 → 하나라도 없으면 탈락
3. `any` 확인 → 하나도 없으면 탈락 (any가 비었으면 통과)
4. 통과한 카드는 **"적용 후보"**로 수집

### Step 4. 스코어링 / 정렬 / 컷 (선택)

- **기본:** `priority`로 정렬
- **옵션:** `score.base + bonus - penalty`로 정렬
- **노출 제한:**
  - domain별 최대 N장
  - `cooldown_group` 중복 제한
  - `max_per_user` 제한

### Step 5. 응답 생성 (LLM 컨텍스트 구성)

선택된 카드들의 `content.summary` / `points` / `questions`를  
**"중복 최소화 / 길이 제한"** 규칙으로 합쳐 LLM 컨텍스트에 넣고,  
사용자 질문에 답변·추가 질문 생성.

### Step 6. 디버깅 / 설명 (옵션)

"왜 이 카드가 선택됐는지"는  
trigger에서 어떤 token이 매칭됐는지(증거 토큰)로 로그 출력 가능.

---

## 4) 운영 규칙 (간단 추천)

1. **정본은 items:** 항상 재현 가능하도록 유지.
2. **tokens는 파생 캐시:** 저장해도 되지만, items에서 결정적으로 재생성 가능해야 함.
3. **카드는 tokens 기반으로 최대한 단순하게:** 존재 / 위치 / 등급 위주.
4. **숫자(w) 직접 비교는 "특수 카드"만 허용:** 가능하면 등급 토큰으로 대체.
