# Task plan: itemNcard next steps (2026-02-01T040707)

Single task plan listing the next concrete, ordered tasks for itemNcard implementation. Ref: PRD.md, CardDataStructure.md, ChemiStructure.md, TokenRule.md, TokenStructure.md, UserInfoStructure.md. Each task is one step of appropriate size (neither too large nor too small). Do not implement code in this cycle; only create or update this plan.

---

## Current state (as of 2026-02-01)

- **Backend**: Card CRUD (GraphQL), extraction test REST endpoints (saju, pair), itemncard pipeline (pillars → items → tokens → card selection with evidence, domain/tag limits, cooldown_group, max_per_user). 연도별/월별 pillar source (歲運/月運). LLM context builder `BuildLLMContextFromCards`. AdminExtractService returns user/pair info + selected cards with evidence and score.
- **admweb**: Data Cards page with tabs (사주 카드, 궁합 카드, 사주 추출 테스트, 궁합 추출 테스트). List with filters (scope, status, category, tags, rule_set) and sort. Create/edit dialogs with full schema and trigger/score JSON validation (pair: src P|A|B). Saju extract test: mode 인생/연도별/월별, target_year/target_month, result with pillars, period, selected cards + evidence. Pair extract test: A/B birth inputs, result with A/B pillars, selected cards + evidence.
- **Remaining from PRD §2-4**: Result panels should show items/tokens 요약 and (pair) P_tokens 요약 explicitly. Optional: paging, soft delete, LLM context preview, seed templates, y2sl-local MCP.

---

## 1. Extract result: show items and tokens summary (saju)

- In admweb 사주 추출 테스트 result panel, display **items_summary** and **tokens_summary** from `user_info` (UserInfoStructure, PRD §2-4 "items/tokens 요약"). Backend already returns these; add readable UI (e.g. collapsible section or short list). Optionally show **engine_version** and **rule_set** if not already prominent.

---

## 2. Extract result: show P_tokens summary (pair)

- In admweb 궁합 추출 테스트 result panel, add a dedicated section for **P_tokens(궁합 상호작용) 요약** (PRD §2-3). Backend returns `p_tokens_summary`; render it clearly (e.g. list of tokens or chips) so operators can see which pair-interaction tokens were computed. Keep A/B pillars and selected cards sections as-is.

---

## 3. Card list: paging

- Add **paging** to Data Cards list (saju and pair tabs) so large card sets do not load in one shot. Extend GraphQL query (or list API) with `limit` and `offset` (or cursor), and add list UI controls (page size, next/prev or page numbers). Preserve existing filters and sort.

---

## 4. Card soft delete or delete

- Implement **delete** for cards per PRD §2-2 ("삭제(소프트 삭제 권장)"). Either: (a) soft delete (e.g. set `status` to `deleted`, filter list to hide deleted by default, optional filter to show deleted), or (b) hard delete with confirmation. Ensure delete action is available from list row or detail (e.g. delete button + confirm dialog). Document choice in code or docs.

---

## 5. LLM context preview (optional)

- Expose **preview** of LLM context from selected cards (CardDataStructure Step 5). Options: (a) New REST endpoint (e.g. POST `/adm/llm_context_preview`) accepting card uids or extract result payload, returning `BuildLLMContextFromCards` output; or (b) In admweb extract test result, add a "Preview context" action that calls such an endpoint with the current selected cards. Purpose: let operators verify context string before wiring into reply flow.

---

## 6. Seed data or templates (optional)

- **Document** or **UI**: how to load seed JSON from `docs/saju/itemNcard/seed/` (e.g. `saju_정재_강함.json`, `pair_궁합_충.json`) as initial data or as template in the card create form. If UI: optional "Load from seed" dropdown or file picker that fills trigger/content from seed. Keep scope small (one or two seed files as examples).

---

## 7. (Optional) y2sl-local MCP card registration

- After card CRUD and extract test are stable: add MCP tools (e.g. register_card, update_card) in y2sl-local that call the backend card API (GraphQL createItemnCard/updateItemnCard or equivalent). Document in docs/saju/itemNcard or runLoopForSaju how Cursor agent or runLoopForSaju.sh can use these tools. Implement only if the MCP server is in use.

---

## Execution result (2026-02-01)

Tasks 1–4 were implemented. Optional tasks 5–7 were not done in this cycle.

| Task | Status | What was done |
|------|--------|----------------|
| **1. Saju result: items/tokens summary** | Done | In admweb 사주 추출 테스트 result panel: added collapsible "items / tokens 요약" section showing `items_summary` (pre text) and `tokens_summary` (chips; supports string or string[]). Displayed `engine_version` next to rule_set in 유저 명식 line. |
| **2. Pair result: P_tokens summary** | Done | In admweb 궁합 추출 테스트 result panel: added "P_tokens (궁합 상호작용) 요약" section with chips for each token from `p_tokens_summary`. Rendered only when non-empty. |
| **3. Card list paging** | Done | Data Cards list (saju and pair tabs): added page state (`offset`, `pageSize` default 25). CardList shows "X개 중 from–to", page size selector (10/25/50/100), 이전/다음 buttons. GraphQL already supported limit/offset and returns total; no backend change. |
| **4. Card delete** | Done | Delete was already implemented (list row delete button). Confirmation text updated to "이 카드를 영구 삭제할까요?" (permanent delete). Backend uses **hard delete** (MongoDB DeleteOne). Documented in `api/dao/itemn_card_repository.go` (Delete) that PRD recommends soft delete; current choice is hard delete with confirmation. |
| **5. LLM context preview** | Not done | Optional; deferred. |
| **6. Seed data or templates** | Not done | Optional; deferred. |
| **7. y2sl-local MCP** | Not done | Optional; deferred. |

**Verification**

- `cd api && go test ./...` and `go build .` were run; both completed successfully (with sufficient timeout in environment).
- admweb: DataCardsPage.tsx changes only; no new backend types. Lint reported no errors. Dev server and gqlgen are in watch mode per instructions; no `npm run gqlgen` or `make gqlgen` was run.

**Remaining / next steps**

- Optional: implement task 5 (LLM context preview endpoint + admweb "Preview context" action), task 6 (seed load docs or UI), task 7 (MCP tools) when needed.
- Consider resetting list `offset` to 0 when filters or sort change (currently offset is preserved across filter changes).

---

## Reference

| Doc | Use |
|-----|-----|
| PRD.md | Scope, extraction test UX, §2-2 list/delete, §2-3 연도별/월별 and P_tokens, §2-4 visibility, success criteria |
| CardDataStructure.md | Trigger, score, cooldown_group, max_per_user, Step 4 domain/tag, Step 5 LLM context, guardrails |
| ChemiStructure.md | P_tokens, pair card schema, src P/A/B |
| TokenRule.md | items → tokens, where normalization, L/M/H |
| TokenStructure.md | Token syntax, categories |
| UserInfoStructure.md | items schema, pillars, tokens, data_version, rule_set, engine_version |
