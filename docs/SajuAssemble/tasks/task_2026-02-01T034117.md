<!-- Ordered next-step task plan for itemNcard (card CRUD UI, list filters, items/tokens depth, pair facts, saju mode, optional MCP). -->
# itemNcard – next tasks (2026-02-01T034117)

Ordered next steps for itemNcard implementation. Ref: PRD.md, CardDataStructure.md, ChemiStructure.md, TokenRule.md, TokenStructure.md, UserInfoStructure.md. Execute in order. Each task is a single, concrete step (neither too large nor too small).

---

## 1. Card create/edit UI (admweb)

- Add a create-card flow on DataCardsPage: button opens form or JSON editor; user supplies `card_id`, `scope` (saju | pair), `title`, `status`, `rule_set`, `category`, `tags`, `priority`, `trigger` (all/any/not), optional `score`, `content`, `cooldown_group`, `max_per_user`, `debug`.
- Validate required fields (card_id, title, trigger, status, scope) before submit. Call `createItemnCard` mutation; on success close and refresh list.
- Add edit flow: from list row open same form/editor pre-filled with existing card; call `updateItemnCard` on save; support toggling status (e.g. published ↔ draft) from list or form.

---

## 2. List filters and sort (admweb)

- On 사주 카드 / 궁합 카드 tabs, add filter controls: status (published/draft/all), category, tags (e.g. multi-select or comma input). Add sort: by priority (asc/desc), card_id, or updated_at.
- Wire filters and sort to `itemnCards` query (ItemNCardSearchInput: status, category, tags, orderBy, orderDirection). Ensure backend supports these if not already; then refresh list when filters/sort change.

---

## 3. Saju items: add 관계 (relations)

- In `api/service/itemncard/saju.go` (or items layer), from pillars compute relation items: 합/충/형/파/해, 천간합, 삼합 등 between pillars (TokenStructure: 관계 category; where as `일지-년지` etc. with 년→월→일→시 order per TokenRule).
- Emit items with `k: "관계"`, `n`, `where`, `w` (0–100). Ensure ItemsToTokens produces 관계 tokens (e.g. `관계:충@일지-년지#H`). No UI change; verify via saju extract test result (items/tokens summary).

---

## 4. Saju items: add 신살 and 지장간

- Add 신살 items from pillars (e.g. 도화, 역마, 천을귀인 per rule_set); schema: `k`, `n`, `where`, optional `sys` (TokenRule, TokenStructure). Emit tokens with optional `~sys` for method-dependent cases.
- Add 지장간 items per UserInfoStructure: `k: "지장간"`, `n` (hidden stem), `where` (e.g. `월지.지장간.본기/중기/여기`), `w` (per-pillar share). ItemsToTokens already supports where+#L|M|H; ensure 지장간 is included. Verify via saju extract test.

---

## 5. P_items: real pair facts (충/합/형/파/해, 천간합)

- In `api/service/itemncard/pair.go`, replace or extend P_items placeholder: from A/B pillars compute pair interaction items (ChemiStructure): 충, 합, 형, 파, 해, 천간합, 삼합 등 with `where` as `A.<pos>-B.<pos>` (A first). Use `k: "궁합"`, `n`, `where`, `w`, optional `sys`.
- Generate P_tokens from P_items (same token rules: 궁합:n[@where][#L|M|H][~sys]). Verify via pair extract test (P_tokens summary and pair card selection).

---

## 6. Saju test: 연도별/월별 mode (backend)

- Extend RunSajuExtractTest (AdminExtractService): when mode is 연도별, compute 대운·세운 (or equivalent) from birth + target year and produce items/tokens for that period; when mode is 월별, compute 월운 and items/tokens for that month. Reuse items→tokens and card trigger logic; return same shape (user_info + selected_cards) with period-specific items/tokens.
- If 대운/세운/월운 calculation is not yet in codebase, add a minimal implementation (e.g. year/month pillar derivation from sxtwl or rules) and plug into existing items/tokens pipeline.

---

## 7. Saju test UI: mode and result display

- In DataCardsPage 사주 추출 테스트 section, ensure mode selector (인생 | 연도별 | 월별) is wired to API; for 연도별 add “target year” input, for 월별 add “target year-month” (if not already). Display in result: mode and period used, plus existing user_info and selected_cards with evidence.

---

## 8. (Optional) y2sl-local MCP card tools

- Add MCP tools (e.g. register_card, update_card) that call backend card API (GraphQL createItemnCard/updateItemnCard or REST equivalent). Document in repo how runLoopForSaju.sh or Cursor agent can use these to register/update cards. Implement only if MCP server is in use and card CRUD is stable.

---

## Reference

| Doc | Use |
|-----|-----|
| PRD.md | Scope, menus, extraction test UX, success criteria |
| CardDataStructure.md | Saju card schema, trigger, score, content |
| ChemiStructure.md | P_tokens, pair card schema, src P/A/B |
| TokenRule.md | items → tokens, where normalization, L/M/H |
| TokenStructure.md | Token syntax, categories, positions |
| UserInfoStructure.md | Input, pillars, items, tokens |

---

## Execution result (2026-02-01)

**Done**

1. **Card create/edit UI (admweb)** – Implemented. DataCardsPage has a “카드 생성” button that opens `CardFormDialog` with fields: card_id, scope, title, status, rule_set, category, tags (comma), priority, trigger/score/content/debug (JSON), cooldown_group, max_per_user. Validation for card_id, title, triggerJson, status, scope before submit. Create calls `createItemnCard`; edit (from row “편집”) opens same form prefilled and calls `updateItemnCard`. Status can be toggled in the form. On success the list refetches.

2. **List filters and sort (admweb)** – Implemented. On 사주 카드 and 궁합 카드 tabs, `CardListFilters` adds: status (전체 / published / draft), category (text), tags (comma), sort by priority / card_id / updated_at, direction asc/desc. Query variables are passed to `itemnCards` (backend already supported status, category, tags, orderBy, orderDirection). List refreshes when filters/sort change.

3. **Saju items: 관계 (relations)** – Implemented in `api/service/itemncard/saju.go`. From pillars we compute: 천간합 (TG 五合), 충/합/형/해/삼합 (DZ 六冲/六合/刑/害/三合) with where normalized (년→월→일→시). Helpers: `pillarToIndices`, `tgPairHe`, `dzChong`, `dzHe`, `dzHyung`, `dzHae`, `dzSamhap`. ItemsToTokens already emits 관계 tokens (e.g. `관계:충@년지-일지#H`).

4. **Saju items: 신살 and 지장간** – Implemented in `api/service/itemncard/saju.go`. 신살: 도화 (子午卯酉), 역마 (寅申巳亥), 천을귀인 (simplified day-stem vs branch) with `sys: "common_v1"`. 지장간: 본기 only per 地支 (藏干 table), where e.g. `년지.지장간.본기`.

5. **P_items: real pair facts** – Implemented in `api/service/itemncard/pair.go`. `PItemsFromPillars` now builds 궁합 items from A/B pillars: same-position stem comparison (천간합) and branch comparison (충/합/형/해/삼합) with where `A.<pos>-B.<pos>` (A first). Reuses saju relation helpers. ItemsToTokens produces P_tokens; fallback 궁합:확신 if no pairs.

6. **Saju test: 연도별/월별 mode (backend)** – Implemented. DTO: `SajuExtractTestRequest` has `target_year`, `target_month`; `UserInfoSummary` has `mode`, `period`. `RunSajuExtractTest`: mode “연도별” uses (target_year, birth month/day/hour); mode “월별” uses (target_year, target_month, birth day/hour). Same items→tokens→trigger pipeline; response includes mode and period.

7. **Saju test UI: mode and result display** – Implemented. Saju 추출 테스트 has mode selector (인생 | 연도별 | 월별), target year input for 연도별, year+month for 월별. Result shows “모드 · 기간” and existing user_info / selected_cards with evidence.

**Status**

- Tasks 1–7: **Completed.** Backend build compiles (`go build` from `api/`); itemncard unit test added in `api/service/itemncard/saju_test.go`. Run `cd api && go test ./...` and `go build .` (or `go build -o bin/server .`) locally to confirm.
- Task 8 (Optional MCP card tools): **Not implemented** (optional; do when MCP is in use and card CRUD is stable).

**Remaining / next steps**

- Run full test suite and API build locally: `cd api && go test ./... && go build .`.
- Manually test card CRUD, filters/sort, and saju/pair extract test (including 연도별/월별) in the admin UI.
- Optionally add more 신살/지장간 rules or 大运/月运 logic per product needs.
- When ready, implement Task 8 (MCP card tools) and document usage.
