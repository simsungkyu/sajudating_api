# Task plan: 대운 (大運) 구현 (2026-02-01T155114)

Single task chosen from **the rest of docs/saju/itemNcard** (CheckList.md had no remaining incomplete items):

- **대운 (大運) 모드 구현** — 사주 추출 테스트 및 사주 추출 기본 메소드에서 kind/mode **대운**을 지원하고, 연계 만세력에 대운 기준 기간을 노출한다.

Ref: PRD.md §2-3, ExtractionAPI.md §1·§4, OperatorGuide.md, 연도별_월별_pillar.md, CardDataStructure.md, UserInfoStructure.md, Verification.md, TestScope.md, task_2026-02-01T153658, task_2026-02-01T154356.

---

## Scope (interpretation)

- **대운**: 大運 is typically derived from 月柱 and gender (연도별_월별_pillar.md). A dedicated "대운" mode requires pillar computation for the selected decade/period (sxtwl or external logic).
- **Extraction test**: `mode=대운` with target period (e.g. which 大運 step); response includes pillars, items/tokens, selected cards, and **pillar_source** for 대운 (기준 기간·날짜).
- **Saju generation**: For `kind=대운`, replace "대운 미구현" with real pillar → items → tokens → cards → LLM → result.
- **admweb**: Mode selector includes **대운**; target period input; result panel shows 연계 만세력 for 대운.

---

## Ordered tasks

### 1. Spec: Define 대운 pillar source and API contract

- **Goal**: Document how 大運 is derived and what the API accepts/returns so backend and frontend implement consistently.
- **Work**: (a) In **docs/saju/itemNcard/tasks/연도별_월별_pillar.md**: add a subsection **大運 (대운)** describing derivation (月柱 + gender; forward/backward; decade step rule per rule_set). Note whether sxtwl or an external tool (e.g. python_tool) will be used. (b) In **ExtractionAPI.md** §1: define **대운** mode — request fields (e.g. `mode=대운`, target period such as `target_daesoon_index` or `target_year` for which decade); response `user_info.mode` = `"대운"`, `user_info.period` (e.g. decade label), `pillar_source` with base_date/period/description for 대운. (c) In **ExtractionAPI.md** §4 (Saju generation): state that for `kind=대운` the service resolves 大運 pillars for the target period, then pillars → items → tokens → cards → LLM → result (remove "대운 미구현" from spec). (d) Align with **UserInfoStructure.md** (user_info fields) and **CardDataStructure.md** (Step 0–6) so 대운 fits the same items→tokens→cards flow.
- **Scope**: Docs only (연도별_월별_pillar.md, ExtractionAPI.md). No code.

---

### 2. Research: 大運 calculation method and dependency

- **Goal**: Confirm how to compute 大運 pillars (月柱, gender, step rule) and whether sxtwl or python_tool supports it.
- **Work**: (a) Check **api/python_tool/** and **sxtwl** (or repo docs) for existing 大運 support. (b) If unsupported: document the formula (e.g. 月柱 干支 → next/prev 干支 by gender; step length in years) and decide: extend python_tool, add Go logic, or integrate external service. (c) Output: short decision in 연도별_월별_pillar.md or a one-page ADR (e.g. docs/saju/itemNcard/tasks/대운_계산_방식.md) with "how we compute 大운 pillars" and target period semantics (which index or year range = which 大運).
- **Scope**: Research and doc only. No implementation yet.

---

### 3. Backend: Implement 大運 pillar computation

- **Goal**: One function that, given birth info (or 月柱) and gender and target period, returns 大運 pillars (and optional start/end period for pillar_source).
- **Work**: (a) In **api/service/itemncard/** (or **api/python_tool/** if chosen): implement **DaesoonPillars** (or equivalent) with inputs (birth Y/M/D or 月柱, gender, target step/index or year) and outputs (4 pillars for that 大運, optional period label). (b) Reuse or call sxtwl/python_tool per task 2 decision. (c) Add **unit tests** with at least one known case (e.g. fixed birth + gender → expected 大運 pillars) if reference data exists; otherwise test structure and non-panic. (d) Expose only what extraction and generation need (no new REST route).
- **Scope**: api/service/itemncard or api/python_tool, plus tests. No wiring into extraction/generation yet.

---

### 4. Backend: Wire 대운 into saju extraction test

- **Goal**: `POST /api/adm/saju_extract_test` with `mode=대운` and target period returns pillars, items/tokens, selected cards, and pillar_source for 대운.
- **Work**: (a) In **api/dto/itemncard_dto.go**: add request fields for 대운 (e.g. `target_daesoon_index` or `target_year` per spec from task 1); ensure response already supports `mode`, `period`, `pillar_source`. (b) In **api/service/AdminExtractService.go**: add case `"대운"` in mode switch: validate target period, call 大運 pillar computation from task 3, then **ItemsFromPillars** → **ItemsToTokens** → **SelectSajuCards**; set `user_info.mode`, `user_info.period`, and **pillar_source** (base_date/period/description for 대운). (c) Update **AdminExtractService_test.go**: one test for `mode=대운` with valid target, assert `user_info.mode` "대운", period, and pillar_source; one test for invalid/missing target (400 or error). (d) Update **ExtractionAPI.md** §1 if any field names changed.
- **Scope**: api/dto, api/service/AdminExtractService.go, AdminExtractService_test.go. No frontend.

---

### 5. Backend: Wire 대운 into saju generation method

- **Goal**: `runSajuGeneration` with `kind=대운` and period returns generated text instead of "대운 미구현".
- **Work**: (a) In **api/service/AdminExtractService.go** (**RunSajuGeneration**): when target kind is **대운**, resolve target period from `target.period` (e.g. year or decade index per spec). (b) Call 大運 pillar computation (task 3) to get pillars for that period. (c) Then **ItemsFromPillars** → **ItemsToTokens** → **SelectSajuCards** → **BuildLLMContextFromCards** → OpenAI with max_chars → set `target.result` to response text (or error message on failure). (d) Remove or replace the "대운 미구현" branch. (e) Add or extend **AdminExtractService_test.go**: test **RunSajuGeneration** with one target kind=대운 and valid period; assert result is non-empty or skip when OpenAI unset (structure only).
- **Scope**: api/service/AdminExtractService.go, AdminExtractService_test.go. No GraphQL schema change (same input/output).

---

### 6. admweb: Add 대운 to 사주 추출 테스트 UI

- **Goal**: User can select mode **대운** and enter target period; on run, request includes `mode=대운` and target fields; result panel shows pillars, selected cards, and 연계 만세력 for 대운.
- **Work**: (a) In 사주 추출 테스트 form (DataCardsPage or pages/datacards/): add **대운** to mode selector (인생 / 연도별 / 월별 / 일간 / **대운**). (b) When mode is **대운**, show inputs for target period per spec (e.g. 大運 step index or target year; reuse existing target year/month UI pattern if applicable). (c) On **실행**, include in request body `mode: "대운"` and the chosen target fields. (d) Result panel already shows `user_info.mode`, `user_info.period`, and `pillar_source`; ensure 대운 result shows mode "대운", period label, and 연계 만세력 block (기준 기간·날짜).
- **Scope**: admweb 사주 추출 테스트 form and API call (e.g. DataCardsPage.tsx, pages/datacards/*, itemncard_api). No backend change in this task.

---

### 7. Docs and verification

- **Goal**: OperatorGuide and Verification reflect 대운; run extraction test and saju generation with 대운; update CheckList if any item references 대운.
- **Work**: (a) In **OperatorGuide.md** §사주 추출 테스트: add **대운** to mode list; add one short bullet describing when to use 대운 and how to enter target period; state that 연계 만세력 shows 기준 기간 for 대운. Remove or update the sentence "대운은 현재 미구현(TBD)". (b) In **OperatorGuide.md** §사주 추출 기본 메소드: remove "대운은 TBD" (or replace with "대운 지원됨"). (c) In **Verification.md**: if §2 or §7 checklist mentions "인생/연도별/월별" only, add **일간** and **대운** to the flow (optional: one checklist row for 대운). (d) Run **사주 추출 테스트** with mode=대운 and **runSajuGeneration** with kind=대운; confirm result and 연계 만세력. (e) If CheckList.md has an item that said "대운은 추후", add a one-line completion note (e.g. "대운 모드 및 연계 만세력 추가 완료") after verification.
- **Scope**: OperatorGuide.md, Verification.md, CheckList.md (note only). Manual verification.

---

## Summary

| Step | Description |
|------|-------------|
| 1 | Spec: Define 대운 pillar source and API contract in 연도별_월별_pillar.md and ExtractionAPI.md |
| 2 | Research: 大運 calculation method; sxtwl/python_tool support; document in pillar doc or ADR |
| 3 | Backend: Implement 大運 pillar computation (itemncard or python_tool) + unit tests |
| 4 | Backend: Wire 대운 into saju extraction test (DTO, AdminExtractService, tests) |
| 5 | Backend: Wire 대운 into RunSajuGeneration (replace "대운 미구현"; tests) |
| 6 | admweb: Add 대운 to mode selector and target period input; show result and 연계 만세력 |
| 7 | Docs: OperatorGuide, Verification, CheckList note; manual verification |

---

## References

- **연도별_월별_pillar.md**: Current 인생/연도별/월별/일간; Future 大運.
- **ExtractionAPI.md**: §1 Saju extraction test; §4 Saju generation (대운 미구현).
- **OperatorGuide.md**: 사주 추출 테스트, 사주 추출 기본 메소드 (대운 미구현).
- **CardDataStructure.md**, **UserInfoStructure.md**: Items/tokens and user_info shape.
- **Verification.md**, **TestScope.md**: Verification and test coverage.
- **task_2026-02-01T153658**, **task_2026-02-01T154356**: 일간 + 연계 만세력; 사주 추출 기본 메소드 (next step: 대운).

---

## Execution result (2026-02-01)

**Status**: Completed.

**What was done**:
1. **Spec (Task 1)**: 연도별_월별_pillar.md — added **大運 (대운)** subsection (derivation from 月柱 + gender, 陽年/陰年 順/逆, step rule, implementation in Go `api/service/itemncard/daesoon.go`, target_daesoon_index, pillar_source). ExtractionAPI.md §1 — added 대운 mode (request target_daesoon_index, gender; response mode/period/pillar_source). §4 — 대운 semantics: resolve 大運 pillars from user_input + target.period (step index), then pillars → items → tokens → cards → LLM → result; user_input.gender required.
2. **Research (Task 2)**: Documented in 연도별_월별_pillar.md; sxtwl has no 大運 support; computation in Go (PillarsFromBirth for 月柱, then 干支 shift by step and gender).
3. **Backend DaesoonPillars (Task 3)**: Implemented `api/service/itemncard/daesoon.go` — `DaesoonPillars(birthY, birthM, birthD, hh, mm, timezone, gender, stepIndex)` returns 4 pillars (年/月 from 月柱 shifted, 日/时 from birth) and period label "대운 N". Unit tests in `daesoon_test.go` (isMale, structure, step 1).
4. **Backend extraction test (Task 4)**: DTO — added `TargetDaesoonIndex`, clarified `Gender`. AdminExtractService — case "대운": validate target_daesoon_index and gender, call DaesoonPillars, then ItemsFromPillars → tokens → SelectSajuCards; set pillar_source (description "大運"). Tests: TestRunSajuExtractTest_DaesoonModeMissingTarget (400), TestRunSajuExtractTest_DaesoonModeValid (mode/period/pillar_source).
5. **Backend RunSajuGeneration (Task 5)**: Removed "대운 미구현"; for kind "대운" resolve step from period, require user_input.gender, call DaesoonPillars → items → tokens → cards → BuildLLMContextFromCards → OpenAI; set target.result. Tests: TestRunSajuGeneration_DaesoonMissingGender, TestRunSajuGeneration_DaesoonWithGender.
6. **admweb (Task 6)**: SajuExtractTestTab — mode selector includes **대운**; when 대운, show **대운 단계 (0부터)** and **성별** (남/여); request includes `target_daesoon_index` and `gender`. Result panel already shows mode, period, pillar_source (연계 만세력).
7. **Docs (Task 7)**: OperatorGuide — 대운 in mode list and 연도별·월별·일간·대운 상세; 사주 추출 기본 메소드 "대운 지원됨". Verification — §2 and 사주 추출 흐름에 일간·대운 추가 (대운 모드 체크리스트). CheckList — items that said "대운은 추후" updated with completion note (task_2026-02-01T155114).

**Verification**: `cd api && go test ./types/itemncard/... ./service/itemncard/... ./service/... ./mcplocal/... -count=1` and `go build .` succeeded.

**Remaining / next steps**: Manual verification: run 사주 추출 테스트 with mode=대운 and runSajuGeneration with kind=대운; confirm result and 연계 만세력 in UI. Optional: GraphQL SajuGeneration input could expose `user_input.gender` if not already present for 대운.
