<!-- Ordered task plan for itemNcard next steps; ref PRD, CardDataStructure, ChemiStructure, TokenRule, TokenStructure, UserInfoStructure. -->
# Task plan: itemNcard next steps (2026-02-01T072916)

Ordered concrete tasks for itemNcard implementation. Ref: PRD.md, CardDataStructure.md, ChemiStructure.md, TokenRule.md, TokenStructure.md, UserInfoStructure.md.

---

## Current state (as of 2026-02-01)

- **Backend**: Card CRUD (GraphQL), soft delete; extraction REST (saju: 인생/연도별/월별, pair); itemncard pipeline (pillars → items → tokens → card selection with evidence per CardDataStructure/ChemiStructure); LLM context builder and `POST /api/adm/llm_context_preview`; y2sl-local MCP (register_card, update_card, list_cards). Seed structure validation in `api/types/itemncard/`.
- **admweb**: Data Cards page with tabs (사주 카드, 궁합 카드, 사주 추출 테스트, 궁합 추출 테스트); list/filter/sort/paging; create/edit with trigger/score JSON validation (pair: src P|A|B); PillarDisplay (양=볼드, 오행=컬러); A/B 명식 요약; selected cards + evidence; LLM 요청 전체 내용 textarea (saju/pair); 시드에서 불러오기, 일괄 등록.
- **Docs**: ExtractionAPI.md, Seed.md, OperatorGuide.md, Verification.md, TestScope.md, run_verification.sh.
- **Pending**: PRD §7 checklist (1)–(5) manual verification and Verification.md history; full-flow verification and history; seed-folder linkage confirmation; optional: LLM preview E2E, MCP E2E·runLoopForSaju.sh, PRD §6 final check.

---

## Ordered next tasks

### 1. Run PRD §7 checklist (1)–(5) and record in Verification.md

- **Goal**: Confirm that PRD §7 additional requirements (5 items) work as implemented and record results in Verification.md.
- **Work**: Run Verification.md **§7 checklist** in order: (1) 사주 추출 결과화면 — 원국 음양 볼드·오행 컬러 표시, (2) 궁합 추출 결과화면 — A/B 명식 분석 정보 요약, (3) seed 폴더 참조·시드에서 불러오기·일괄 등록, (4) 사주 추출 — LLM 요청 전체 내용 textarea, (5) 궁합 추출 — LLM 요청 전체 내용 textarea. For each item note pass/fail and any finding (one-line). Add one row (or one row per item) to Verification.md **검증 이력** with item-level results.
- **Scope**: Manual check + Verification.md update; no code change.

---

### 2. Full-flow check (saju 인생/연도별/월별, pair) and record in Verification.md

- **Goal**: Confirm end-to-end flow for saju and pair extraction test and record in Verification.md.
- **Work**: Follow Verification.md **전체 흐름 점검**: (1) 사주 추출 인생 모드 → result panel (원국·items/tokens·selected cards·evidence·LLM textarea), (2) 사주 연도별 mode same check, (3) 사주 월별 mode same check, (4) pair 추출 A/B input → result panel (A/B 명식·P_tokens·selected cards·evidence·LLM textarea). Note any issue (one-line). Add full-flow result (saju 인생·연도별·월별·pair) to Verification.md 검증 이력.
- **Scope**: Manual check + Verification.md update; no code change.

---

### 3. Confirm seed-folder linkage and document in Verification.md

- **Goal**: Confirm that JSON files in seed folder are used in extraction (cards appear in pool and can be selected).
- **Work**: Align Seed.md "Seed 파일 참조 현황" with `docs/saju/itemNcard/seed/` list. In admweb use "시드에서 불러오기" to load one or more seeds (e.g. saju_정재_강함, pair_궁합_충), bulk-register, then run extraction test with birth data (or A/B pair) that satisfies those triggers. Confirm selected cards include the seeded cards. If not: document cause in one line (e.g. card not registered, trigger mismatch, token rules). If yes: add "seed 연동 확인 완료" to Verification.md 검증 이력.
- **Scope**: Manual check + one doc row or one-line issue; no code change unless a separate fix task is created.

---

### 4. Fix one verification finding (conditional)

- **Goal**: If tasks 1–2 recorded one or more issues, fix the single highest-priority one.
- **Work**: From verification history pick **one** issue (e.g. PillarDisplay 양/오행, A/B summary layout, evidence display, LLM textarea expand/copy, seed options). Implement the fix. If no issues or already tracked elsewhere, mark this task "해당 없음" and skip.
- **Scope**: One fix only.

---

### 5. Run local automated verification and update Verification.md

- **Goal**: Ensure itemNcard tests and build pass from repo root and reflect in Verification.md.
- **Work**: From repo root run `cd api && make test-itemncard && go build .` (or `bash docs/saju/itemNcard/run_verification.sh`). If pass: verify Verification.md 검증 이력 has this run (date, result, note); if missing add one row. If fail: fix one cause or record issue, then re-run.
- **Scope**: Command run + Verification.md check or one row; optional one fix.

---

### 6. (Optional) LLM context preview E2E and docs

- **Goal**: Manually confirm admweb LLM context preview shows result in UI; ensure procedure is documented.
- **Work**: In Data Cards run saju or pair extraction test, then trigger LLM context preview. Confirm `POST /api/adm/llm_context_preview` is called and response is shown. If OperatorGuide or Verification.md lacks this procedure, add 1–2 paragraphs. If problem found, fix one or record issue.
- **Scope**: Manual check + doc or one fix if needed.

---

### 7. (Optional) y2sl-local MCP E2E and runLoopForSaju.sh docs

- **Goal**: Confirm Verification.md §3 "y2sl-local MCP로 카드 등록 가능 및 runLoopForSaju.sh 연동" is checkable and documented.
- **Work**: Start API with `LOCAL_MCP=true`. From MCP client call `register_card` for one card; confirm card appears in admweb Data Cards list. Compare runLoopForSaju.sh and OperatorGuide §MCP to ensure steps are documented. If not implemented, skip check. If docs missing, add 1–2 paragraphs to OperatorGuide or runLoopForSaju.sh.
- **Scope**: Manual check + doc update if needed.

---

### 8. (Optional) PRD §6 success criteria final check and history

- **Goal**: Confirm PRD §6 three success criteria are reflected in verification history.
- **Work**: Compare Verification.md checklist §1 (list·register·manage), §2 (extraction test result·selection evidence), §3 (optional MCP) with PRD §6. If each was checked at least once and recorded, mark "완료". If any missing, run that check once and add row to Verification.md.
- **Scope**: Doc comparison + one-time check and one row if needed.

---

## Reference

| Doc | Use |
|-----|-----|
| PRD.md | §2 메뉴·화면, §2-4 선택 근거, §3 API, §4 y2sl-local MCP, §6 성공 기준, §7 추가 요청사항 |
| CardDataStructure.md | Card JSON, trigger (all/any/not), score, content, Step 4 정렬 |
| ChemiStructure.md | P_tokens, pair card schema, src P\|A\|B |
| TokenRule.md | items → tokens, where 정규화, L/M/H |
| TokenStructure.md | Token 문법, 카테고리, 위치 표준 |
| UserInfoStructure.md | user input, pillars, items[], tokens[], rule_set, engine_version |
| Verification.md | §6·§7 체크리스트, 전체 흐름 점검, 검증 이력, run_verification.sh |
| Seed.md | Seed 파일 참조, 시드에서 불러오기, 일괄 등록 |
| TestScope.md | Go 테스트 위치, make test-itemncard, 흐름·테스트 범위 |
| ExtractionAPI.md | REST (saju_extract_test, pair_extract_test, llm_context_preview) |

---

## Notes

- Tasks 1–3: manual verification + Verification.md 검증 이력.
- Task 4: only if an issue was recorded in 1–2; otherwise skip.
- Task 5: recommended before release; run from repo root.
- Tasks 6–8: optional; do when resources allow.
- All commands and checks are from repo root unless stated otherwise.

---

## Execution result (2026-02-01)

**Done**

- **Task 5**: Ran local automated verification from repo root: `bash docs/saju/itemNcard/run_verification.sh`. Result: **통과**. `make test-itemncard` passed (types/itemncard, service/itemncard, service, mcplocal); `go build .` succeeded. Added one row to Verification.md 검증 이력: `| 2026-02-01 | (task 실행) | 통과 | task_2026-02-01T072916: run_verification.sh 실행. make test-itemncard + go build 성공. ... §7·전체 흐름 수동 점검 대기. |`

**Status**

- **Task 1**: Not executed (manual). PRD §7 checklist (1)–(5) requires verification 담당자 to run admweb checks and record item-level results in Verification.md.
- **Task 2**: Not executed (manual). Full-flow check (saju 인생/연도별/월별, pair) requires manual run and one row in Verification.md.
- **Task 3**: Not executed (manual). Seed-folder linkage confirmation requires manual check and doc row.
- **Task 4**: 해당 없음. No issues recorded from Tasks 1–2 (manual not run); skip.
- **Task 5**: 완료.
- **Tasks 6–8**: Optional; not run.

**Remaining / next steps**

1. 검증 담당자: Run Tasks 1–3 (PRD §7 checklist, full-flow, seed linkage); record results in Verification.md 검증 이력.
2. If any issue is found in 1–2, address in a follow-up (Task 4 style) or new task.
3. Optionally run Tasks 6–8 (LLM preview E2E, MCP E2E·runLoopForSaju.sh, PRD §6 final check) when resources allow.
