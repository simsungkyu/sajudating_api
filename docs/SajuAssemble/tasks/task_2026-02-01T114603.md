# Task plan: 궁합 추출 결과 — LLM 요청 전체 내용 textarea (2026-02-01T114603)

Ordered concrete tasks for **CheckList.md** second remaining item:  
**궁합 추출 테스트의 결과화면에, 종합하여 llm에 요청되어야 하는 전체 내용에 대해 textarea 내에 표시하도록 해줘.**

Ref: PRD.md, CardDataStructure.md, ChemiStructure.md, TokenRule.md, UserInfoStructure.md, ExtractionAPI.md, Verification.md.  
Reference implementation: 사주 추출 테스트의 동일 기능(task_2026-02-01T114120) — 응답에 `llm_context` 포함 + 결과 수신 시 textarea 자동 채우기.

---

## Current state (reference)

- **admweb**: 궁합 추출 테스트 결과 패널에 "LLM 요청 전체 내용" 접기/펼치기 섹션과 read-only textarea, "불러오기" 버튼이 있음. 사용자가 **불러오기**를 눌러야 `POST /api/adm/llm_context_preview`(scope `pair`)로 카드 컨텍스트를 가져와 textarea에 채움.
- **Backend**: `pair_extract_test`는 `summary_a`, `summary_b`, `p_tokens_summary`, `selected_cards`만 반환. `llm_context` 필드 없음. LLM 컨텍스트는 별도 `llm_context_preview`(card_ids + scope `pair`)로만 조회 가능.
- **CheckList**: 위 항목이 미완료이므로, 궁합 추출 결과 화면에서 **종합된 LLM 요청 전체 내용**이 textarea에 **표시**되도록(추가 클릭 없이 또는 불러오기로) 하는 구체 작업이 필요.

---

## Ordered next tasks

### 1. Backend: 궁합 추출 응답에 `llm_context` 필드 추가

- **목표**: 사주 추출과 동일하게, 궁합 추출 응답에 선택 카드 기반 조립 LLM 컨텍스트를 포함하여, 결과 수신 시 한 번에 textarea를 채울 수 있게 한다.
- **작업**:
  - `api/dto/itemncard_dto.go`: `PairExtractTestResponse`에 `LLMContext string` (`json:"llm_context,omitempty"`) 추가. 주석: "Assembled LLM context from selected pair cards when len(SelectedCards) > 0".
  - `api/service/AdminExtractService.go`: `RunPairExtractTest`에서 `resp` 조립 직후, `len(selected) > 0`일 때 `resp.LLMContext = itemncard.BuildLLMContextFromCards(selected, defaultLLMContextMaxChars)` 호출하여 설정. (선택 카드는 이미 `[]entity.ItemNCard`이므로 사주와 동일한 함수 사용.)
- **범위**: DTO·RunPairExtractTest만. 다른 엔드포인트/파일 변경 없음.

---

### 2. API 문서: Pair 추출 응답에 `llm_context` 설명 추가

- **목표**: ExtractionAPI.md §2 Pair extraction test Response에 `llm_context` 필드를 문서화하여 프론트/운영자가 동작을 이해할 수 있게 한다.
- **작업**:
  - `docs/saju/itemNcard/ExtractionAPI.md` §2 Response body 테이블에 행 추가: `llm_context` | string | Optional. Assembled LLM context from selected pair cards (same as §3 LLM context preview). Present when `selected_cards.length > 0`.
  - 필요 시 §2 아래에 1문장: "궁합 추출 시 LLM에 전달할 전체 내용(카드 컨텍스트)은 사주와 동일하게 선택된 카드의 content 조립이며, 결과 화면의 textarea에는 이 값을 표시한다."
- **범위**: ExtractionAPI.md만.

---

### 3. Frontend: 궁합 추출 결과 수신 시 textarea 자동 채우기

- **목표**: 궁합 추출 테스트 실행 후 결과가 있고 `selected_cards.length > 0`이면, "LLM 요청 전체 내용" textarea를 사용자 클릭 없이 채우고 섹션을 펼친다.
- **작업**:
  - `admweb/src/api/itemncard_api.ts`: `PairExtractTestResponse` 타입에 `llm_context?: string` 추가.
  - `admweb/src/pages/DataCardsPage.tsx`의 궁합 추출 탭(`PairExtractTestTab` 등)에서 `handleRun` 성공 후 `setResult(res)` 직후:
    - `res.selected_cards?.length`가 있으면:  
      - `res.llm_context`가 있으면 그 값으로 `llmTextareaContent` 설정, "LLM 요청 전체 내용" 섹션 펼침(`setLlmTextareaOpen(true)`), `setLlmTextareaErr(null)`.  
      - 없으면(구 API 대비) `llmTextareaOpen(true)`, `llmTextareaErr(null)`, `llmTextareaContent('')`, `llmTextareaLoading(true)` 후 `llmContextPreview({ card_ids: res.selected_cards.map(c => c.card_id), scope: 'pair' })` 호출; then으로 `setLlmTextareaContent(preview.context)`, catch로 `setLlmTextareaErr`, finally로 `setLlmTextareaLoading(false)`.
    - `selected_cards.length === 0`이면 기존처럼 textarea 관련 상태만 초기화(또는 유지); 섹션 접힌 상태에서 "선택된 카드가 없어 LLM 요청 내용이 없습니다." 메시지 유지.
  - 기존 "불러오기" 버튼은 유지(재불러오기용). 로딩 중에는 "불러오기" 옆에 `CircularProgress` 표시(사주 탭과 동일).
- **범위**: DataCardsPage.tsx 내 궁합 추출 탭 + itemncard_api.ts 타입만. 사주 탭/다른 페이지 변경 없음.

---

### 4. 검증 및 체크리스트 반영

- **목표**: 궁합 추출 결과 화면에서 LLM 요청 전체 내용이 textarea에 표시되는지 확인하고, CheckList/Verification에 반영한다.
- **작업**:
  - 데이터 카드 → 궁합 추출 테스트에서 실행 후, 결과 패널의 "LLM 요청 전체 내용" 섹션에 **추가 클릭 없이** textarea가 채워지는지 확인(선택 카드가 있을 때). 선택 카드가 없을 때 안내 문구만 나오는지 확인.
  - `docs/saju/itemNcard/CheckList.md`: 두 번째 미완료 항목 "궁합 추출 테스트의 결과화면에 … textarea …" 를 `- [x]`로 변경.
  - (선택) Verification.md에 궁합 추출 테스트 — LLM 요청 전체 내용 textarea 항목이 있으면 "결과 표시 시(또는 불러오기 시) textarea에 전체 내용 표시" 등으로 정리하고, 검증 이력에 본 task ID와 결과(통과/이슈 1줄) 추가.
- **범위**: 수동 확인 + CheckList.md 수정. Verification.md는 기존 구조에 맞게 최소 수정.

---

## Reference

| Doc | Use |
|-----|-----|
| PRD.md | §2-3 추출 테스트 UI, §2-4 테스트 결과 가시성 |
| CheckList.md | 두 번째 미완료 항목(궁합 추출 결과 — LLM 요청 전체 내용 textarea) |
| ExtractionAPI.md | §2 Pair extraction test, §3 LLM context preview |
| ChemiStructure.md | 궁합 카드 스키마, content → LLM 컨텍스트 |
| CardDataStructure.md | 카드 content → LLM 컨텍스트 조립 |
| task_2026-02-01T114120 | 사주 추출 동일 기능 구현 참조(Backend llm_context + Frontend 자동 채우기) |

---

## Notes

- "종합하여 llm에 요청되어야 하는 전체 내용"은 사주와 동일하게 **카드 컨텍스트**(선택된 궁합 카드의 content 조립)만 textarea에 표시. A/B 명식 요약은 별도 summary_a/summary_b로 전달되며, 필요 시 운영자가 명식 요약과 이어붙여 사용 가능(ExtractionAPI.md §1 노트와 동일 정책).
- Backend의 `BuildLLMContextFromCards`는 scope 무관하게 카드 entity의 content를 조립하므로, pair 선택 카드에 그대로 사용 가능.
- 본 task plan은 작성만 수행하며, 코드 구현은 별도 단계에서 수행한다. 실행 시 repo root 기준.

---

## Execution result (2026-02-01)

**Status**: Done.

**What was done**:
1. **Backend**: `api/dto/itemncard_dto.go` — `PairExtractTestResponse`에 `LLMContext string` (`json:"llm_context,omitempty"`) 추가. `api/service/AdminExtractService.go` — `RunPairExtractTest`에서 `resp` 조립 직후 `len(selected) > 0`일 때 `resp.LLMContext = itemncard.BuildLLMContextFromCards(selected, defaultLLMContextMaxChars)` 설정.
2. **API 문서**: `docs/saju/itemNcard/ExtractionAPI.md` §2 Response body에 `llm_context` 행 및 궁합 추출 시 textarea 표시 설명 문장 추가.
3. **Frontend**: `admweb/src/api/itemncard_api.ts` — `PairExtractTestResponse`에 `llm_context?: string` 추가. `admweb/src/pages/DataCardsPage.tsx` — 궁합 추출 탭 `handleRun` 성공 후 `res.selected_cards?.length`가 있으면 `res.llm_context`가 있으면 그 값으로 textarea 채우고 섹션 펼침, 없으면 `llmContextPreview`(scope `pair`) 호출로 fallback; "불러오기" 옆에 `CircularProgress` 표시 추가.
4. **CheckList**: 두 번째 항목(궁합 추출 결과 — LLM 요청 전체 내용 textarea)을 `- [x]`로 변경.

**Verification**: Run from repo root: `cd api && go test ./...` and `go build .` to confirm tests and build pass. Manually: 데이터 카드 → 궁합 추출 테스트 실행 후, 선택 카드가 있으면 "LLM 요청 전체 내용" 섹션이 펼쳐지고 textarea가 추가 클릭 없이 채워지는지 확인.

**Remaining / next steps**: None. CheckList 두 번째 항목 완료.
