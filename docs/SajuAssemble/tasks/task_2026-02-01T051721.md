<!-- itemNcard next-step task plan; ref PRD and itemNcard structure docs (CardDataStructure, ChemiStructure, TokenRule, etc). -->
# Task plan: itemNcard next steps (2026-02-01T051721)

Ordered task plan for itemNcard implementation. Ref: PRD.md, CardDataStructure, ChemiStructure, TokenRule, TokenStructure, UserInfoStructure. Only create/update this plan; do not implement code yet.

---

## Current state (as of 2026-02-01)

- **Backend**: Card CRUD (GraphQL), soft delete, extraction REST (saju: 인생/연도별/월별, pair). itemncard pipeline: pillars → items → tokens → card selection with evidence; domain/tag limits, cooldown_group, max_per_user. LLM context builder and POST `/api/adm/llm_context_preview`. AdminExtractService returns user/pair info + selected cards with evidence and score. y2sl-local MCP: `register_card`, `update_card`, `list_cards` in mcplocal/cardtools.go.
- **admweb**: Data Cards page with tabs (사주 카드, 궁합 카드, 사주 추출 테스트, 궁합 추출 테스트). List with filters, sort, paging; create/edit with full schema and trigger/score JSON validation (pair: src P|A|B). Soft delete, 복제, JSON 내보내기, 시드에서 불러오기 (9 options), 일괄 등록. Extract result: items/tokens summary, PillarDisplay (양=볼드, 오행=컬러), A/B 명식 요약, selected cards + expandable evidence; LLM 요청 전체 내용 textarea (saju/pair); copy-to-clipboard; LLM 컨텍스트 미리보기.
- **Docs**: ExtractionAPI.md, Seed.md (9 시드 옵션, 미참조 파일 정리), OperatorGuide.md, Verification.md (§6·§7 체크리스트, 전체 흐름 점검, 검증 이력·항목별 템플릿), TestScope.md (연도별/월별·동점 정렬 테스트 반영), 연도별_월별_pillar.md, run_verification.sh.
- **Pending**: 검증 담당자에 의한 §7 (1)~(5) 및 전체 흐름(사주 인생/연도별/월별, 궁합) 수동 점검 1회 및 검증 이력 기록.

---

## Ordered next tasks

### 1. 검증 담당자 §7·전체 흐름 수동 점검 및 이력 기록

- **목표**: PRD §6 성공 기준 및 §7 (1)~(5) 검증 완료 상태를 검증 이력에 기록.
- **작업**: 검증 담당자가 Verification.md **§7 체크리스트** 5항목(원국 표시·A/B 명식·seed 참조·사주 LLM textarea·궁합 LLM textarea)과 **전체 흐름 점검**(사주 인생/연도별/월별, 궁합)을 1회 수행한 뒤, Verification.md **검증 이력** 테이블에 항목별 템플릿으로 통과/미통과와 날짜·검증자 기록. 발견 이슈가 있으면 별도 행으로 요약.
- **범위**: 문서만 갱신; 코드 변경 없음.

---

### 2. §7·전체 흐름 검증 중 발견 이슈 수정 (조건부)

- **목표**: Task 1 수행 중 발견된 이슈가 1건 이상 있을 때, 우선순위 높은 1건만 수정.
- **작업**: 검증 이력 또는 별도 기록에 정리된 이슈(표시 오류, 누락, 버그) 중 **1건**을 골라 구체적으로 수정(예: PillarDisplay·A/B 요약·evidence·textarea 표시). 이슈가 없거나 이미 별도 태스크로 정리된 경우 이 태스크는 "해당 없음"으로 생략.
- **범위**: 1건 수정에 그침.

---

### 3. PRD §7 (6) 흐름·테스트 범위 최종 점검

- **목표**: PRD §7 (6) "전체적인 흐름에 이상한점은 없는지, 테스트는 적당한 로직과 범위로 수행되고 있는지 확인" 충족.
- **작업**: TestScope.md·Verification.md·실제 코드(api/service/itemncard, AdminExtractService, mcplocal)를 대조하여 **흐름**(입력→pillars→items→tokens→카드 선택→결과 반환)과 **테스트 범위**(Go 테스트 위치·커버 범위·수동 검증 항목)가 일치하는지 확인. 불일치 또는 누락 1~2건이 있으면 해당 문서에만 최소 보강(한두 문단 또는 표 한 행).
- **범위**: 점검 + 문서 최소 수정; 대규모 개편 없음.

---

### 4. run_verification.sh 사용법 문서화 (미완 시)

- **목표**: 검증 수행 시 run_verification.sh 실행 방법을 한곳에 명시.
- **작업**: Verification.md "백엔드·빌드 검증" 또는 "검증 이력" 근처에 **run_verification.sh** 섹션이 없거나 불완전하면 추가·보강: 실행 위치(repo root), 실행 명령(`./docs/saju/itemNcard/run_verification.sh` 또는 `bash docs/saju/itemNcard/run_verification.sh`), 목적(make test-itemncard + go build 수행, 검증 이력용 마크다운 한 줄 출력), 출력 해석 한두 문장.
- **범위**: 문서만 갱신. 이미 완료되어 있으면 "해당 없음"으로 생략.

---

### 5. Seed 폴더·Seed.md 최종 대조

- **목표**: seed 폴더 내 파일과 Seed.md "Seed 파일 참조 현황"·미참조 목록이 최신 상태인지 유지.
- **작업**: `docs/saju/itemNcard/seed/` 디렉터리 목록과 Seed.md의 9개 시드 옵션·미참조 파일 표를 대조. 파일 추가/삭제로 인한 불일치가 있으면 Seed.md 표를 한두 행 갱신. 일괄 등록으로 나머지 시드 파일을 불러올 수 있다는 설명이 Verification §7 (3) 체크에 부합하는지 문구만 필요 시 보강.
- **범위**: 문서만; 코드 변경 없음.

---

### 6. 릴리스 전 확인 항목 정리 (미완 시)

- **목표**: PRD §6·§7 충족 후 릴리스 전에 확인할 항목을 한곳에 정리.
- **작업**: Verification.md 또는 TestScope.md에 **릴리스 전 확인** 섹션이 없으면 추가(또는 기존 "백엔드·빌드 검증" 확장): (1) `cd api && make test-itemncard` 통과, (2) `cd api && go build .` 성공, (3) admweb `npm run build` 성공(선택), (4) 검증 이력에 §7·전체 흐름 1회 기록 완료, (5) (선택) MCP 카드 등록·admweb 목록 확인. 3~5줄 요약으로 정리.
- **범위**: 문서만 갱신. 이미 완료되어 있으면 "해당 없음"으로 생략.

---

### 7. (선택) y2sl-local MCP runLoopForSaju.sh 연동 문서화

- **목표**: PRD §4 "y2sl-local MCP 연동" — runLoopForSaju.sh 등에서 agent가 MCP를 사용한 카드 등록/갱신 절차를 문서화.
- **작업**: OperatorGuide.md 또는 runLoopForSaju.sh 주석/README에 MCP 도구(`register_card`, `update_card`, `list_cards`) 호출 방법과 카드 JSON 전달 방식(시드 파일 또는 에이전트 생성 JSON)을 3~5줄로 정리. API 서버 `LOCAL_MCP=true` 전제 명시.
- **범위**: 문서만; 스크립트 동작 변경은 선택.

---

### 8. (선택) LLM 컨텍스트 미리보기 E2E 확인

- **목표**: admweb에서 "LLM 컨텍스트 미리보기" 호출 후 대화상자에 결과가 표시되는지 E2E 확인.
- **작업**: 데이터 카드 → 사주 또는 궁합 추출 테스트 실행 후, LLM 컨텍스트 미리보기 버튼/액션으로 `POST /api/adm/llm_context_preview` 호출이 이루어지고, 응답이 UI에 표시되는지 수동 확인. 문제가 있으면 1건 수정 또는 이슈 기록.
- **범위**: 수동 확인 + 필요 시 1건 수정.

---

## Execution result (2026-02-01)

**Run**: repo root → `bash docs/saju/itemNcard/run_verification.sh`. **Result**: 통과 (make test-itemncard + go build 성공).

| Task | Status | What was done |
|------|--------|----------------|
| 1. 검증 담당자 §7·전체 흐름 수동 점검 및 이력 기록 | **대기** | 문서만 갱신; 검증 담당자 1회 수동 수행 후 Verification.md 검증 이력 테이블에 기록 필요. 코드 변경 없음. |
| 2. §7·전체 흐름 검증 중 발견 이슈 수정 | **해당 없음** | Task 1 미수행으로 발견 이슈 없음; Task 1 완료 후 필요 시 1건 수정. |
| 3. PRD §7 (6) 흐름·테스트 범위 최종 점검 | **완료** | TestScope.md·Verification.md·코드(api/service/itemncard, AdminExtractService, mcplocal) 대조 완료. TestScope.md "흐름·테스트 범위 대조"에 AdminExtractService→itemncard 패키지 호출 문장 1줄 보강. |
| 4. run_verification.sh 사용법 문서화 | **해당 없음** | Verification.md "백엔드·빌드 검증" 아래 run_verification.sh 섹션 이미 있음(실행 위치, 명령, 목적, 출력 해석). |
| 5. Seed 폴더·Seed.md 최종 대조 | **완료** | seed/ 디렉터리와 Seed.md 미참조 표 대조. Seed.md 표 갱신: 격국에 saju_격국_편인격.json 추가; 관계에 saju_관계_삼합.json, saju_관계_천간합.json 추가; 십성에 saju_정재_약함.json, saju_편재_강함.json 추가. |
| 6. 릴리스 전 확인 항목 정리 | **해당 없음** | Verification.md에 "릴리스 전 확인" 섹션 이미 있음(1~5항목). |
| 7. (선택) y2sl-local MCP runLoopForSaju.sh 연동 문서화 | **해당 없음** | runLoopForSaju.sh 상단 주석에 MCP 도구·카드 JSON 전달·OperatorGuide §MCP 연동 참조 있음; OperatorGuide.md "MCP 연동"에 사용 안내 있음. |
| 8. (선택) LLM 컨텍스트 미리보기 E2E 확인 | **보류** | 수동 확인; 필요 시 검증 담당자 또는 별도 세션에서 수행. |

**Tests & build**: `bash docs/saju/itemNcard/run_verification.sh` 실행 → make test-itemncard (itemncard, service, mcplocal 패키지) 및 go build . 통과.

**Remaining / next steps**:
- Task 1: 검증 담당자가 §7 (1)~(5) 및 전체 흐름(사주 인생/연도별/월별, 궁합) 1회 수동 점검 후 Verification.md 검증 이력에 기록.
- Task 2: Task 1에서 이슈 발견 시 1건 수정.
- Task 8 (선택): LLM 컨텍스트 미리보기 E2E 수동 확인.

---

## Reference

| Doc | Use |
|-----|-----|
| PRD.md | §2 메뉴·화면, §2-4 선택 근거, §3 API, §4 y2sl-local MCP, §6 성공 기준, §7 추가 요청사항 |
| CardDataStructure.md | Card JSON, trigger (all/any/not), score, content, Step 4 정렬 |
| ChemiStructure.md | P_tokens, pair card schema, src P\|A\|B |
| TokenRule.md | items → tokens, where 정규화, L/M/H |
| TokenStructure.md | Token 문법, 카테고리, 위치 표준 |
| UserInfoStructure.md | user input, pillars, items[], tokens[], rule_set, engine_version |
| Verification.md | §6·§7 체크리스트, 전체 흐름 점검, 검증 이력 |
| TestScope.md | Go 테스트 위치, 커버 범위, 수동 검증 |
| Seed.md | Seed 파일 참조 현황, 시드에서 불러오기 옵션, 일괄 등록 |

---

## Notes

- Task 1: 검증 담당자 1회 수동 점검 후 Verification.md 이력 기록.
- Task 2: 발견 이슈 있을 때만 1건 수정; 없으면 생략.
- Task 3: PRD §7 (6) 흐름·테스트 범위 점검 및 문서 최소 보강.
- Task 4·6: 이전 계획에서 완료된 항목이면 "해당 없음"으로 생략.
- Task 5: seed 폴더·Seed.md 표 대조 및 필요 시 한두 행 갱신.
- Task 7·8: 선택 항목; 리소스 허용 시 수행.
- 모든 명령은 repo root 기준; 백엔드 검증은 `cd api && make test-itemncard` 등으로 수행.
