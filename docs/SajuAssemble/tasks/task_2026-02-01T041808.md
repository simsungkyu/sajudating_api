# Task plan: itemNcard next steps (2026-02-01T041808)

Single task plan listing the next concrete, ordered tasks for itemNcard implementation. Ref: PRD.md, CardDataStructure.md, ChemiStructure.md, TokenRule.md, TokenStructure.md, UserInfoStructure.md. Each task is one step of appropriate size. Do not implement code in this cycle; only create or update this plan.

---

## Current state (as of 2026-02-01)

- **Backend**: Card CRUD (GraphQL), extraction test REST (saju, pair), itemncard pipeline (pillars → items → tokens → card selection with evidence, domain/tag limits, cooldown_group, max_per_user). 연도별/월별 pillar. LLM context builder and POST `/api/adm/llm_context_preview`. AdminExtractService returns user/pair info + selected cards with evidence and score.
- **admweb**: Data Cards page with tabs (사주 카드, 궁합 카드, 사주 추출 테스트, 궁합 추출 테스트). List with filters (scope, status, category, tags, rule_set), sort, paging; offset resets when filters/sort change. Create/edit dialogs with full schema and trigger/score JSON validation (pair: src P|A|B). **Hard delete** with confirmation. Extract result panels show items/tokens summary, pillars, selected cards + evidence; LLM 컨텍스트 미리보기 button when cards are selected.

---

## Ordered next tasks

### 1. Soft delete for data cards (PRD §2-2 권장)

- **Backend**: Add soft-delete support so “delete” does not remove the document.
  - Add `deleted_at` (int64, 0 = not deleted) to `ItemNCard` entity and collection.
  - Update delete mutation (or repository `Delete`) to set `deleted_at` to current time instead of removing the document.
  - List query: by default exclude cards where `deleted_at > 0`. Add optional filter (e.g. `include_deleted: Boolean`) to include them for admin recovery.
  - Card selection (extract pipeline) must continue to ignore soft-deleted cards (only `status` published and `deleted_at == 0`).
- **admweb**: No change to delete button behavior (still calls same mutation). List does not show deleted cards unless an “Include deleted” (or similar) filter is added. Optional: add filter checkbox and show a “deleted” badge when displaying deleted rows.

---

### 2. Seed data: document or UI (optional, pick one)

- **Option A (documentation)**: Add a short section under `docs/saju/itemNcard/` (e.g. in README or new `Seed.md`) describing how to load seed JSON from `docs/saju/itemNcard/seed/` into the system. Include: list of example files (e.g. `saju_정재_강함.json`, `pair_궁합_충.json`), and step-by-step instructions using curl or GraphQL (createItemnCard) with a sample payload. No code changes to backend or admweb.
- **Option B (UI)**: In the card create form (admweb), add an optional “Load from seed” control (dropdown of seed file names or a single “Load example” that picks one seed). On selection, load the JSON from a static list or from an API that serves seed file contents, then fill trigger, score, and content fields from the seed (validate against CardDataStructure/ChemiStructure). Keep scope to one or two example seeds.
- Implement **one** of the options; do not require both.

---

### 3. y2sl-local MCP card registration (optional, PRD §4)

- After card CRUD and extract test are stable: add MCP tools in y2sl-local (e.g. `register_card`, `update_card`) that call the backend card API (GraphQL createItemnCard / updateItemnCard or equivalent REST). Inputs: card payload (or path to JSON file). Document in `docs/saju/itemNcard/` or in `runLoopForSaju.sh` (or its README) how the Cursor agent or loop script can use these tools to register or update cards. Implement only if the y2sl-local MCP server is in use.

---

### 4. PRD success criteria verification and operator docs

- Verify PRD §6 성공 기준:
  - admweb에서 사주 카드·궁합 카드를 별도 메뉴로 목록 조회·등록·관리 가능.
  - 사주(인생/연도별/월별)·궁합 “추출 테스트” 실행 후, 결과 화면에서 **유저 명식 분석 정보**와 **선택된 데이터 카드 목록(및 선택 근거)** 확인 가능.
  - (선택) y2sl-local MCP로 카드 등록 가능 및 runLoopForSaju.sh 연동.
- Add a short operator-facing doc (e.g. `docs/saju/itemNcard/OperatorGuide.md` or a section in README) that describes: how to open the Data Cards menu, how to create/edit/delete cards, how to run 사주 and 궁합 추출 테스트 and read the result (명식 정보 + 선택된 카드 + 근거), and how to use LLM 컨텍스트 미리보기. No code implementation; documentation only.

---

## Reference

| Doc | Use |
|-----|-----|
| PRD.md | §2-2 list/delete(소프트 삭제 권장), §2-3 extraction test, §2-4 visibility, §4 MCP, §6 성공 기준 |
| CardDataStructure.md | Trigger, score, content, LLM context, guardrails |
| ChemiStructure.md | P_tokens, pair card schema, src P/A/B |
| TokenRule.md | items → tokens, where normalization, L/M/H |
| TokenStructure.md | Token syntax, categories, positions |
| UserInfoStructure.md | items schema, pillars, tokens, rule_set, engine_version |

---

## Execution result (2026-02-01)

### What was done

1. **Task 1 – Soft delete for data cards**  
   - **Backend**: Added `deleted_at` (int64, 0 = not deleted) to `ItemNCard` entity (`api/dao/entity/itemn_card_entity.go`). Repository: `Delete` now sets `deleted_at` and `updated_at` instead of removing the document; `FindWithPagination` excludes `deleted_at > 0` by default; added `IncludeDeleted` to `ItemNCardListFilter` and wired from GraphQL `ItemNCardSearchInput.includeDeleted`. `ListPublishedByScope` and `FindByCardIDsAndScope` filter to non-deleted only. GraphQL type `ItemNCard` and input `ItemNCardSearchInput` updated (`admgql.graphql`). Service and converter updated.  
   - **admweb**: “삭제 포함” checkbox in list filters (사주/궁합 카드); list query passes `includeDeleted`; “삭제됨” badge on rows where `deletedAt > 0`; delete confirmation text set to “이 카드를 삭제할까요? (소프트 삭제됩니다)”. Fragment `itemnCardBasic` includes `deletedAt`.

2. **Task 2 – Seed data (Option A)**  
   - Added `docs/saju/itemNcard/Seed.md`: list of example files (`saju_정재_강함.json`, `pair_궁합_충.json`, etc.), step-by-step GraphQL `createItemnCard` with sample payload, admweb UI steps, and curl/GraphQL note. No backend/admweb code changes.

3. **Task 3 – y2sl-local MCP**  
   - Skipped (optional; implement when y2sl-local MCP is in use).

4. **Task 4 – Operator docs**  
   - Added `docs/saju/itemNcard/OperatorGuide.md`: how to open Data Cards menu, create/edit/delete cards (including soft delete and “삭제 포함”), run 사주/궁합 추출 테스트 and read 명식 정보 + 선택된 카드 + 근거, and use LLM 컨텍스트 미리보기.

### Status

- **Task 1**: Done.  
- **Task 2**: Done (Option A).  
- **Task 3**: Not done (optional, skipped).  
- **Task 4**: Done.

### Verification

- `go build .` run from `api/` (and `go build -o /dev/null .`) succeeds.  
- `go test ./...` was run from `api/`; in this environment test output was not captured; please run locally: `cd api && go test ./...` and `cd api && go build .` to confirm.

### Remaining / next steps

- Run full test suite locally: `cd api && go test ./...` and fix any failures.  
- Optional: Task 3 (y2sl-local MCP card registration) when the MCP server is in use.  
- PRD §6 성공 기준: already met by current Data Cards menu, CRUD, 추출 테스트 결과(명식 + 선택 카드 + 근거), and LLM 미리보기; operator doc in OperatorGuide.md.
