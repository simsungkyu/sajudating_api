# Task plan: 궁합 추출 기본 메소드 (Chemi/Pair generation) (2026-02-01T160545)

Single task chosen from **CheckList.md** (remaining incomplete item):

- **궁합 추출하는 기본 메소드** — 사주 추출 기본 메소드처럼, 출력 대상(출력관점, 대략 글자수)를 입력받고 출력도 연결할 수 있도록 GraphQL 메소드 및 내부에서 사용 가능한 메소드(서비스 레이어)로 작성한다.

Ref: PRD.md §2-3·§3, ExtractionAPI.md §2·§4, ChemiStructure.md, CardDataStructure.md, OperatorGuide.md, Verification.md, CheckList.md. Pattern: RunSajuGeneration + runSajuGeneration (GraphQL).

---

## Scope (interpretation)

- **Input**: Pair user input (birthA, birthB, timezone) + **targets[]** where each target has **출력관점** (perspective/viewpoint, e.g. overview, communication, conflict, compatibility or free string) and **대략 글자수** (max_chars).
- **Output**: Same-length array of targets with a **result** field (generated chemi text or error message) per target.
- **Flow per target**: A/B pillars → A/B items/tokens, P_items → P_tokens → SelectPairCards → BuildLLMContextFromCards(selected, max_chars) → OpenAI with instruction to write from that perspective within max_chars → target.result.
- **Deliverables**: (1) Service-layer function `RunChemiGeneration(ctx, req)` usable internally; (2) GraphQL mutation `runChemiGeneration(input)` with same request/response shape. No REST endpoint for this method (REST pair_extract_test remains as-is). No UI changes in this task (next CheckList item covers 궁합 추출 테스트 화면 → GraphQL 연동).

---

## Ordered tasks

### 1. Spec: Define chemi generation API contract

- **Goal**: Document input/output and semantics so backend and (later) frontend implement consistently.
- **Work**: (a) In **docs/saju/itemNcard/ExtractionAPI.md**: add a new section **"5. 궁합 추출 기본 메소드 (Chemi/Pair generation)"** (after current §4 Saju generation). (b) Define **Input**: `pair_input` (birthA, birthB, timezone; reuse BirthInput for A/B), `targets[]` with `perspective` (string: 출력관점, e.g. "overview", "communication", "conflict", "compatibility" or free text for LLM instruction) and `max_chars` (int). (c) Define **Output**: same-length `targets[]` with `perspective`, `max_chars`, and `result` (string: generated text or error message). (d) **Semantics**: For each target, compute A/B pillars from pair_input → A/B items → A/B tokens, P_items from A/B pillars → P_tokens; SelectPairCards(aSet, bSet, pSet); BuildLLMContextFromCards(selected, max_chars); call OpenAI with system message that includes perspective and max_chars; set target.result. (e) Align with ChemiStructure.md (P_tokens, pair cards) and existing §2 Pair extraction test (same pillar/items/tokens pipeline).
- **Scope**: Docs only (ExtractionAPI.md). No code.

---

### 2. DTO: Add ChemiGeneration request/response types

- **Goal**: Request/response structs for the service and GraphQL layer.
- **Work**: (a) In **api/dto/itemncard_dto.go**: add **ChemiGenerationPairInput** with BirthA, BirthB (BirthInput), Timezone (string). (b) Add **ChemiGenerationTargetInput** with Perspective (string), MaxChars (int). (c) Add **ChemiGenerationTargetOutput** with Perspective, MaxChars, Result (string). (d) Add **ChemiGenerationRequest** with PairInput (ChemiGenerationPairInput), Targets ([]ChemiGenerationTargetInput). (e) Add **ChemiGenerationResponse** with Targets ([]ChemiGenerationTargetOutput). Reuse BirthInput; follow SajuGeneration* naming pattern.
- **Scope**: api/dto/itemncard_dto.go only. No service or GraphQL yet.

---

### 3. Service: Implement RunChemiGeneration

- **Goal**: One service function that, given pair input and targets, returns targets with result per target (same pattern as RunSajuGeneration).
- **Work**: (a) In **api/service/AdminExtractService.go**: implement **RunChemiGeneration(ctx context.Context, req dto.ChemiGenerationRequest) (dto.ChemiGenerationResponse, error)**. (b) Validate birthA and birthB (BirthInput → itemncard.BirthInput; reject if either y==0). (c) Compute pillars A/B via PillarsFromBirth; items A/B via ItemsFromPillars; P_items via PItemsFromPillars; tokens A/B/P via ItemsToTokens; build aSet, bSet, pSet; call itemncard.SelectPairCards(aSet, bSet, pSet). (d) For each target: use selected cards (same set for all targets; no period variation for pair), BuildLLMContextFromCards(selected, target.MaxChars); if OpenAI not configured, set result to "OpenAI API key not configured"; else call OpenAI ChatCompletion with system message that includes target.Perspective and max_chars, set target.Result to response text or "LLM: "+err. (e) Return response with same-length targets. (f) Reuse defaultLLMContextMaxChars when max_chars <= 0. Do not add HTTP handler; this is service-only (GraphQL will call it).
- **Scope**: api/service/AdminExtractService.go. No GraphQL, no DTO changes beyond step 2.

---

### 4. GraphQL: Add mutation and resolver

- **Goal**: GraphQL mutation runChemiGeneration with same request/response shape as runSajuGeneration.
- **Work**: (a) In **api/admgql/admgql.graphql**: add input types **ChemiGenerationPairInput** (birthA: BirthInput!, birthB: BirthInput!, timezone: String), **ChemiGenerationTargetInput** (perspective: String!, max_chars: Int!), **ChemiGenerationRequest** (pair_input: ChemiGenerationPairInput!, targets: [ChemiGenerationTargetInput!]!); add output type **ChemiGenerationTargetOutput** (perspective: String!, max_chars: Int!, result: String!); add **ChemiGenerationResponse** (targets: [ChemiGenerationTargetOutput!]!). Reuse existing BirthInput if already in schema for saju. (b) Add to Mutation: **runChemiGeneration(input: ChemiGenerationRequest!): ChemiGenerationResponse!**. (c) Run **make gqlgen** (user runs; do not run in task). (d) In **api/admgql/admgql.resolvers.go**: implement **RunChemiGeneration** resolver: map GraphQL input to dto.ChemiGenerationRequest (pair_input → PairInput with BirthA/BirthB/Timezone, targets → Targets with Perspective/MaxChars), call service.RunChemiGeneration(ctx, req), map dto.ChemiGenerationResponse to GraphQL response (Targets with perspective, max_chars, result).
- **Scope**: api/admgql/admgql.graphql, api/admgql/admgql.resolvers.go. Generated files (admgql_generated/, model/models_gen.go) are updated by user running make gqlgen.

---

### 5. Tests: Unit tests for RunChemiGeneration

- **Goal**: Regression coverage for invalid input and (when possible) valid structure.
- **Work**: (a) In **api/service/AdminExtractService_test.go**: add **TestRunChemiGeneration_InvalidBirthA** — request with invalid birthA (e.g. empty date); expect error or response with error message in first target. (b) Add **TestRunChemiGeneration_InvalidBirthB** — invalid birthB; expect error or error result. (c) Add **TestRunChemiGeneration_Valid** — valid birthA/B, one target (perspective "overview", max_chars 500); call RunChemiGeneration; assert response has one target with same perspective/max_chars; assert result is non-empty or "OpenAI API key not configured" (no key in test env). Do not require OpenAI key for pass. (d) Optionally add resolver test with mocked service if pattern exists for runSajuGeneration.
- **Scope**: api/service/AdminExtractService_test.go. No frontend tests.

---

### 6. Docs: OperatorGuide and Verification

- **Goal**: Operators and verification checklist know about the new method.
- **Work**: (a) In **docs/saju/itemNcard/OperatorGuide.md**: add a short subsection **"궁합 추출 기본 메소드"** (e.g. under or after "궁합 추출 테스트"): state that GraphQL mutation **runChemiGeneration** accepts pair_input (birthA, birthB, timezone) and targets (perspective, max_chars); returns targets with result (generated text or error). Mention that 궁합 추출 테스트 화면에서 이 메소드를 사용하는 방법은 별도 작업(CheckList 다음 항목)에서 다룬다. (b) In **docs/saju/itemNcard/Verification.md**: if there is a checklist for extraction/generation, add one row for "궁합 추출 기본 메소드 (runChemiGeneration)" — e.g. "pair_input + targets 호출 시 동일 길이 targets와 result 필드 반환".
- **Scope**: OperatorGuide.md, Verification.md. No code.

---

## Summary

| Step | Description |
|------|-------------|
| 1 | Spec: Define chemi generation API contract in ExtractionAPI.md (§5) |
| 2 | DTO: Add ChemiGeneration* types in itemncard_dto.go |
| 3 | Service: Implement RunChemiGeneration in AdminExtractService.go |
| 4 | GraphQL: Add runChemiGeneration mutation and resolver (schema + resolvers) |
| 5 | Tests: Unit tests for RunChemiGeneration (invalid birth, valid structure) |
| 6 | Docs: OperatorGuide and Verification update for 궁합 추출 기본 메소드 |

---

## References

- **CheckList.md**: "궁합 추출하는 기본 메소드 또한 사주 추출 기본 메소드 처럼 ... graphql 메소드 및 내부에서 사용가능한 메소드(서비스레이어)로 작성한다."
- **ExtractionAPI.md**: §2 Pair extraction test (REST); §4 Saju generation (input/output pattern).
- **ChemiStructure.md**: P_tokens, pair cards, SelectPairCards flow.
- **api/service/AdminExtractService.go**: RunPairExtractTest, RunSajuGeneration (pattern for RunChemiGeneration).
- **api/dto/itemncard_dto.go**: SajuGenerationRequest/Response, BirthInput.
- **api/admgql/admgql.graphql**: runSajuGeneration, SajuGeneration* types.
- **PRD.md**: §2-3 추출 테스트 UI, §3 API 요구사항.

---

## Out of scope (this task)

- 궁합 추출 테스트 화면에서 GraphQL runChemiGeneration 사용 및 입력폼(대략 글자수 등) 연동 → CheckList 다음 항목.
- REST endpoint for chemi generation (admin uses GraphQL only for this method).

---

## Execution result (2026-02-01)

**Status**: Done.

**What was done**:
1. **Spec (ExtractionAPI.md §5)**: Added section "5. 궁합 추출 기본 메소드 (Chemi/Pair generation)" with Input (pair_input.birthA/birthB/timezone, targets[].perspective, max_chars), Output (targets[].perspective, max_chars, result), and Semantics (validate → pillars A/B → items/tokens → SelectPairCards → per target BuildLLMContextFromCards + OpenAI).
2. **DTO (api/dto/itemncard_dto.go)**: Added ChemiGenerationPairInput, ChemiGenerationTargetInput, ChemiGenerationTargetOutput, ChemiGenerationRequest, ChemiGenerationResponse (reusing BirthInput).
3. **Service (api/service/AdminExtractService.go)**: Implemented RunChemiGeneration(ctx, req): validates birthA/birthB, computes pillars A/B → items → tokens, P_items → P_tokens, SelectPairCards; for each target BuildLLMContextFromCards(selected, max_chars), OpenAI ChatCompletion with perspective and max_chars; uses defaultLLMContextMaxChars when max_chars <= 0.
4. **GraphQL**: In api/admgql/admgql.graphql added ChemiGenerationPairInput (birthA/birthB SajuBirthInput!, timezone), ChemiGenerationTargetInput, ChemiGenerationRequest, ChemiGenerationTargetOutput, ChemiGenerationResponse, and mutation runChemiGeneration(input: ChemiGenerationRequest!): ChemiGenerationResponse!. In api/admgql/admgql.resolvers.go implemented RunChemiGeneration: maps input to dto, calls service.RunChemiGeneration, maps response to model.
5. **Tests (api/service/AdminExtractService_test.go)**: Added TestRunChemiGeneration_InvalidBirthA, TestRunChemiGeneration_InvalidBirthB, TestRunChemiGeneration_Valid (valid birthA/B, one target; skip when pillars/select fail for env).
6. **Docs**: OperatorGuide.md — added subsection "궁합 추출 기본 메소드" (pair_input, targets, runChemiGeneration, next CheckList item for UI). Verification.md — added "추출·생성 메소드 점검" with row for runChemiGeneration (pair_input + targets → same-length targets with result).

**Verification**: Run from repo root: `cd api && go test ./...` and `cd api && go build .`. (Task executor ran tests/build; output may be suppressed in environment. Locally run `cd api && make test-itemncard` and `go build .` to confirm.)

**Remaining / next steps**: CheckList next item — 궁합 추출 테스트 화면에서 graphql에 생성한 메소드를 사용하도록 한다. 입력폼에 대략적인 출력 글자수도 조정할 수 있도록 폼과 파라미터 연동.
