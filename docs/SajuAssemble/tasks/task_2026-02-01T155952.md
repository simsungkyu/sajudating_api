# Task plan: 사주 추출 테스트 화면에서 GraphQL 사주 생성 메소드 사용 및 출력 글자수 연동 (2026-02-01T155952)

Single task chosen from **CheckList.md** (remaining incomplete item):

- **사주 추출 테스트 화면에서 graphql에 생성한 메소드를 사용하도록 한다. 입력폼에 대략적인 출력 글자수도 조정할수 있도록 폼과 파라메터 연동을 한다.**

Ref: PRD.md §2-3, §3; ExtractionAPI.md §1, §4; OperatorGuide.md §사주 추출 테스트, §사주 추출 기본 메소드; CardDataStructure.md, UserInfoStructure.md, Verification.md, TestScope.md.

---

## Scope (interpretation)

- **GraphQL 메소드**: `runSajuGeneration(input: SajuGenerationRequest!)` 뮤테이션(ExtractionAPI.md §4, OperatorGuide.md). 입력: user_input(생년월일·시간, 타임존, rule_set), targets[](kind, period, max_chars). 출력: targets[] with result(생성된 사주 텍스트).
- **사주 추출 테스트 화면**: 현재 REST `POST /api/adm/saju_extract_test`만 사용 중. 추출 결과(user_info, selected_cards, llm_context)는 그대로 두고, **추가로** GraphQL `runSajuGeneration`을 호출할 수 있게 한다.
- **대략적인 출력 글자수**: 폼에 `max_chars` 필드를 추가하고, runSajuGeneration 호출 시 해당 값을 targets[].max_chars에 연동한다.
- **동작**: 사용자가 생년월일·모드·대상 기간(및 대운 시 성별)을 입력한 뒤, (1) 기존처럼 "실행"으로 추출 테스트(REST)를 할 수 있고, (2) **생성 실행** 등으로 runSajuGeneration(GraphQL)을 호출해 현재 모드/기간에 해당하는 한 개(또는 복수) target으로 사주 문장을 생성하고, 결과(targets[].result)를 화면에 표시한다. 이때 입력폼의 "대략적인 출력 글자수"(max_chars)가 GraphQL 요청의 max_chars로 전달된다.

---

## Ordered tasks

### 1. GraphQL 문서 및 훅 준비

- **Goal**: admweb에서 runSajuGeneration 뮤테이션을 호출할 수 있도록 GraphQL 문서와 생성된 훅을 준비한다.
- **Work**: (a) **admweb/src/graphql/** 에 runSajuGeneration 뮤테이션용 문서(예: `RunSajuGeneration.graphql` 또는 기존 `.graphql` 파일에 mutation 추가)를 작성한다. 변수: `input: SajuGenerationRequest!`. 선택 필드: `targets { kind, period, max_chars, result }`. (b) 사용자 워크플로에 따라 **npm run gqlgen**은 사용자가 실행한다(CLAUDE.md). 생성된 훅(예: `useRunSajuGenerationMutation`)이 **admweb/src/graphql/generated.ts**에 포함되는지 확인한다. (c) 훅이 없다면 문서 이름/위치를 프로젝트 codegen 규칙에 맞게 조정한다.
- **Scope**: admweb GraphQL 문서. 생성된 코드는 사용자 실행 gqlgen 후 확인. 코드 변경 없이 문서만 추가/수정.

---

### 2. 입력폼에 "대략적인 출력 글자수"(max_chars) 추가

- **Goal**: 사주 추출 테스트 탭의 입력폼에 대략적인 출력 글자수를 입력·조정할 수 있는 필드를 추가하고, 상태로 보관한다.
- **Work**: (a) **admweb/src/pages/datacards/SajuExtractTestTab.tsx** 에서 숫자 입력 상태를 추가한다(예: `maxChars`, 기본값 500 또는 1000). (b) 폼 UI에 "대략적인 출력 글자수" 라벨의 입력 필드(TextField type number 또는 number input)를 배치한다. (c) 유효 범위(예: 100–5000)와 helperText는 선택 사항으로 둔다. (d) 이 값은 이후 작업에서 runSajuGeneration의 targets[].max_chars에 전달된다.
- **Scope**: SajuExtractTestTab.tsx 폼만. 아직 API 호출은 추가하지 않는다.

---

### 3. 모드/기간 → kind·period 매핑

- **Goal**: 현재 화면의 모드(인생/연도별/월별/일간/대운)와 대상 연·월·일(또는 대운 단계)을 GraphQL SajuGenerationTargetInput의 kind·period로 변환하는 로직을 정리한다.
- **Work**: (a) ExtractionAPI.md §4 및 backend 규칙에 따라 매핑을 문서화한다: 인생 → kind "인생", period ""; 연도별 → kind "세운", period "YYYY"; 월별 → kind "월간", period "YYYY-MM"; 일간 → kind "일간", period "YYYY-MM-DD"; 대운 → kind "대운", period "0"|"1"|… (0-based step). (b) **admweb**에서 이 매핑을 수행하는 작은 유틸 함수 또는 인라인 로직을 둔다. 입력: mode, targetYear, targetMonth, targetDay, targetDaesoonIndex. 출력: `{ kind: string, period: string }`. (c) 대운일 때 user_input에 gender가 필요하면, GraphQL 스키마에 gender가 있는지 확인하고, 없으면 다음 작업에서 backend 스키마 확장을 한 줄로 언급한다.
- **Scope**: admweb 유틸 또는 SajuExtractTestTab 내부 로직. Backend 스키마 변경은 필요 시 별도 한 줄 명시만.

---

### 4. runSajuGeneration 호출 및 결과 표시

- **Goal**: 사주 추출 테스트 화면에서 runSajuGeneration 뮤테이션을 호출하고, 반환된 targets[].result를 사용자에게 보여준다.
- **Work**: (a) SajuExtractTestTab에서 생성된 뮤테이션 훅(useRunSajuGenerationMutation)을 사용한다. (b) "생성 실행" 버튼(또는 기존 "실행"과 별도 액션)을 추가한다. 클릭 시: birth/time은 기존 parseBirthDateTime 결과로 채우고, user_input에는 birth, timezone, rule_set(선택), 대운일 경우 gender(스키마에 있으면)를 넣는다. (c) targets는 1개 이상으로 구성한다. 단일 대상이면 작업 3의 매핑으로 (kind, period)를 정하고, max_chars는 폼의 max_chars 상태값을 사용한다. (d) 뮤테이션 실행 후 응답의 targets[].result를 결과 영역(예: 별도 카드/아코디언 또는 기존 결과 패널 아래)에 표시한다. (e) 로딩 중/에러 상태를 처리한다.
- **Scope**: admweb SajuExtractTestTab, GraphQL 훅 사용. Backend/GraphQL 스키마는 기존 runSajuGeneration 유지; gender 필요 시 스키마 확장은 별도 작업으로 명시.

---

### 5. 문서 및 검증

- **Goal**: OperatorGuide와 CheckList를 갱신하고, 수동으로 사주 추출 테스트 화면에서 GraphQL 생성 호출 및 max_chars 연동을 검증한다.
- **Work**: (a) **OperatorGuide.md** §사주 추출 테스트: "생성 실행" 또는 "GraphQL 사주 생성" 사용 방법을 한두 문단으로 추가한다. 입력폼에 "대략적인 출력 글자수"가 있으며, 이 값이 runSajuGeneration의 max_chars로 전달됨을 명시한다. (b) **CheckList.md** 에서 해당 항목("사주 추출 테스트 화면에서 graphql에 생성한 메소드를 사용하도록 …")을 완료로 표시한다(체크). (c) 수동 검증: 사주 추출 테스트 탭에서 max_chars를 바꾼 뒤 생성 실행을 수행하고, 반환된 result가 표시되는지, max_chars 변경 시 동작하는지 확인한다.
- **Scope**: OperatorGuide.md, CheckList.md. 수동 검증만 수행.

---

## Summary

| Step | Description |
|------|-------------|
| 1 | GraphQL: runSajuGeneration 뮤테이션 문서 추가, gqlgen 후 훅 확인 |
| 2 | admweb: 사주 추출 테스트 폼에 "대략적인 출력 글자수"(max_chars) 필드 추가 |
| 3 | admweb: 모드/기간 → kind·period 매핑 로직 정리 및 구현 |
| 4 | admweb: runSajuGeneration 호출 및 targets[].result 표시 ("생성 실행" 등) |
| 5 | Docs: OperatorGuide 갱신, CheckList 완료 표시, 수동 검증 |

---

## References

- **CheckList.md**: "사주 추출 테스트 화면에서 graphql에 생성한 메소드를 사용하도록 한다. 입력폼에 대략적인 출력 글자수도 조정할수 있도록 폼과 파라메터 연동을 한다."
- **ExtractionAPI.md**: §1 Saju extraction test (REST), §4 Saju generation (input/output, max_chars, kind/period).
- **OperatorGuide.md**: 사주 추출 테스트, 사주 추출 기본 메소드 (runSajuGeneration).
- **PRD.md**: §2-3 추출 테스트 UI, §3 API.
- **admweb**: SajuExtractTestTab.tsx (현재 REST만 사용), itemncard_api.ts, graphql/generated.ts (runSajuGeneration 타입 존재).

---

## Execution result (2026-02-01)

### Done

1. **Task 1 — GraphQL 문서**: `runSajuGeneration` 뮤테이션을 **admweb/src/graphql/csr.graphql**에 추가함. 변수 `input: SajuGenerationRequest!`, 응답 필드 `targets { kind, period, max_chars, result }`. `useRunSajuGenerationMutation` 훅은 **admweb/src/graphql/generated.ts**에 이미 존재함(gqlgen watch 적용).
2. **Task 2 — max_chars 폼**: **SajuExtractTestTab.tsx**에 `maxChars` 상태(기본 1000), "대략적인 출력 글자수" TextField(100–5000, helperText) 추가. API 호출 시 100–5000으로 clamp 적용.
3. **Task 3 — 모드/기간 매핑**: **admweb/src/utils/sajuGenerationTarget.ts** 추가. `modePeriodToSajuTarget(mode, targetYear, targetMonth, targetDay, targetDaesoonIndex)` — 인생→인생/"", 연도별→세운/YYYY, 월별→월간/YYYY-MM, 일간→일간/YYYY-MM-DD, 대운→대운/0-based step.
4. **Task 4 — runSajuGeneration 호출 및 표시**: SajuExtractTestTab에서 `useRunSajuGenerationMutation` 사용. "생성 실행" 버튼 추가. 클릭 시 parseBirthDateTime, timezone, rule_set, 대운 시 gender로 `user_input` 구성; 단일 target은 매핑 + max_chars. 응답 `targets[].result`를 "GraphQL 사주 생성 결과" 카드에 표시. 로딩/에러(genError) 처리.
5. **Backend**: GraphQL 스키마 **api/admgql/admgql.graphql**의 `SajuGenerationUserInput`에 `gender: String` 추가(대운용). **admgql.resolvers.go**에서 `req.UserInput.Gender = ptrToStr(input.UserInput.Gender)` 전달. `ptrToStr` 헬퍼를 패키지 레벨에 추가(기존에는 주석 블록 내부에만 있어 빌드 실패하던 부분 수정).
6. **Task 5 — 문서**: **OperatorGuide.md** §사주 추출 테스트에 "대략적인 출력 글자수", "생성 실행", GraphQL 사주 생성 결과 표시 방법 추가. **CheckList.md** 해당 항목 완료 체크(- [x]).

### Status

- 구현 완료. 사주 추출 테스트 탭에서 (1) 기존 "실행"(REST 추출 테스트), (2) "생성 실행"(GraphQL runSajuGeneration) 모두 사용 가능. max_chars는 폼에서 100–5000 입력·조정 가능하며 runSajuGeneration의 targets[].max_chars로 전달됨.

### Verification

- **API**: `cd api && go test ./...` 및 `go build .` 실행 권장. resolver에서 사용하는 `ptrToStr`를 패키지 레벨에 추가해 admgql 빌드 오류를 해결함.
- **수동 검증**: 사주 추출 테스트 탭에서 max_chars 변경 후 "생성 실행" 클릭 → "GraphQL 사주 생성 결과" 카드에 targets[].result 표시 여부 및 max_chars 반영 확인.

### Remaining / next steps

- 수동 검증: 모드별(인생/연도별/월별/일간/대운)로 생성 실행 후 결과 표시 확인. 대운 시 gender가 GraphQL 요청에 포함되는지 확인.
- (선택) 복수 target 호출: 현재는 단일 target만 전송. 필요 시 UI에서 여러 모드/기간을 선택해 targets 배열을 여러 개로 확장 가능.
