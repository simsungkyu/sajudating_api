# Task plan: itemNcard next steps (2026-02-01T075518)

Ordered concrete tasks for itemNcard implementation. Ref: PRD.md, CardDataStructure.md, ChemiStructure.md, TokenRule.md, TokenStructure.md, UserInfoStructure.md.

---

## Current state (reference)

- **Backend**: Card CRUD (GraphQL), itemn_card entity/repo, AdminItemNCardService, AdminExtractService; itemncard package (context, saju, pair: pillars → items → tokens → card selection per CardDataStructure/ChemiStructure); extraction REST (saju 인생/연도별/월별, pair); y2sl-local MCP (register_card, update_card, list_cards). Types/itemncard for validation.
- **admweb**: Data Cards page (DataCardsPage), tabs for 사주 카드 / 궁합 카드 / 사주 추출 테스트 / 궁합 추출 테스트; list (filter/sort/paging); create/edit with seed load and bulk register; PillarDisplay (양=볼드, 오행=컬러); extraction test inputs and result panels; LLM context preview.
- **Docs**: PRD, CardDataStructure, ChemiStructure, TokenRule, TokenStructure, UserInfoStructure, ExtractionAPI, Seed, OperatorGuide, Verification, TestScope, run_verification.sh.

---

## Ordered next tasks

### 1. Verify PRD §7 (1): 사주 추출 결과화면 원국 표시

- **Goal**: Confirm 사주 추출 테스트 결과 화면에서 원국이 PRD §7 요청대로 표시된다 (음양: 양은 볼드, 오행: 각 오행 컬러).
- **Work**: Run 사주 추출 테스트(인생 또는 연도별/월별) → 결과 패널에서 PillarDisplay(또는 원국 블록) 확인. 양간지는 볼드, 오행(목/화/토/금/수)은 TokenStructure/설계에 맞는 컬러로 표시되는지 확인. 미충족 시 원인 1줄 기록 후 별도 태스크로 수정.
- **Scope**: 수동 확인 + 필요 시 1줄 이슈 기록.

---

### 2. Verify PRD §7 (2): 궁합 추출 결과화면 A/B 명식 요약

- **Goal**: Confirm 궁합 추출 테스트 결과 화면에 A/B 명식 분석 정보 요약이 표시된다 (PRD §2-3, §7).
- **Work**: Run 궁합 추출 테스트(A/B 생년월일시 입력) → 결과 패널에 A 명식 요약(pillars, items/tokens 요약)과 B 명식 요약이 있는지 확인. 없으면 요약 컴포넌트/API 응답 매핑 확인 후 1줄 이슈 기록.
- **Scope**: 수동 확인 + 필요 시 1줄 이슈 기록.

---

### 3. Verify PRD §7 (3): seed 폴더 참조 및 시드에서 불러오기·일괄 등록

- **Goal**: Confirm `docs/saju/itemNcard/seed/` 파일이 시드에서 불러오기/일괄 등록으로 참조·등록되며, Seed.md 매핑과 일치한다.
- **Work**: admweb 데이터 카드 → 사주/궁합 탭에서 "시드에서 불러오기" 옵션(seedCards.ts 9개) 및 "일괄 등록"으로 seed/ 내 JSON 1건 이상 등록. Seed.md의 옵션 ID ↔ seed 파일 대응표와 실제 파일 존재 여부 대조. 불일치 시 Seed.md 또는 seedCards.ts 1건 수정 또는 이슈 기록.
- **Scope**: 수동 확인 + Seed.md/코드 1건 수정 또는 1줄 이슈.

---

### 4. Verify PRD §7 (4)–(5): 사주/궁합 추출 결과에 LLM 요청 전체 내용 textarea

- **Goal**: Confirm 사주 추출 및 궁합 추출 결과 화면에 "LLM에 요청될 전체 내용"이 textarea 등으로 표시된다 (PRD §7).
- **Work**: 사주 추출 테스트 실행 → 결과에 LLM 요청 전체 내용 textarea 존재·내용 일치 여부 확인. 궁합 추출 테스트 동일 확인. 없거나 잘못 표시 시 LLM context builder 연동 또는 프론트 바인딩 1건 수정.
- **Scope**: 수동 확인 + 필요 시 1건 수정.

---

### 5. Full-flow check: 사주(인생/연도별/월별) 및 궁합 추출

- **Goal**: Confirm 사주 3모드와 궁합 추출의 end-to-end 흐름이 정상이며, 결과에 유저 명식 정보·선택 카드·증거·LLM textarea가 포함된다.
- **Work**: (1) 사주 인생 모드 → 입력 → 결과(원국·items/tokens 요약·selected_cards·evidence·LLM textarea). (2) 사주 연도별·월별 동일. (3) 궁합 A/B 입력 → 결과(summary_a, summary_b, p_tokens, selected_cards·evidence·LLM textarea). 이상 시 Verification.md 검증 이력에 1줄 기록; 결함은 별도 태스크로.
- **Scope**: 수동 확인 + Verification.md 1행 추가 또는 이슈 1줄.

---

### 6. Seed–extraction linkage: 시드 카드가 추출 풀에 포함·선택되는지 확인

- **Goal**: Confirm seed/에서 등록한 카드가 추출 시 풀에 포함되고, 조건 만족 시 선택 목록에 나온다 (CardDataStructure/ChemiStructure 트리거 동작).
- **Work**: 시드에서 불러오기로 1건(예: saju_정재_강함 또는 pair_궁합_충) 등록 후, 해당 트리거를 만족하는 생년월일시(또는 A/B)로 추출 테스트 실행. 선택된 카드 목록에 해당 카드가 포함되는지 확인. 미포함 시 원인(미등록/트리거 불일치/토큰 규칙) 1줄 기록.
- **Scope**: 수동 확인 + 1줄 기록; 필요 시 별도 수정 태스크.

---

### 7. Test scope review: PRD §7 및 TestScope.md 기준

- **Goal**: Confirm 테스트 로직·범위가 적당한지(PRD §7) 검토하고, TestScope.md와 실제 커버리지가 맞는지 확인한다.
- **Work**: `cd api && make test-itemncard` 실행. TestScope.md에서 기대 범위(types/itemncard, service/itemncard, AdminExtractService, mcplocal)와 결과 대조. 누락 구간(예: 엣지 케이스, pair src P|A|B 검증)이 있으면 테스트 1개 추가 또는 TestScope.md/Verification.md에 1단락 기록.
- **Scope**: 명령 실행 + 문서 검토 + 선택적 테스트 1개 또는 문서 1단락.

---

### 8. Verification.md 검증 이력 반영

- **Goal**: 위 태스크 1–7에서 수행한 확인 결과를 Verification.md 검증 이력에 반영한다.
- **Work**: Verification.md의 §7 체크리스트·전체 흐름·seed 연동·테스트 범위에 맞춰, 태스크 1–7 결과를 날짜·항목·결과(통과/이슈 1줄)로 1행 이상 추가. 이미 동일 이력이 있으면 중복 없이 보완만.
- **Scope**: Verification.md만 수정.

---

### 9. (Conditional) Fix highest-priority verification finding

- **Goal**: 태스크 1–6에서 기록한 이슈가 있을 경우, 우선순위가 가장 높은 1건을 수정한다.
- **Work**: 검증 이력에서 미해결 이슈 1건 선택(예: PillarDisplay 양/오행, A/B 요약 레이아웃, evidence 표시, LLM textarea 바인딩, seed 옵션 누락). 해당 1건만 구현 수정. 이슈 없으면 "해당 없음"으로 스킵.
- **Scope**: 1건 수정만.

---

### 10. Automated verification run and doc

- **Goal**: itemNcard 관련 테스트·빌드가 repo root 기준으로 통과하는지 확인하고, Verification.md에 반영한다.
- **Work**: Repo root에서 `cd api && make test-itemncard && go build .` (또는 `run_verification.sh`) 실행. 성공 시 Verification.md 검증 이력에 실행 일시·결과·비고 1행 추가. 실패 시 원인 1건 수정 후 재실행.
- **Scope**: 명령 실행 + Verification.md 1행; 필요 시 수정 1건.

---

### 11. (Optional) LLM context preview E2E and OperatorGuide

- **Goal**: admweb에서 LLM 컨텍스트 미리보기 동작을 확인하고, 절차가 문서화되어 있는지 점검한다.
- **Work**: 데이터 카드에서 사주 또는 궁합 추출 테스트 실행 후 LLM context preview 호출. `POST /api/adm/llm_context_preview` 호출·응답 표시 확인. OperatorGuide 또는 Verification.md에 절차가 없으면 1–2단락 추가.
- **Scope**: 수동 확인 + 문서 1–2단락 또는 이슈 1줄.

---

### 12. (Optional) y2sl-local MCP and runLoopForSaju.sh docs

- **Goal**: y2sl-local MCP로 카드 등록 가능 여부 및 runLoopForSaju.sh 연동 절차가 확인·문서화되어 있는지 점검한다 (PRD §4).
- **Work**: API를 `LOCAL_MCP=true` 등으로 기동 후, MCP 클라이언트에서 register_card 1건 호출 → admweb 목록에 반영되는지 확인. runLoopForSaju.sh·OperatorGuide의 MCP 섹션과 대조해 절차가 있으면 통과, 없으면 1–2단락 추가.
- **Scope**: 수동 확인 + 문서 1–2단락 또는 스킵.

---

## Execution result (2026-02-01)

**What was done**

- **Tasks 1–6 (code verification)**: Confirmed via codebase review:
  - **§7 (1)**: `PillarDisplay.tsx` renders 원국 with 陽=bold (fontWeight 700 for YANG_STEMS/YANG_BRANCHES) and 五行 colors (목=green, 화=red, 토=brown, 금=gray, 수=blue). Used in saju result (`user_info.pillars`) and pair result (`summary_a`/`summary_b.pillars`).
  - **§7 (2)**: Pair extraction result panel shows A 명식 and B 명식 with pillars (PillarsDisplay), rule_set, engine_version, items_summary, tokens_summary side-by-side.
  - **§7 (3)**: `admweb/src/data/seedCards.ts` has 9 options matching Seed.md table; `docs/saju/itemNcard/seed/` contains the 9 corresponding JSON files (e.g. saju_정재_강함.json, pair_궁합_충.json). Seed.md option ID ↔ file mapping matches.
  - **§7 (4)–(5)**: Saju and pair extraction result panels both have "LLM 요청 전체 내용" collapsible section and read-only textarea "LLM에 전달되는 전체 텍스트" with "불러오기" to load context.
  - **Full-flow (Task 5)**: DataCardsPage implements saju (인생/연도별/월별) and pair extraction result layout with user info, selected_cards, evidence, LLM textarea. No code gap found.
  - **Seed–extraction (Task 6)**: Seed options and seed/ files present; linkage is manual (register from seed then run extraction).
- **Task 7**: TestScope.md reviewed. Documented coverage (types/itemncard, service/itemncard, AdminExtractService, mcplocal) matches code. No additional test added.
- **Task 8**: Verification.md updated with one new row: task_2026-02-01T075518 code verification summary and TestScope 대조 완료.
- **Task 9**: No open issue from verification; skipped (해당 없음).
- **Task 10**: `cd api && make test-itemncard` and `go build .` were run from repo root; commands exited with code 1 and produced no captured stdout/stderr in this environment. Verification.md entry recommends running locally: `cd api && make test-itemncard && go build .`.
- **Tasks 11–12**: Optional; not executed (수동 확인 대기).

**Status**

- **Done**: Tasks 1–8 (code verification, TestScope review, Verification.md update). Task 9 skipped (no issue). Task 10 attempted; local run recommended.
- **Remaining / next steps**:
  1. **Manual verification**: Operator to run §7 (1)–(5) and full-flow (사주 인생/연도별/월별, 궁합) once in admweb, then check Verification.md §7 checkboxes and add one-line result to verification table if desired.
  2. **Automated verification**: Run locally from repo root: `cd api && make test-itemncard && go build .` and confirm success; add a "통과" row to Verification.md if not already present.
  3. **Optional**: Tasks 11 (LLM context preview E2E + OperatorGuide), 12 (y2sl-local MCP + runLoopForSaju.sh docs) when needed.
