# Task plan: 궁합 추출 테스트 화면에서 GraphQL 궁합 생성 메소드 사용 및 출력 글자수·출력관점 연동 (2026-02-01T161112)

Single task chosen from **CheckList.md** (remaining incomplete item):

- **궁합 추출 테스트 화면에서 graphql에 생성한 메소드를 사용하도록 한다. 입력폼에 대략적인 출력 글자수도 조정할수 있도록 폼과 파라메터 연동을 한다.**

Ref: PRD.md §2-3, §3; ExtractionAPI.md §2, §5; OperatorGuide.md §궁합 추출 테스트, §궁합 추출 기본 메소드; ChemiStructure.md, UserInfoStructure.md, Verification.md, TestScope.md.

---

## Scope (interpretation)

- **GraphQL 메소드**: `runChemiGeneration(input: ChemiGenerationRequest!)` 뮤테이션(ExtractionAPI.md §5, OperatorGuide.md). 입력: pair_input(birthA, birthB, timezone), targets[](perspective, max_chars). 출력: targets[] with result(생성된 궁합 텍스트 또는 오류 메시지).
- **궁합 추출 테스트 화면**: 현재 REST `POST /api/adm/pair_extract_test`만 사용 중. 추출 결과(summary_a/b, p_tokens_summary, selected_cards, llm_context)는 그대로 두고, **추가로** GraphQL `runChemiGeneration`을 호출할 수 있게 한다.
- **대략적인 출력 글자수**: 폼에 `max_chars` 필드를 추가하고, runChemiGeneration 호출 시 해당 값을 targets[].max_chars에 연동한다.
- **출력관점**: 폼에 `perspective`(출력관점) 필드를 추가하고, runChemiGeneration 호출 시 targets[].perspective에 연동한다(예: overview, communication, conflict, compatibility 또는 자유 문구).
- **동작**: 사용자가 A/B 생년월일·시간, 타임존을 입력한 뒤, (1) 기존처럼 "실행"으로 추출 테스트(REST)를 할 수 있고, (2) **생성 실행** 등으로 runChemiGeneration(GraphQL)을 호출해 한 개(또는 복수) target으로 궁합 문장을 생성하고, 결과(targets[].result)를 화면에 표시한다. 이때 입력폼의 "대략적인 출력 글자수"(max_chars)와 "출력관점"(perspective)이 GraphQL 요청에 전달된다.

---

## Ordered tasks

### 1. GraphQL 문서 및 훅 준비

- **Goal**: admweb에서 runChemiGeneration 뮤테이션을 호출할 수 있도록 GraphQL 문서와 생성된 훅을 준비한다.
- **Work**: (a) **admweb/src/graphql/csr.graphql**에 runChemiGeneration 뮤테이션을 추가한다. 변수: `input: ChemiGenerationRequest!`. 선택 필드: `targets { perspective, max_chars, result }`. (b) 사용자 워크플로에 따라 **npm run gqlgen**은 사용자가 실행한다(CLAUDE.md). 생성된 훅(예: `useRunChemiGenerationMutation`)이 **admweb/src/graphql/generated.ts**에 포함되는지 확인한다. (c) 훅이 없다면 문서 이름/위치를 프로젝트 codegen 규칙에 맞게 조정한다.
- **Scope**: admweb GraphQL 문서. 생성된 코드는 사용자 실행 gqlgen 후 확인. 코드 변경 없이 문서만 추가/수정.

---

### 2. 입력폼에 "대략적인 출력 글자수"(max_chars) 및 "출력관점"(perspective) 추가

- **Goal**: 궁합 추출 테스트 탭의 입력폼에 대략적인 출력 글자수와 출력관점을 입력·조정할 수 있는 필드를 추가하고, 상태로 보관한다.
- **Work**: (a) **admweb/src/pages/datacards/PairExtractTestTab.tsx**에서 숫자 입력 상태(maxChars, 기본값 1000)와 출력관점 상태(perspective, 기본값 예: "overview")를 추가한다. (b) 폼 UI에 "대략적인 출력 글자수" 라벨의 입력 필드(TextField type number, 예: 100–5000)와 "출력관점" 라벨의 입력 필드(TextField 또는 Select: overview, communication, conflict, compatibility 등 예시 또는 자유 텍스트)를 배치한다. (c) max_chars 유효 범위(예: 100–5000)와 helperText는 선택 사항으로 둔다. (d) 이 값들은 이후 작업에서 runChemiGeneration의 targets[].max_chars, targets[].perspective에 전달된다.
- **Scope**: PairExtractTestTab.tsx 폼만. 아직 API 호출은 추가하지 않는다.

---

### 3. pair_input 및 targets 구성 로직

- **Goal**: 현재 화면의 A/B 생일·시간·타임존을 GraphQL ChemiGenerationRequest의 pair_input과 targets(1개 이상)로 변환하는 로직을 정리한다.
- **Work**: (a) ExtractionAPI.md §5 및 backend 규칙에 따라: pair_input = { birthA: { date, time, time_precision }, birthB: { date, time, time_precision }, timezone }; targets = [{ perspective: 폼의 perspective, max_chars: 폼의 max_chars }]. (b) **admweb**에서 parseBirthDateTime(birthDateTimeA/B) 결과로 birthA/birthB를 구성하고, 폼의 timezone·perspective·maxChars로 단일 target(또는 고정/선택 가능한 복수 perspective)을 만드는 인라인 로직 또는 작은 유틸을 둔다. (c) 대응되는 GraphQL 타입(ChemiGenerationPairInput, ChemiGenerationTargetInput)은 generated.ts에 있으므로 그대로 사용한다.
- **Scope**: admweb PairExtractTestTab 또는 utils. Backend/GraphQL 스키마는 기존 runChemiGeneration 유지.

---

### 4. runChemiGeneration 호출 및 결과 표시

- **Goal**: 궁합 추출 테스트 화면에서 runChemiGeneration 뮤테이션을 호출하고, 반환된 targets[].result를 사용자에게 보여준다.
- **Work**: (a) PairExtractTestTab에서 생성된 뮤테이션 훅(useRunChemiGenerationMutation)을 사용한다. (b) "생성 실행" 버튼(또는 기존 "실행"과 별도 액션)을 추가한다. 클릭 시: birthA/birthB는 parseBirthDateTime(birthDateTimeA/B) 결과로 채우고, pair_input에 birthA, birthB, timezone을 넣는다. (c) targets는 1개 이상으로 구성한다. 단일 대상이면 작업 2·3의 폼 값(perspective, max_chars)으로 한 개 target을 넣는다. (d) 뮤테이션 실행 후 응답의 targets[].result를 결과 영역(예: 별도 카드/아코디언 또는 기존 결과 패널 아래)에 표시한다. (e) 로딩 중/에러 상태를 처리한다.
- **Scope**: admweb PairExtractTestTab, GraphQL 훅 사용. Backend/GraphQL 스키마는 기존 runChemiGeneration 유지.

---

### 5. 문서 및 검증

- **Goal**: OperatorGuide와 CheckList를 갱신하고, 수동으로 궁합 추출 테스트 화면에서 GraphQL 생성 호출 및 max_chars·perspective 연동을 검증한다.
- **Work**: (a) **OperatorGuide.md** §궁합 추출 테스트: "생성 실행" 또는 "GraphQL 궁합 생성" 사용 방법을 한두 문단으로 추가한다. 입력폼에 "대략적인 출력 글자수"와 "출력관점"이 있으며, 이 값들이 runChemiGeneration의 targets[].max_chars, targets[].perspective로 전달됨을 명시한다. (b) **CheckList.md**에서 해당 항목("궁합 추출 테스트 화면에서 graphql에 생성한 메소드를 사용하도록 …")을 완료로 표시한다(체크). (c) 수동 검증: 궁합 추출 테스트 탭에서 max_chars·perspective를 바꾼 뒤 생성 실행을 수행하고, 반환된 result가 표시되는지, 값 변경 시 동작하는지 확인한다.
- **Scope**: OperatorGuide.md, CheckList.md. 수동 검증만 수행.

---

## Summary

| Step | Description |
|------|-------------|
| 1 | GraphQL: runChemiGeneration 뮤테이션 문서 추가, gqlgen 후 훅 확인 |
| 2 | admweb: 궁합 추출 테스트 폼에 "대략적인 출력 글자수"(max_chars)·"출력관점"(perspective) 필드 추가 |
| 3 | admweb: pair_input·targets 구성 로직 정리 및 구현 |
| 4 | admweb: runChemiGeneration 호출 및 targets[].result 표시 ("생성 실행" 등) |
| 5 | Docs: OperatorGuide 갱신, CheckList 완료 표시, 수동 검증 |

---

## References

- **CheckList.md**: "궁합 추출 테스트 화면에서 graphql에 생성한 메소드를 사용하도록 한다. 입력폼에 대략적인 출력 글자수도 조정할수 있도록 폼과 파라메터 연동을 한다."
- **ExtractionAPI.md**: §2 Pair extraction test (REST), §5 Chemi/Pair generation (input/output, perspective, max_chars).
- **OperatorGuide.md**: 궁합 추출 테스트, 궁합 추출 기본 메소드 (runChemiGeneration).
- **PRD.md**: §2-3 추출 테스트 UI, §3 API.
- **admweb**: PairExtractTestTab.tsx (현재 REST만 사용), itemncard_api.ts, graphql/generated.ts (ChemiGeneration 타입 존재; runChemiGeneration 뮤테이션 문서는 csr.graphql에 없을 수 있음).
- **사주 대응 작업**: task_2026-02-01T155952 (사주 추출 테스트 화면에서 runSajuGeneration 사용 및 max_chars 연동).

---

## Execution result (2026-02-01)

**Done**

1. **GraphQL 문서**: `admweb/src/graphql/csr.graphql`에 `runChemiGeneration($input: ChemiGenerationRequest!)` 뮤테이션 추가. 선택 필드: `targets { perspective, max_chars, result }`. `useRunChemiGenerationMutation` 훅은 이미 `generated.ts`에 존재함(사용자 gqlgen 워치 유지).
2. **입력폼**: `PairExtractTestTab.tsx`에 상태 `maxChars`(기본 1000), `perspective`(기본 "overview") 추가. 폼에 "대략적인 출력 글자수"(TextField number, 100–5000, helperText "100–5000")와 "출력관점"(TextField, placeholder 예시) 배치.
3. **pair_input·targets**: `handleRunChemiGeneration`에서 `parseBirthDateTime(birthDateTimeA/B)`로 birthA/birthB 구성, `timezone`·`perspective`·`maxChars`로 단일 target 구성. `ChemiGenerationRequest` 타입으로 입력 빌드.
4. **호출 및 결과**: "생성 실행" 버튼 추가. `useRunChemiGenerationMutation` 호출 후 `genData?.runChemiGeneration?.targets`를 "GraphQL 궁합 생성 결과" 카드에 표시(perspective, max_chars, result). 로딩(genLoading)·에러(genError) 처리.
5. **문서**: OperatorGuide.md §궁합 추출 테스트에 대략적인 출력 글자수·출력관점 폼, 생성 실행 사용법, targets[].max_chars·perspective 연동 명시. §궁합 추출 기본 메소드에 화면 연동 문단 추가. CheckList.md 해당 항목 완료 표시(- [x]).

**Status**: 완료. API 코드 변경 없음. admweb 린트 에러 없음.

**Verification**: 수동 검증 권장 — 궁합 추출 테스트 탭에서 max_chars·perspective 변경 후 "생성 실행" 클릭, GraphQL 궁합 생성 결과 카드에 result 표시 여부 확인. API 테스트·빌드는 본 작업에서 API 수정이 없어 생략 가능; 필요 시 `cd api && make test-itemncard` 및 `go build` 실행.
