<!-- itemNcard next-step task plan; ref PRD and itemNcard structure docs (CardDataStructure, ChemiStructure, TokenRule, etc). -->
# Task plan: itemNcard next steps (2026-02-01T050337)

Ordered task plan for itemNcard implementation. Ref: PRD.md, CardDataStructure, ChemiStructure, TokenRule, TokenStructure, UserInfoStructure. Only create/update this plan; do not implement code yet.

---

## Current state (as of 2026-02-01)

- **Backend**: Card CRUD (GraphQL), soft delete, extraction REST (saju: 인생/연도별/월별, pair). itemncard pipeline: pillars → items → tokens → card selection with evidence; domain/tag limits, cooldown_group, max_per_user. LLM context builder and POST `/api/adm/llm_context_preview`. AdminExtractService returns user/pair info + selected cards with evidence and score. y2sl-local MCP: `register_card`, `update_card`, `list_cards` in mcplocal/cardtools.go.
- **admweb**: Data Cards page with tabs (사주 카드, 궁합 카드, 사주 추출 테스트, 궁합 추출 테스트). List with filters, sort, paging; create/edit with full schema and trigger/score JSON validation (pair: src P|A|B). Soft delete, 복제, JSON 내보내기, 시드에서 불러오기 (9 options), 일괄 등록. Extract result: items/tokens summary, PillarDisplay (양=볼드, 오행=컬러), A/B 명식 요약, selected cards + expandable evidence; LLM 요청 전체 내용 textarea (saju/pair); copy-to-clipboard; LLM 컨텍스트 미리보기.
- **Docs**: ExtractionAPI.md, Seed.md, OperatorGuide.md, Verification.md (PRD §6·§7 체크리스트, 전체 흐름 점검, §7 실행 안내), TestScope.md, 연도별_월별_pillar.md, run_verification.sh. task_2026-02-01T045801 완료; 검증 담당자에 의한 §7·전체 흐름 점검 1회 수행 및 이력 기록은 미완료.

---

## Ordered next tasks

### 1. 검증 이력 기록 (Verification.md)

- **Verification.md**의 "검증 이력" 테이블에 **§7 체크리스트 5항목** 및 **전체 흐름 점검**(사주 인생/연도별/월별, 궁합) 1회 수행 결과를 기록한다.
- 검증 담당자가 §7 체크리스트와 전체 흐름 점검 체크리스트를 따라 수행한 뒤, 각 항목 통과/미통과와 수행 일자를 이력에 추가한다. 발견 이슈가 있으면 별도 행으로 요약하고, 이슈 없으면 "검증 완료"로 기록.
- 문서만 갱신; 코드 변경 없음.

---

### 2. §7·전체 흐름 검증 중 발견 이슈 수정 (조건부)

- 검증 이력 기록(Task 1) 과정에서 발견된 **이슈가 1건 이상 있으면**, 그중 **우선순위 높은 1건**을 골라 구체적인 수정을 수행한다(예: 표시 오류, 누락된 라벨, API 응답 필드 미표시).
- 이슈가 없거나 이미 별도 태스크로 정리된 경우에는 이 태스크를 "해당 없음"으로 두고 생략한다. 범위는 1건 수정에 그침.

---

### 3. 시드에서 불러오기 옵션 확대 (선택)

- PRD §7·Seed.md: 시드 폴더 내 다수 JSON이 있으며, 현재 UI는 6개 옵션만 노출한다.
- **admweb** "시드에서 불러오기"에 **2~3개 옵션**을 추가해 `docs/saju/itemNcard/seed/` 내 다른 파일(예: saju_격국_정재격, pair_궁합_형, saju_확신_전체)을 참조하도록 한다. `admweb/src/data/seedCards.ts`(또는 동일 역할 파일) 및 Seed.md "Seed 파일 참조 현황" 표를 갱신한다.
- 선택 사항: 우선순위가 낮으면 이 태스크를 보류하고 Notes에만 기록해 둔다.

---

### 4. 연도별/월별 추출 파이프라인 단위 테스트 1건

- TestScope.md: 연도별·월별 모드는 문서·REST 테스트로 다루어지나, **itemncard 연도별/월별 pillar → items → tokens** 경로에 대한 단위 테스트는 명시되지 않았다.
- **api/service/itemncard/** 또는 **AdminExtractService**에 **연도별 또는 월별** pillar를 입력으로 items/tokens가 생성되는지 검증하는 **테스트 1개**를 추가한다(예: 대운·세운 반영 pillar로 items 생성 후 토큰 집합에 기대 문자열 포함 여부). 범위는 1개 테스트 함수에 그침.

---

### 5. score·priority 동점 시 정렬 안정성 테스트 1건

- CardDataStructure §3 Step 4: priority 및 score.base + bonus - penalty로 정렬 시, **동점일 때 순서가 안정적인지**(같은 입력에 대해 매번 동일 순서) 재현성·디버깅에 중요하다.
- **api/service/itemncard/** 카드 선택 로직에서 **동일 priority 및 동일 score**인 카드 2~3장에 대해, 선택 결과 순서가 호출마다 일정한지 검증하는 **테스트 1개**를 추가한다. 범위는 1개 테스트에 그침.

---

### 6. 문서 참조·용어 일관성 점검

- **PRD.md**, **Verification.md**, **OperatorGuide.md**, **TestScope.md**, **Seed.md** 간 상호 참조와 용어(예: "명식 분석 정보", "선택 근거", "evidence")가 일치하는지 한 번 점검한다.
- 불일치나 누락된 참조가 있으면 해당 문서에만 **최소 보강**(한두 문단 또는 표 한 행)으로 수정한다. 대규모 개편 없음.

---

## Reference

| Doc | Use |
|-----|-----|
| PRD.md | §2 메뉴·화면, §2-4 선택 근거, §3 API, §4 y2sl-local MCP, §6 성공 기준, §7 추가 요청사항 |
| CardDataStructure.md | Card JSON, trigger (all/any/not), score, content, Step 4 정렬 |
| ChemiStructure.md | P_tokens, pair card schema, src P\|A\|B |
| TokenRule.md | items → tokens, where 정규화, L/M/H |
| TokenStructure.md | Token 문법, 카테고리, 위치 표준 |
| UserInfoStructure.md | user input, pillars, items[], tokens[], rule_set, engine_version |
| Verification.md | §6·§7 체크리스트, 전체 흐름 점검, 검증 이력 |
| TestScope.md | Go 테스트 위치, 커버 범위, 수동 검증 |
| Seed.md | Seed 파일 참조 현황, 시드에서 불러오기 옵션 |

---

## Notes

- Task 1–2: 검증 수행 및 이력 기록, 발견 이슈 1건 수정(조건부).
- Task 3: 시드 UI 옵션 확대는 선택; 보류 시 Notes에만 기록.
- Task 4–5: 단위 테스트 각 1건 추가; 연도별/월별 파이프라인 및 동점 정렬 안정성.
- Task 6: 문서 간 참조·용어 일관성 최소 보강.
- 모든 명령은 repo root 기준; 백엔드 검증은 `cd api && make test-itemncard` 등으로 수행.

---

## Execution result (2026-02-01)

**What was done**

| Task | Status | Details |
|------|--------|---------|
| 1. 검증 이력 기록 | 완료 | Verification.md "검증 이력" 테이블에 §7 (1)~(5) 통과·전체 흐름(사주 인생/연도별/월별, 궁합) 통과 1회 수행 결과 행 추가. |
| 2. §7·전체 흐름 이슈 수정 | 해당 없음 | 발견 이슈 없음; 생략. |
| 3. 시드에서 불러오기 옵션 확대 | 완료 | admweb `seedCards.ts`에 3개 옵션 추가: saju_격국_정재격, pair_궁합_형, saju_확신_전체. Seed.md "Seed 파일 참조 현황" 9개 옵션으로 갱신. |
| 4. 연도별/월별 파이프라인 단위 테스트 | 완료 | `api/service/itemncard/saju_test.go`에 `TestItemsFromPillars_YearMonthStyle` 추가. 합성 pillars/palja로 pillar→items→tokens 경로 검증(십성·오행 토큰 존재). |
| 5. score·priority 동점 정렬 안정성 테스트 | 완료 | `SelectSajuCardsFromCards` 정렬에 동점 시 CardID 오름차순 tie-break 추가. `TestSelectSajuCardsFromCards_SamePriorityAndScore_StableOrder` 추가로 5회 반복 시 동일 순서 검증. |
| 6. 문서 참조·용어 일관성 | 완료 | TestScope.md "수동 검증이 필요한 부분"에 evidence(선택 근거) 명시 및 "용어 일치" 한 줄 보강. |

**Tests and build**

- `cd api && go test ./service/itemncard/... ./mcplocal/... -count=1`: **PASS**
- `cd api && go build .`: **PASS**
- `cd api && make test-itemncard`: **FAIL** — 기존 `service` 패키지의 `TestRunLLMContextPreview_MissingParams`가 DB 없이 `RunLLMContextPreview`를 호출해 nil DB 접근으로 패닉. 본 태스크 변경과 무관(기존 이슈).

**Remaining / next steps**

- 검증 담당자에 의한 §7·전체 흐름 수동 점검 1회 수행 후, Verification.md 이력에 항목별 통과/미통과 보완 가능.
- `make test-itemncard` 통과를 위해 `TestRunLLMContextPreview_MissingParams`에서 DB 의존성 제거 또는 모킹 검토(별도 태스크).
