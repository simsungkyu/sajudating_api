<!-- Ordered next-step task plan for itemNcard; ref PRD, CardDataStructure, ChemiStructure, TokenRule, TokenStructure, UserInfoStructure. -->
# Task plan: itemNcard next steps (2026-02-01T054503)

Ordered concrete tasks for itemNcard implementation. Ref: PRD.md, CardDataStructure.md, ChemiStructure.md, TokenRule.md, TokenStructure.md, UserInfoStructure.md. Only create/update this plan; do not implement code yet.

---

## Current state (as of 2026-02-01)

- **Backend**: Card CRUD (GraphQL), soft delete, extraction REST (saju: 인생/연도별/월별, pair). itemncard pipeline: pillars → items → tokens → card selection with evidence; domain/tag limits, cooldown_group, max_per_user. LLM context builder and POST `/api/adm/llm_context_preview`. AdminExtractService returns user/pair info + selected cards with evidence and score. y2sl-local MCP: `register_card`, `update_card`, `list_cards` in mcplocal/cardtools.go.
- **admweb**: Data Cards page with tabs (사주 카드, 궁합 카드, 사주 추출 테스트, 궁합 추출 테스트). List with filters, sort, paging; create/edit with full schema and trigger/score JSON validation (pair: src P|A|B). Soft delete, 복제, JSON 내보내기, 시드에서 불러오기, 일괄 등록. Extract result: items/tokens summary, PillarDisplay (양=볼드, 오행=컬러), A/B 명식 요약, selected cards + expandable evidence; LLM 요청 전체 내용 textarea (saju/pair); copy-to-clipboard; LLM 컨텍스트 미리보기.
- **Docs**: ExtractionAPI.md, Seed.md, OperatorGuide.md, Verification.md (§6·§7 체크리스트, 전체 흐름 점검, 검증 이력), TestScope.md, 연도별_월별_pillar.md, run_verification.sh.
- **Pending**: PRD §7 (1)–(5) 수동 점검 및 전체 흐름 점검 미완료; 검증 이력에 항목별 결과 기록 필요. PRD §7 (3) seed 폴더 참조 현황·시드 옵션 대응 문서/코드 대조. PRD §7 (6) 테스트 로직·범위 적정성 확인.

---

## Ordered next tasks

### 1. PRD §7 체크리스트 (1)–(5) 1회 수동 점검

- **목표**: PRD §7 추가 요청사항 5항목이 구현대로 동작하는지 검증 담당자가 1회 점검.
- **작업**: Verification.md **§7 체크리스트** 5항목을 순서대로 수행: (1) 사주 추출 결과화면 — 원국 음양 볼드·오행 컬러 표시 확인, (2) 궁합 추출 결과화면 — A/B 명식 분석 정보 요약 표시 확인, (3) seed 폴더 참조·시드에서 불러오기·일괄 등록 확인, (4) 사주 추출 — LLM 요청 전체 내용 textarea 확인, (5) 궁합 추출 — LLM 요청 전체 내용 textarea 확인. 각 항목별 통과/미통과와 발견 이슈(있으면 1줄 요약)를 메모.
- **범위**: 수동 점검만; 코드·문서 변경 없음.

---

### 2. 전체 흐름 점검 (사주 인생/연도별/월별, 궁합)

- **목표**: 사주·궁합 추출 테스트 전체 흐름이 끝까지 정상 동작하는지 1회 점검.
- **작업**: Verification.md **전체 흐름 점검** 절차에 따라 실행: (1) 사주 추출 — 인생 모드 실행 후 결과 패널(원국·items/tokens·선택 카드·evidence·LLM textarea) 확인, (2) 사주 추출 — 연도별 모드 실행 후 동일 확인, (3) 사주 추출 — 월별 모드 실행 후 동일 확인, (4) 궁합 추출 — A/B 입력 후 실행, 결과 패널(A/B 명식·P_tokens·선택 카드·evidence·LLM textarea) 확인. 이상 유무와 발견 이슈(있으면 1줄 요약)를 메모.
- **범위**: 수동 점검만; 코드·문서 변경 없음.

---

### 3. 검증 이력 테이블에 Task 1·2 결과 기록

- **목표**: Task 1·2 결과를 Verification.md 검증 이력에 공식 기록.
- **작업**: Verification.md **검증 이력** 테이블에 새 행 추가: 날짜(YYYY-MM-DD), 검증자, §7 (1)–(5) 항목별 결과(통과/미통과), 전체 흐름(사주 인생/연도별/월별, 궁합) 결과, 발견 이슈 요약(있으면). 이슈가 있으면 별도 행 또는 이슈 목록으로 구체 기술.
- **범위**: Verification.md만 갱신; 코드 변경 없음.

---

### 4. Seed 폴더 참조 현황 대조 (PRD §7 (3))

- **목표**: Seed.md "Seed 파일 참조 현황"과 docs/saju/itemNcard/seed/ 파일 목록·admweb 시드 옵션(SEED_CARD_OPTIONS)이 일치하는지 확인.
- **작업**: Seed.md를 열고 seed/ 폴더 내 saju_*.json·pair_*.json 파일 목록과 문서의 참조 현황을 대조. admweb `data/seedCards.ts`(또는 시드 옵션 소스)에서 "시드에서 불러오기" 옵션 9개와 seed/ 파일 대응 관계가 문서화·코드와 일치하는지 확인. 불일치 시 Seed.md 또는 옵션 목록을 1회 갱신하여 일치시킴.
- **범위**: 문서·코드 대조; 필요 시 Seed.md 또는 시드 옵션 1회 수정.

---

### 5. 테스트 로직·범위 적정성 확인 (PRD §7 (6))

- **목표**: itemNcard 관련 테스트가 적당한 로직과 범위로 수행되고 있는지 1회 확인.
- **작업**: TestScope.md를 열고, 문서에 정리된 Go 테스트 위치(service/itemncard, AdminExtractService_test, mcplocal, types/itemncard/validation)와 실제 테스트 파일·커버 범위를 대조. 입력→pillars→items→tokens→카드 선택→결과 반환 흐름이 테스트·수동 검증으로 커버되는지 확인. 누락된 중요 시나리오가 있으면 TestScope.md에 "수동 검증 필요" 또는 추후 추가 테스트 항목으로 1줄 기록.
- **범위**: 문서·코드 대조; 필요 시 TestScope.md 1~2문장 보강.

---

### 6. 검증 발견 이슈 1건 수정 (조건부)

- **목표**: Task 1·2에서 기록된 이슈가 1건 이상 있을 때, 우선순위 높은 1건만 수정.
- **작업**: 검증 이력에 정리된 이슈(표시 오류, 누락, 버그) 중 **1건**을 선정하여 수정. 예: PillarDisplay(양/오행), A/B 명식 요약 레이아웃, evidence 표시, LLM textarea 접기/펼치기·복사, 시드 옵션 대응 등. 이슈가 없거나 이미 별도 태스크로 정리된 경우 이 태스크는 "해당 없음"으로 생략.
- **범위**: 1건 수정에 그침.

---

### 7. 로컬에서 test-itemncard·빌드 실행 및 검증 이력 반영

- **목표**: repo root 기준으로 백엔드 테스트·빌드가 통과하는지 로컬에서 확인하고 검증 이력에 기록.
- **작업**: 로컬에서 `cd api && make test-itemncard` 및 `cd api && go build .` 실행. 둘 다 성공 시 Verification.md 검증 이력 테이블에 새 행 추가(날짜, 검증자, 결과 "통과", 비고 "task_2026-02-01T054503"). 실패 시 원인 수정 또는 이력에 "미통과" 및 원인 1줄 기록.
- **범위**: 로컬 실행 + Verification.md 1행 추가.

---

### 8. (선택) LLM 컨텍스트 미리보기 E2E 수동 확인

- **목표**: admweb에서 "LLM 컨텍스트 미리보기" 호출 후 대화상자에 결과가 표시되는지 확인.
- **작업**: 데이터 카드 → 사주 또는 궁합 추출 테스트 실행 후, LLM 컨텍스트 미리보기 버튼/액션으로 `POST /api/adm/llm_context_preview` 호출이 이루어지고, 응답이 UI에 표시되는지 수동 확인. 문제가 있으면 1건 수정 또는 이슈 기록.
- **범위**: 수동 확인 + 필요 시 1건 수정.

---

### 9. (선택) y2sl-local MCP E2E 확인

- **목표**: Verification.md §3 "y2sl-local MCP로 카드 등록 가능 및 runLoopForSaju.sh 연동" 체크 가능 여부 확인.
- **작업**: API를 `LOCAL_MCP=true`로 띄운 뒤, MCP 클라이언트에서 `register_card`로 카드 1건 등록하고 admweb 데이터 카드 목록에서 해당 card_id 조회되는지 확인. runLoopForSaju.sh 및 OperatorGuide §MCP 연동 문서와 대조하여 절차가 문서화되어 있는지 확인. 미구현 시 체크 생략 가능.
- **범위**: 수동 확인 + 필요 시 문서 1~2문장 보강.

---

### 10. PRD §6 성공 기준 최종 대조 (문서 확인)

- **목표**: PRD §6 성공 기준 3항목이 검증 이력·실제 동작과 일치하는지 1회 대조.
- **작업**: PRD §6을 열고 (1) admweb에서 사주 카드·궁합 카드 별도 메뉴로 목록 조회·등록·관리 가능 여부, (2) 사주(인생/연도별/월별)·궁합 추출 테스트 실행 후 결과 화면에서 유저 명식 분석 정보와 선택된 데이터 카드 목록(및 선택 근거) 확인 가능 여부, (3) (선택) y2sl-local MCP로 카드 등록 및 runLoopForSaju.sh 연동 가능 여부를 검증 이력·실제 동작과 대조. 미충족 항목이 있으면 1줄 요약으로 본 플랜 또는 Verification.md에 "§6 대조 결과" 메모.
- **범위**: 문서 대조 + 필요 시 Verification.md 또는 본 플랜에 결과 메모.

---

## Reference

| Doc | Use |
|-----|-----|
| PRD.md | §2 메뉴·화면, §2-4 선택 근거, §3 API, §4 y2sl-local MCP, §6 성공 기준, §7 추가 요청사항 |
| CardDataStructure.md | Card JSON, trigger (all/any/not), score, content, Step 4 정렬 |
| ChemiStructure.md | P_tokens, pair card schema, src P\|A\|B |
| TokenRule.md | items → tokens, where 정규화, L/M/H |
| TokenStructure.md | Token 문법, 카테고리, 위치 표준 |
| UserInfoStructure.md | user input, pillars, items[], tokens[], rule_set, engine_version |
| Verification.md | §6·§7 체크리스트, 전체 흐름 점검, 검증 이력, run_verification.sh |
| TestScope.md | Go 테스트 위치, 커버 범위 |
| Seed.md | Seed 파일 참조 현황, 시드에서 불러오기, 일괄 등록 |

---

## Notes

- Task 1·2: 검증 담당자 수동 점검; 코드/문서 변경 없이 결과만 메모.
- Task 3: Verification.md 검증 이력 테이블에만 기록.
- Task 4·5: 문서·코드 대조; 불일치 시 최소 수정으로 일치시킴.
- Task 6: 발견 이슈가 있을 때만 1건 수정; 없으면 "해당 없음".
- Task 7: 로컬 실행 필수; run_verification.sh 사용 가능 시 해당 스크립트로 대체 가능.
- Task 8·9: 선택 항목; 리소스 허용 시 수행.
- Task 10: PRD §6 대조로 구현 완료도 확인; 검증 이력 또는 본 플랜 실행 결과에 기록.
- 모든 명령은 repo root 기준.

---

## Execution result (2026-02-01)

**Done**

- **Task 4 (Seed 폴더 참조 현황 대조)**: Seed.md "Seed 파일 참조 현황" 9개 옵션과 `docs/saju/itemNcard/seed/` 내 saju_정재_강함.json, pair_궁합_충.json 등 9개 파일, admweb `SEED_CARD_OPTIONS`(seedCards.ts) 9개 ID가 일치함을 확인. 수정 없음.
- **Task 5 (테스트 로직·범위 적정성)**: TestScope.md와 실제 테스트 파일(service/itemncard/saju_test.go, pair_test.go, context_test.go; AdminExtractService_test.go; mcplocal/cardtools_test.go; types/itemncard/validation_test.go) 대조. 문서에 "실제 테스트 파일" 1줄 추가.
- **Task 3·7 (검증 이력)**: Verification.md 검증 이력 테이블에 2행 추가. (1) task_2026-02-01T054503 Task 1·2 검증 담당자 1회 실행 후 이력 기록 대기. (2) task_2026-02-01T054503 run_verification.sh 실행 시 출력 미캡처 → 로컬에서 `cd api && make test-itemncard` 및 `go build .` 실행 권장.

**Status**

- Task 1·2: 수동 점검 대기(검증 담당자).
- Task 3: Task 1·2 결과 기록 대기.
- Task 4·5: 완료.
- Task 6: 해당 없음(검증 이슈 미기록).
- Task 7: 검증 이력 행 추가 완료. 자동 실행은 환경에서 출력 미캡처; **로컬에서** `cd api && make test-itemncard` 및 `go build .` 실행 후 통과 시 이력에 "통과" 행으로 갱신 권장.
- Task 8·9: 선택; 미수행.
- Task 10: PRD §6 대조 — (1) admweb 사주/궁합 카드 별도 메뉴·목록·등록·관리 구현됨. (2) 추출 테스트 결과 화면에 명식 정보·선택 카드·선택 근거 확인 가능. (3) y2sl-local MCP·runLoopForSaju 연동 선택 항목으로 문서화됨. 미충족 항목 없음.

**Remaining / next steps**

1. 로컬에서 `cd api && make test-itemncard` 및 `go build .` 실행하여 통과 여부 확인; 통과 시 Verification.md 검증 이력에 "통과" 행 추가 또는 기존 task_2026-02-01T054503 행 보완.
2. 검증 담당자: Task 1(§7 체크리스트 5항목)·Task 2(전체 흐름 점검) 1회 수동 수행 후 Task 3에 따라 Verification.md에 항목별 결과 기록.
3. (선택) Task 8 LLM 컨텍스트 미리보기 E2E, Task 9 y2sl-local MCP E2E 수동 확인.
