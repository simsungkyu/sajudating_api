# Task plan: 일간 사주 추출 + 대운·세운·월간·일간 추출시 연계 만세력 확인 (2026-02-01T153658)

Single-item plan chosen from **docs/saju/itemNcard/CheckList.md** (remaining incomplete item):

- [ ] **일간 사주 추출을 할수 있어야 한다. 대운, 세운, 월간, 일간 추출시 각각의 연계 만세력도 유저가 확인할수 있어야 한다.**

Ref: PRD.md §2-3·§2-4, ExtractionAPI.md, OperatorGuide.md §사주 추출 테스트·§연도별·월별 추출 상세, docs/saju/itemNcard/tasks/연도별_월별_pillar.md, UserInfoStructure.md, TokenRule.md.

---

## Scope (interpretation)

- **일간 사주 추출**: Add mode **일간** (日運) so the user can run saju extraction for a **specific day**. Pillar source: `(target_year, target_month, target_day)` + birth time (same sxtwl/PillarsFromBirth logic as 연도별/월별). API: `mode=일간`, `target_year`, `target_month`, `target_day`; response `period` e.g. `"2025-03-15"`.
- **연계 만세력**: For **each** extraction mode (인생, 연도별=세운, 월별=월운, 일간=일운; 대운 is future per 연도별_월별_pillar.md), the user must be able to **see which date/period produced the pillars** (기준일·기간 표시). So the response must expose a structured “pillar source” (기준일, 적용 시간, 모드 설명) and the admweb result panel must display it.

---

## Ordered tasks

### 1. Spec: Define 일간 mode and “연계 만세력” data

- **Goal**: Document request/response and pillar-source semantics so backend and frontend can implement consistently.
- **Work**: (a) In **ExtractionAPI.md** (or a short addendum): define **일간** mode — request fields `mode=일간`, `target_year`, `target_month`, `target_day` (all required for 일간); response `user_info.mode` = `"일간"`, `user_info.period` = `"YYYY-MM-DD"`. Pillar source: `(target_year, target_month, target_day)` + birth time via sxtwl (same as 연도별/월별: one calendar date + birth time for 日柱/时柱). (b) Define **연계 만세력** (pillar source) per mode: **인생** = birth date + birth time (원국); **연도별(세운)** = target year 1/1 + birth time; **월별(월운)** = target year-month 1st + birth time; **일간(일운)** = target full date + birth time; **대운** = TBD / future (document in 연도별_월별_pillar.md). (c) Add a single response block (e.g. `pillar_source` or `calendar_link`): `base_date` (YYYY-MM-DD), `base_time_used` (HH:mm or "unknown"), `mode`, `period`, optional short `description` (e.g. "원국", "歲運", "月運", "日運"). Update ExtractionAPI.md §1 request/response tables and add one subsection “연계 만세력 (pillar source)”.
- **Scope**: Docs only (ExtractionAPI.md, optionally 연도별_월별_pillar.md). No code.

---

### 2. Backend: Add 일간 mode to saju extraction

- **Goal**: API accepts `mode=일간` and target date; compute pillars for that date + birth time; return `user_info.mode` and `user_info.period` (YYYY-MM-DD).
- **Work**: (a) In **api/dto/itemncard_dto.go**: add `TargetDay string` to `SajuExtractTestRequest`; ensure `UserInfoSummary` comment/list includes `일간` and `period` for daily. (b) In **api/service/AdminExtractService.go**: in the mode switch, add case `"일간"`: if `req.TargetYear`, `req.TargetMonth`, `req.TargetDay` are present and valid, set `runY, runM, runD` to target date and `period` to `"YYYY-MM-DD"`; otherwise leave run date as birth date and period empty (or return 400). Reuse `itemncard.PillarsFromBirth(runY, runM, runD, hh, mm, timezone)`. (c) Add/update **AdminExtractService_test.go** for 일간: one test that sends `mode=일간` with target_year/month/day and asserts `user_info.mode` and `user_info.period` in response (and optionally pillars). (d) Update **api/dto** comments and **ExtractionAPI.md** if not done in task 1.
- **Scope**: api/dto/itemncard_dto.go, api/service/AdminExtractService.go, api/service/AdminExtractService_test.go. No frontend.

---

### 3. Backend: Add pillar_source (연계 만세력) to saju extraction response

- **Goal**: Every saju extraction response includes a structured “pillar source” so the UI can show “기준일: … (모드)” for each mode.
- **Work**: (a) In **api/dto/itemncard_dto.go**: add struct e.g. `PillarSource` with fields `BaseDate string` (YYYY-MM-DD), `BaseTimeUsed string` (HH:mm or "unknown"), `Mode string`, `Period string`, `Description string` (optional, e.g. "원국", "歲運", "月運", "日運"). Add field `PillarSource *PillarSource` to `SajuExtractTestResponse` (or embed in `UserInfoSummary` if preferred). (b) In **AdminExtractService.go**: after computing `runY, runM, runD` and `period`, build `PillarSource`: base_date = runY-runM-runD formatted, base_time_used = birth time or "unknown", mode, period, description from mode. Set it on the response. (c) Update **ExtractionAPI.md** §1 response: document `user_info.pillar_source` (or top-level `pillar_source`) with the new fields.
- **Scope**: api/dto/itemncard_dto.go, api/service/AdminExtractService.go, docs/saju/itemNcard/ExtractionAPI.md. No frontend.

---

### 4. admweb: Add 일간 mode to 사주 추출 테스트 UI

- **Goal**: User can select mode **일간** and enter target year, month, day; on run, request is sent with `mode=일간` and target_* and result is shown like other modes.
- **Work**: (a) In the 사주 추출 테스트 form (DataCardsPage or pages/datacards/): add **일간** to the mode selector (인생 / 연도별 / 월별 / 일간). (b) When mode is **일간**, show inputs for **대상 연도**, **대상 월**, **대상 일** (target_year, target_month, target_day); re-use existing target year/month UI pattern where possible (e.g. same field names, validation: year 4 digits, month 01–12, day 01–31). (c) On **실행**, include in the request body `mode: "일간"`, `target_year`, `target_month`, `target_day` when mode is 일간. (d) Result panel already shows `user_info.mode` and `user_info.period`; ensure 일간 result shows mode "일간" and period "YYYY-MM-DD". No change to card selection or LLM textarea logic.
- **Scope**: admweb 사주 추출 테스트 form and API call only (e.g. DataCardsPage.tsx, pages/datacards/*, itemncard_api if used). No backend change.

---

### 5. admweb: Show 연계 만세력 (pillar source) in result panel

- **Goal**: For every saju extraction (인생/연도별/월별/일간), the result panel displays the “연계 만세력” (기준일·기간) so the user can confirm which date produced the pillars.
- **Work**: (a) In the 사주 추출 테스트 **result panel**: read `pillar_source` (or equivalent) from the API response. (b) Display a short line or block, e.g. **연계 만세력**: 기준일 `base_date`, 적용 시간 `base_time_used`, 모드 `mode` / `period` (or `description`). Place it near the pillars or user_info (e.g. above or below PillarDisplay). (c) If the API does not yet return `pillar_source`, use fallback: show `user_info.period` and `user_info.mode` together as “기준 기간: {period} ({mode})” and “적용 시간: 출생시간” when available, so that 연계 만세력 is at least partially visible until task 3 is deployed. (d) Ensure copy-to-clipboard or summary text includes this “연계 만세력” line when present.
- **Scope**: admweb 사주 추출 테스트 result panel only. Depends on task 3 for full pillar_source; fallback in (c) allows UI to be done before or in parallel with backend.

---

### 6. Docs and optional 대운 placeholder

- **Goal**: OperatorGuide and pillar doc are up to date; 대운 is explicitly documented as future so the checklist “대운 … 만세력” has a clear follow-up.
- **Work**: (a) In **OperatorGuide.md** §사주 추출 테스트: add **일간** to the mode list (인생 / 연도별 / 월별 / **일간**). Add one short bullet: “일간: 특정 일자의 일운(日運)을 보고 싶을 때. 대상 연도·월·일을 입력.” and “결과의 연계 만세력: 기준일·적용 시간·모드를 결과 패널에서 확인.” (b) In **docs/saju/itemNcard/tasks/연도별_월별_pillar.md**: add one line under “Future: 大運” that “연계 만세력 표시는 대운 모드 추가 시 동일하게 기준 기간·날짜를 노출할 예정.” (c) Optional: if product agrees, add a single “대운” mode placeholder (API accepts mode=대운 but returns 501 or same as 인생 with a note) and UI shows “대운 (준비 중)” — only if scope is agreed; otherwise leave 대운 as doc-only future.
- **Scope**: OperatorGuide.md, 연도별_월별_pillar.md; optional backend/UI placeholder for 대운.

---

### 7. Verification and CheckList update

- **Goal**: Manually verify 일간 extraction and 연계 만세력 display; mark CheckList item complete or record issues.
- **Work**: (a) Run 사주 추출 테스트 in **인생**, **연도별**, **월별**, **일간** modes; for each, confirm result panel shows **연계 만세력** (기준일 또는 기준 기간 + 모드). (b) For **일간**: enter target year/month/day, run, confirm pillars and period "YYYY-MM-DD" and pillar source line. (c) If all pass, in **CheckList.md** set the item to `- [x]` and add a one-line completion note (e.g. "일간 모드 추가, 연계 만세력 결과 패널 표시 완료. 대운은 추후."). If any fail, leave `- [ ]` and add a short issue note or reference this task file for follow-up.
- **Scope**: Manual verification; CheckList.md update only.

---

## Summary

| Step | Description |
|------|-------------|
| 1 | Spec: Define 일간 mode and 연계 만세력 (pillar_source) in ExtractionAPI.md |
| 2 | Backend: Add 일간 mode to DTO and AdminExtractService; unit test |
| 3 | Backend: Add pillar_source to saju extraction response; document in ExtractionAPI.md |
| 4 | admweb: Add 일간 to mode selector and target day inputs; send request |
| 5 | admweb: Show 연계 만세력 (pillar source) in result panel for every mode |
| 6 | Docs: OperatorGuide + 연도별_월별_pillar.md; optional 대운 placeholder |
| 7 | Verification: Run all four modes, confirm 만세력 display; update CheckList.md |

---

## References

- **CheckList.md**: 일간 사주 추출 + 대운·세운·월간·일간 추출시 연계 만세력 확인.
- **ExtractionAPI.md**: §1 Saju extraction request/response; birth date/time rule.
- **연도별_월별_pillar.md**: 인생/연도별/월별 pillar source; 대운 future.
- **OperatorGuide.md**: 사주 추출 테스트, 연도별·월별 추출 상세.
- **PRD.md**: §2-3 추출 테스트 UI (모드: 인생/연도별/월별; 결과에 명식·선택 카드).

---

## Execution result (2026-02-01)

**Done:**

1. **Spec (Task 1)** — ExtractionAPI.md: Added **일간** mode (request `target_day`, response `period` YYYY-MM-DD). Added § "연계 만세력 (pillar source)" with `pillar_source` block (`base_date`, `base_time_used`, `mode`, `period`, `description`) and pillar source by mode (인생/연도별/월별/일간/대운 TBD).
2. **Backend 일간 (Task 2)** — api/dto/itemncard_dto.go: `TargetDay`, mode/period comments for 일간. api/service/AdminExtractService.go: case `"일간"` with target date validation (400 if missing/invalid), `period` = YYYY-MM-DD. AdminExtractService_test.go: `TestRunSajuExtractTest_IlganMode` (skips when 500/sxtwl or MongoDB unavailable), `TestRunSajuExtractTest_IlganModeMissingTarget` (400 when target date omitted).
3. **Backend pillar_source (Task 3)** — api/dto/itemncard_dto.go: `PillarSource` struct, `SajuExtractTestResponse.PillarSource`. AdminExtractService.go: build and set `PillarSource` (base_date, base_time_used, mode, period, description) on every saju extraction response. ExtractionAPI.md already updated in Task 1.
4. **admweb 일간 (Task 4)** — SajuExtractTestTab: mode selector includes **일간**; when 일간, inputs 대상 연도·대상 월·대상 일; payload sends `target_year`, `target_month`, `target_day`. itemncard_api.ts: `target_day` in payload type, `PillarSource` and `pillar_source` in response type.
5. **admweb 연계 만세력 (Task 5)** — Result panel shows **연계 만세력** block (기준일, 적용 시간, 모드/period, description) when `pillar_source` present; fallback to user_info.period/mode + "출생시간" when absent. Copy-to-clipboard includes 연계 만세력 line.
6. **Docs (Task 6)** — OperatorGuide.md: 일간 in mode list and §연도별·월별·일간 추출 상세 (필수 입력, 결과 기간, 연계 만세력). 연도별_월별_pillar.md: **일간 (日運)** bullet; Future 大運 paragraph: "연계 만세력 표시는 대운 모드 추가 시 동일하게 기준 기간·날짜를 노출할 예정."

**Status:** All 6 implementation tasks completed. `go vet ./service/` and `go build .` (from api/) succeed. Unit tests added; `TestRunSajuExtractTest_IlganMode` skips when sxtwl/MongoDB return 500. Manual verification: run 사주 추출 테스트 in 인생/연도별/월별/일간 and confirm 연계 만세력 in result panel; for 일간 confirm period YYYY-MM-DD and pillar source line.

**Remaining / next steps:** (1) Manually verify all four modes and 연계 만세력 display in admweb. (2) 대운 mode remains doc-only future (no API/UI placeholder). (3) CheckList.md item marked complete below.
