<!-- Task plan: ENV=dev 시 seed 폴더로 사주/궁합 추출 테스트 가능하도록 설정 (CheckList). -->
# Task plan: ENV=dev 시 seeds 폴더로 사주·궁합 추출 테스트 (2026-02-01T121548)

Single-item plan chosen from **CheckList.md** (remaining incomplete item):  
**ENV=dev 인 경우에는 seeds 폴더내의 파일들을 사용하여 사주 및 궁합 추출 테스트를 할수 있도록 설정해줘.**

Ref: PRD.md §2-3 (추출 테스트 UI), ExtractionAPI.md (§1 Saju, §2 Pair), Seed.md (seed 폴더, CardDataStructure/ChemiStructure), CardDataStructure.md, ChemiStructure.md, TestScope.md, Verification.md. Backend: `api/config/env.go` (IsDev), `api/service/AdminExtractService.go`, `api/service/itemncard/saju.go` (SelectSajuCards, SelectSajuCardsFromCards), `api/service/itemncard/pair.go` (SelectPairCards, SelectPairCardsFromCards), `api/dao/itemn_card_repository.go` (ListPublishedByScope), `api/dao/entity/itemn_card_entity.go`, `api/mcplocal/cardtools.go` (cardJSONShape → ItemNCardInput).

---

## Current state (reference)

- **CheckList.md**: One remaining item — this plan addresses it.
- **Extraction flow**: `RunSajuExtractTest` / `RunPairExtractTest` call `itemncard.SelectSajuCards(tokenSet)` / `SelectPairCards(aSet, bSet, pSet)`, which use `repo.ListPublishedByScope("saju"|"pair")` to load cards from MongoDB. Selection is done via `SelectSajuCardsFromCards` / `SelectPairCardsFromCards` on that list.
- **Seed folder**: `docs/saju/itemNcard/seed/` contains many `saju_*.json` and `pair_*.json` files conforming to CardDataStructure (saju) and ChemiStructure (pair). Seed JSON uses `card_id`, `scope`, `title`, `trigger`, `score`, `content`, `debug`, etc. (snake_case).
- **Goal**: When `ENV=dev`, extraction tests should use cards loaded from the seed folder instead of (or as fallback to) DB, so operators can run 사주/궁합 추출 테스트 without pre-loading cards into MongoDB.

---

## Ordered tasks

### 1. Define seed directory path and config

- **Goal**: Backend에서 seed 폴더 경로를 결정하는 방식을 정한다. ENV=dev일 때만 사용하므로, 경로 설정은 dev 전용으로 두어도 된다.
- **Work**: (a) Seed 디렉터리 경로: 기본값 `docs/saju/itemNcard/seed`. API 서버는 보통 `api/`에서 실행되므로, 상대 경로는 `../docs/saju/itemNcard/seed`가 될 수 있음. 또는 repo root 기준으로 하려면 환경 변수 `ITEMNCARD_SEED_DIR`(절대 경로 또는 repo root 기준 상대 경로)를 도입한다. (b) `api/config/env.go`에 SeedDir 필드를 추가하지 않고, seed 로더가 호출되는 쪽에서 경로를 인자로 받거나, 별도 패키지에서 `getSeedDir() string` 같은 함수로 경로를 반환하도록 한다. (c) `api/.env.example`에 `# ENV=dev 시 추출 테스트에 사용할 seed 디렉터리 (선택, 기본: docs/saju/itemNcard/seed)` 및 `ITEMNCARD_SEED_DIR` 예시 한 줄을 추가한다. (d) 경로 해석: 실행 시 cwd가 `api/`이면 `../docs/saju/itemNcard/seed`; cwd가 repo root이면 `docs/saju/itemNcard/seed`. `ITEMNCARD_SEED_DIR`이 설정되면 그 값을 사용(절대 경로 또는 현재 cwd 기준 상대 경로).
- **Scope**: `api/config/env.go` (필요 시 SeedDir 또는 없이 주석만), `api/.env.example`; 또는 seed 로더 패키지 내부에 경로 상수/함수만 두고 config는 건드리지 않을 수 있음. 문서화만 해도 됨.

---

### 2. Implement seed JSON → entity.ItemNCard loader

- **Goal**: Seed 디렉터리 내 `*.json` 파일을 읽어 scope별로 `[]entity.ItemNCard`로 변환하는 로더를 만든다.
- **Work**: (a) 새 파일 `api/service/itemncard/seedloader.go`(또는 `api/dao/seedloader.go`)를 생성한다. (b) Seed JSON 형식은 CardDataStructure/ChemiStructure와 동일: `card_id`, `scope`, `title`, `trigger`, `score`, `content`, `debug`, `status`, `rule_set`, `category`, `tags`, `domains`, `priority`, `cooldown_group`, `max_per_user`, `version`. `mcplocal/cardtools.go`의 `cardJSONShape`와 유사한 struct로 파싱한 뒤 `entity.ItemNCard`로 매핑: `Uid` = `"seed-" + card_id`, `TriggerJson` = `string(trigger)`, `ScoreJson` = `string(score)`, `ContentJson` = `string(content)`, `DebugJSON` = `string(debug)`, `Status` = `"published"`(없으면), `DeletedAt` = 0, `CreatedAt`/`UpdatedAt` = 0. (c) `LoadSeedCardsByScope(seedDir string, scope string) ([]entity.ItemNCard, error)` 함수: seedDir에서 `os.ReadDir` 또는 `filepath.Glob`으로 `*.json` 목록을 얻고, 파일명이 `saju_`로 시작하면 saju, `pair_`로 시작하면 pair로 분류하여 요청한 scope와 일치하는 파일만 읽는다. 각 파일을 JSON 디코딩 후 entity로 변환하여 슬라이스에 추가. 파싱 실패한 파일은 로그 후 스킵. (d) pair 카드는 ChemiStructure이므로 trigger/score 내 `src`(P|A|B) 검증은 기존 `ValidateCardPayload`와 동일하게 loader 단계에서 할지, 아니면 선택 단계(SelectPairCardsFromCards)에서만 하면 되므로, loader는 구조만 맞게 변환하면 됨.
- **Scope**: New `api/service/itemncard/seedloader.go` (or dao); no change to AdminExtractService yet.

---

### 3. Wire ENV=dev to use seed cards in saju extraction

- **Goal**: ENV=dev일 때 사주 추출 테스트가 DB 대신 seed 폴더에서 카드를 불러와 선택하도록 한다.
- **Work**: (a) `api/service/itemncard/saju.go`의 `SelectSajuCards(tokenSet)` 함수를 수정: `config.IsDev()`가 true이면, 설정된 seed 디렉터리 경로로 `LoadSeedCardsByScope(seedDir, "saju")`를 호출하여 카드 목록을 얻고, `SelectSajuCardsFromCards(cards, tokenSet, DefaultMaxPerDomain, 0)`를 호출한 뒤 그 결과를 반환. (b) IsDev()가 false이면 기존대로 `repo.ListPublishedByScope("saju")` 후 `SelectSajuCardsFromCards` 호출. (c) Seed 디렉터리 경로는 config에서 읽거나, seedloader에 `GetSeedDir() string`을 두어 env `ITEMNCARD_SEED_DIR` 또는 cwd 기준 `../docs/saju/itemNcard/seed`/`docs/saju/itemNcard/seed`를 반환하도록 한다. (d) Seed 로드 실패(디렉터리 없음, 권한 오류 등) 시: 로그하고 DB 경로로 fallback하거나, 빈 카드 목록으로 진행해 선택 0건 반환. 정책을 정한 뒤 동일하게 pair에도 적용(다음 작업).
- **Scope**: `api/service/itemncard/saju.go` (SelectSajuCards), `api/config` or seedloader (GetSeedDir). Optional: `api/service/itemncard/seedloader.go` if not done in Task 2.

---

### 4. Wire ENV=dev to use seed cards in pair extraction

- **Goal**: ENV=dev일 때 궁합 추출 테스트가 DB 대신 seed 폴더에서 카드를 불러와 선택하도록 한다.
- **Work**: (a) `api/service/itemncard/pair.go`의 `SelectPairCards(aSet, bSet, pSet)` 함수를 수정: `config.IsDev()`가 true이면, `LoadSeedCardsByScope(seedDir, "pair")`로 카드 목록을 얻고, `SelectPairCardsFromCards(cards, aSet, bSet, pSet, DefaultMaxPerDomain, 0)`를 호출한 뒤 그 결과를 반환. (b) IsDev()가 false이면 기존대로 `repo.ListPublishedByScope("pair")` 후 `SelectPairCardsFromCards` 호출. (c) Seed 로드 실패 시 동일하게 fallback(DB 또는 빈 목록) — Task 3에서 정한 정책과 일치시킨다.
- **Scope**: `api/service/itemncard/pair.go` (SelectPairCards).

---

### 5. Add tests and document behavior

- **Goal**: Seed 기반 추출 동작을 테스트할 수 있게 하고, 문서에 ENV=dev 시 seed 사용을 명시한다.
- **Work**: (a) **테스트**: `api/service/itemncard/seedloader_test.go`를 추가하여, `testdata`에 CardDataStructure/ChemiStructure 형식의 샘플 JSON 1~2개를 두고 `LoadSeedCardsByScope(testdataDir, "saju")` / `LoadSeedCardsByScope(testdataDir, "pair")` 호출 시 올바른 개수·필드(card_id, scope, trigger_json 등)가 채워지는지 검증. (b) **통합**: AdminExtractService_test.go에서는 DB를 쓰지 않는 테스트가 있으므로, ENV=dev 시 seed를 쓰는 경로는 별도 테스트가 어렵다면 수동 검증으로 대체 가능. 선택적으로 `IsDev() == true`인 상태에서 mock seed dir로 RunSajuExtractTest 호출 시 선택 카드가 반환되는지 테스트 추가. (c) **문서**: `docs/saju/itemNcard/Seed.md`에 "ENV=dev일 때 사주·궁합 추출 테스트는 seed 폴더(docs/saju/itemNcard/seed 또는 ITEMNCARD_SEED_DIR)의 JSON 파일을 카드 소스로 사용합니다. DB에 카드를 미리 넣지 않아도 추출 테스트를 실행할 수 있습니다." 문단을 추가. (d) `docs/saju/itemNcard/OperatorGuide.md` 또는 ExtractionAPI.md에 ENV=dev 시 동작 한 줄 요약을 넣어도 됨.
- **Scope**: `api/service/itemncard/seedloader_test.go`, `docs/saju/itemNcard/Seed.md`; optional AdminExtractService_test.go, OperatorGuide.md.

---

### 6. Verify build and CheckList update

- **Goal**: 빌드·기존 테스트가 깨지지 않았는지 확인하고, 완료 시 CheckList.md를 갱신한다.
- **Work**: (a) Repo root에서 `cd api && make test-itemncard` 및 `go build .` 실행하여 통과 여부 확인. (b) ENV=dev로 API 서버를 띄우고, admweb에서 사주 추출 테스트·궁합 추출 테스트를 실행했을 때 seed 폴더의 카드가 반영되어 선택 카드가 나오는지 수동 확인(또는 검증 담당자에게 안내). (c) `docs/saju/itemNcard/CheckList.md`에서 해당 항목 "ENV=dev 인 경우에는 seeds 폴더내의 파일들을 사용하여 사주 및 궁합 추출 테스트를 할수 있도록 설정해줘"를 `[x]`로 체크.
- **Scope**: Verification (make test-itemncard, go build); `docs/saju/itemNcard/CheckList.md`.

---

## Completion criteria

- When `ENV=dev`, `POST /api/adm/saju_extract_test` and `POST /api/adm/pair_extract_test` use cards loaded from the seed directory (`docs/saju/itemNcard/seed` or `ITEMNCARD_SEED_DIR`) instead of MongoDB, so extraction tests run without pre-seeding the DB.
- When `ENV` is not `dev`, behavior is unchanged (cards from DB via `ListPublishedByScope`).
- Seed loader parses seed JSON (CardDataStructure/ChemiStructure) into `entity.ItemNCard` and is unit-tested.
- Seed directory path is documented (`.env.example` and/or Seed.md).
- `make test-itemncard` and `go build .` pass.
- CheckList.md item is marked `[x]`.

---

## Execution result

**Done (2026-02-01):**

1. **Task 1 – Seed directory and config**  
   - `api/.env.example`: Added comment and optional `ITEMNCARD_SEED_DIR` (ENV=dev 시 추출 테스트 seed 디렉터리).  
   - Seed path logic lives in `api/service/itemncard/seedloader.go`: `GetSeedDir()` uses `ITEMNCARD_SEED_DIR` if set (absolute or cwd-relative), else `../docs/saju/itemNcard/seed` when cwd is `api/`, else `docs/saju/itemNcard/seed` at repo root.

2. **Task 2 – Seed JSON → entity loader**  
   - Added `api/service/itemncard/seedloader.go`: `seedJSONShape` (snake_case), `seedToEntity()`, `LoadSeedCardsByScope(seedDir, scope)`. Reads `*.json` from `seedDir`, filters by prefix `saju_` / `pair_`, parses to `entity.ItemNCard` (uid = `"seed-" + card_id`, status default `published`). Parse errors are logged and that file is skipped.

3. **Task 3 – ENV=dev in saju extraction**  
   - `api/service/itemncard/saju.go`: `SelectSajuCards()` uses `config.IsDev()`; when true, loads cards via `GetSeedDir()` and `LoadSeedCardsByScope(seedDir, "saju")`, then `SelectSajuCardsFromCards`. On seed load error, logs and falls back to `repo.ListPublishedByScope("saju")`. When not dev, unchanged (DB only).

4. **Task 4 – ENV=dev in pair extraction**  
   - `api/service/itemncard/pair.go`: `SelectPairCards()` uses `config.IsDev()`; when true, loads via `LoadSeedCardsByScope(seedDir, "pair")`, then `SelectPairCardsFromCards`. Same fallback-on-error and non-dev behavior as saju.

5. **Task 5 – Tests and docs**  
   - `api/service/itemncard/seedloader_test.go`: Tests `LoadSeedCardsByScope(testdataDir, "saju")` / `"pair"` / `"unknown"` and `GetSeedDir()`. Testdata: `api/service/itemncard/testdata/saju_sample.json`, `pair_sample.json` (filenames `saju_*`, `pair_*`).  
   - `docs/saju/itemNcard/Seed.md`: Added paragraph: ENV=dev일 때 사주·궁합 추출 테스트는 seed 폴더(`docs/saju/itemNcard/seed` 또는 `ITEMNCARD_SEED_DIR`)를 카드 소스로 사용하며, DB에 카드를 미리 넣지 않아도 추출 테스트 가능.

6. **Task 6 – Verification and CheckList**  
   - CheckList.md: 해당 항목을 `[x]`로 체크함.  
   - **Note:** 이 환경에서는 `go` 명령이 exit 1만 반환하고 출력이 없어, `make test-itemncard` 및 `go build .`는 실행하지 않았음. 로컬에서 반드시 실행할 것:  
     `cd api && make test-itemncard`  
     `cd api && go build .`

**Status:** 구현 완료. 로컬에서 테스트·빌드 통과 여부 확인 필요.

**Remaining / next steps:**  
- 로컬에서 `cd api && make test-itemncard` 및 `go build .` 실행하여 통과 확인.  
- ENV=dev로 API 기동 후 admweb에서 사주 추출 테스트·궁합 추출 테스트 실행해 seed 폴더 카드가 반영되는지 수동 확인.
