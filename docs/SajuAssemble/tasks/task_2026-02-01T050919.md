<!-- itemNcard next-step task plan; ref PRD and itemNcard structure docs (CardDataStructure, ChemiStructure, TokenRule, etc). -->
# Task plan: itemNcard next steps (2026-02-01T050919)

Ordered task plan for itemNcard implementation. Ref: PRD.md, CardDataStructure, ChemiStructure, TokenRule, TokenStructure, UserInfoStructure. Only create/update this plan; do not implement code yet.

---

## Current state (as of 2026-02-01)

- **Backend**: Card CRUD (GraphQL), soft delete, extraction REST (saju: 인생/연도별/월별, pair). itemncard pipeline: pillars → items → tokens → card selection with evidence; domain/tag limits, cooldown_group, max_per_user. LLM context builder and POST `/api/adm/llm_context_preview`. AdminExtractService returns user/pair info + selected cards with evidence and score. y2sl-local MCP: `register_card`, `update_card`, `list_cards` in mcplocal/cardtools.go.
- **admweb**: Data Cards page with tabs (사주 카드, 궁합 카드, 사주 추출 테스트, 궁합 추출 테스트). List with filters, sort, paging; create/edit with full schema and trigger/score JSON validation (pair: src P|A|B). Soft delete, 복제, JSON 내보내기, 시드에서 불러오기 (9 options), 일괄 등록. Extract result: items/tokens summary, PillarDisplay (양=볼드, 오행=컬러), A/B 명식 요약, selected cards + expandable evidence; LLM 요청 전체 내용 textarea (saju/pair); copy-to-clipboard; LLM 컨텍스트 미리보기.
- **Docs**: ExtractionAPI.md, Seed.md (9 시드 옵션, 미참조 파일 정리), OperatorGuide.md, Verification.md (§6·§7 체크리스트, 전체 흐름 점검, 검증 이력·항목별 템플릿), TestScope.md (연도별/월별·동점 정렬 테스트 반영), 연도별_월별_pillar.md, run_verification.sh. task_2026-02-01T050919 실행 완료; **Remaining**: 검증 담당자에 의한 §7·전체 흐름 수동 점검 1회 후 이력 보완.

---

## Ordered next tasks

### 1. make test-itemncard 통과 — TestRunLLMContextPreview DB 의존성 제거

- **목표**: `cd api && make test-itemncard`가 MongoDB 없이 통과하도록 수정.
- **원인**: `AdminExtractService_test.go`의 `TestRunLLMContextPreview_MissingParams`가 `RunLLMContextPreview`를 호출할 때 핸들러 내부에서 DB를 사용하여 nil 접근 패닉 발생.
- **작업**: `RunLLMContextPreview`가 "필수 파라미터 누락" 등 유효하지 않은 요청에 대해서는 **DB 접근 전에** 4xx 응답을 반환하도록 분기 추가하거나, 해당 테스트에서 DB를 사용하지 않는 요청(예: body 누락)만 검증하도록 테스트를 조정. 범위는 이 한 가지 실패 원인 해소에 한정.

---

### 2. Seed 참조 확인 및 문서 정리

- **목표**: PRD §7 (3) "seed 폴더 내의 파일들이 참조되는지 확인 필요" 충족.
- **작업**: `docs/saju/itemNcard/seed/` 폴더의 JSON 파일 목록과 Seed.md "Seed 파일 참조 현황"·"미참조 파일 카테고리별 정리"를 대조하여, 시드에서 불러오기 9개 옵션 및 일괄 등록 경로가 문서와 일치하는지 확인. 불일치(파일 추가/삭제로 인한 누락)가 있으면 Seed.md 표를 한두 행 갱신. 이미 문서화된 "일괄 등록으로 나머지 시드 파일 불러오기" 설명이 Verification §7 (3) 체크에 부합하는지 문구만 보강해도 됨. 코드 변경은 불필요 시 생략.

---

### 3. 검증 이력 보완 (문서)

- **목표**: Verification.md "검증 이력" 테이블에 검증 담당자 수행 결과를 항목별로 보완 가능하게 유지.
- **작업**: Verification.md의 "검증 이력" 섹션에, §7 (1)~(5) 및 전체 흐름(사주 인생/연도별/월별, 궁합)을 **항목별** 통과/미통과로 기록할 수 있는 행 또는 주석용 템플릿 한 줄을 추가. 검증 담당자가 수동 점검 후 각 항목을 체크했을 때 붙여넣기 편한 형식으로. 문서만 갱신.

---

### 4. runLoopForSaju.sh·MCP 연동 문서화 (선택)

- **목표**: PRD §4 "runLoopForSaju.sh 등에서 agent가 해당 MCP를 사용하도록 프롬프트/설정 참조" 및 Verification §3 (선택) 항목 지원.
- **작업**: OperatorGuide.md에 "MCP 연동" 섹션을 추가하거나, `runLoopForSaju.sh` 상단 주석(또는 docs/saju/itemNcard 내 짧은 문서)에 **y2sl-local MCP** `register_card`, `update_card` 호출 방법과 카드 JSON 전달 방식(시드 파일 경로, 예시 payload)을 한 블록으로 정리. 구현이 아닌 문서만. 선택 사항이므로 우선순위 낮으면 Notes에만 기록.

---

### 5. 추출 API 오류 처리 점검

- **목표**: 잘못된 입력 시 4xx 응답 및 admweb 에러 표시가 명확한지 확인.
- **작업**: 사주 추출 테스트 API(인생/연도별/월별) 및 궁합 추출 테스트 API에 **필수 필드 누락**(예: birth 없음), **잘못된 형식**(예: 날짜/모드 오타) 요청을 보냈을 때 백엔드가 4xx와 에러 메시지를 반환하는지 확인. admweb에서 해당 응답 시 사용자에게 에러 메시지가 표시되는지 확인. **1건**이라도 누락(예: 500 또는 빈 응답)이 있으면 해당 경로만 최소 보강(검증 추가 또는 admweb 에러 표시). 이미 적절히 처리되어 있으면 "확인 완료"로 기록만.

---

### 6. TestScope.md 테스트 범위 갱신

- **목표**: itemncard 관련 추가 테스트가 TestScope에 반영되어 있어 릴리스·검증 시 참고 가능하도록.
- **작업**: task_2026-02-01T050337에서 추가한 테스트인 **연도별/월별 파이프라인** (`TestItemsFromPillars_YearMonthStyle`)과 **동점 정렬 안정성** (`TestSelectSajuCardsFromCards_SamePriorityAndScore_StableOrder`)을 TestScope.md의 "Go 테스트 위치·커버 범위"(또는 동등 섹션)에 각각 한 줄씩 반영. 문서만 갱신.

---

## Reference

| Doc | Use |
|-----|-----|
| PRD.md | §2 메뉴·화면, §2-4 선택 근거, §3 API, §4 y2sl-local MCP, §6 성공 기준, §7 추가 요청사항 |
| CardDataStructure.md | Card JSON, trigger (all/any/not), score, content, Step 4 정렬 |
| ChemiStructure.md | P_tokens, pair card schema, src P\|A\|B |
| TokenRule.md | items → tokens, where 정규화, L/M/H |
| TokenStructure.md | Token 문법, 카테고리, 위치 표준 |
| UserInfoStructure.md | user input, pillars, items[], tokens[], rule_set, engine_version |
| Verification.md | §6·§7 체크리스트, 전체 흐름 점검, 검증 이력 |
| TestScope.md | Go 테스트 위치, 커버 범위, 수동 검증 |
| Seed.md | Seed 파일 참조 현황, 시드에서 불러오기 옵션, 일괄 등록 |

---

## Notes

- Task 1: make test-itemncard 실패 원인 1건 수정(DB 의존성 제거 또는 테스트 조정).
- Task 2: seed 폴더·Seed.md·admweb 옵션 대조 및 문서 정리.
- Task 3: Verification.md 검증 이력에 항목별 기록용 템플릿/행 추가.
- Task 4: MCP·runLoop 문서화는 선택; 보류 시 Notes에만 기록.
- Task 5: 추출 API 오류 처리 1경로 이상 확인, 필요 시 최소 보강.
- Task 6: TestScope.md에 연도별/월별·동점 정렬 테스트 반영.
- 모든 명령은 repo root 기준; 백엔드 검증은 `cd api && make test-itemncard` 등으로 수행.

---

## Execution result (2026-02-01)

**Done**

1. **Task 1 — make test-itemncard 통과**  
   `RunLLMContextPreview`에서 요청 검증을 DB 접근 전에 수행하도록 수정. `card_uids` 없이 `card_ids`+`scope`가 유효하지 않은 경우(scope 빈 문자열 등) 즉시 400과 `"provide card_uids or (card_ids and scope saju|pair)"` 반환. `api/service/AdminExtractService.go`에 early-return 분기 추가. `TestRunLLMContextPreview_MissingParams`는 MongoDB 없이 통과(요청: `card_ids: ["c1"], scope: ""` → 400).

2. **Task 2 — Seed 참조 및 문서**  
   `docs/saju/itemNcard/seed/` 목록과 Seed.md 9개 옵션·미참조 표 대조. 궁합 미참조 행 수정: 형은 9개 옵션에 포함되므로 미참조 목록에서 제거하고, 반합·방합·소통 추가. Verification.md §7 (3) 문구 "6개 옵션" → "9개 옵션"으로 통일.

3. **Task 3 — 검증 이력 보완**  
   Verification.md "검증 이력" 아래에 **항목별 기록용 템플릿** 한 줄 추가. §7 (1)~(5) 및 전체 흐름(사주 인생·연도별·월별·궁합) 통과/미통과를 한 행으로 기록할 수 있는 마크다운 템플릿.

4. **Task 4 — MCP·runLoop 문서화 (선택)**  
   OperatorGuide.md에 이미 "MCP 연동" 섹션과 y2sl-local 도구·카드 JSON 전달 방식 안내 있음. `runLoopForSaju.sh` 상단 주석에 MCP 및 OperatorGuide §MCP 연동 참조 있음. 추가 변경 없음.

5. **Task 5 — 추출 API 오류 처리**  
   확인 완료. AdminExtractService_test.go에서 사주/궁합/llm_context_preview에 대해 GET 불가, invalid body, invalid birth(또는 missing params) 시 400 반환 검증. admweb `itemncard_api.ts`는 `!res.ok` 시 응답 body `error` 필드를 파싱해 `ApiError`로 던지고, DataCardsPage에서 `setErr`/Alert로 표시. 별도 수정 없음.

6. **Task 6 — TestScope.md 갱신**  
   "커버 범위 요약"에 `TestItemsFromPillars_YearMonthStyle`(연도별/월별 파이프라인), `TestSelectSajuCardsFromCards_SamePriorityAndScore_StableOrder`(동점·동점수 정렬 안정성) 한 줄씩 반영.

**Status**

- API 빌드: `cd api && go build .` 성공(외부 모듈 go-m1cpu 경고만 있음).
- 테스트: `TestRunLLMContextPreview_MissingParams` 단독 실행 시 PASS. 전체 `make test-itemncard`는 로컬에서 실행 시 통과 확인 권장.

**Remaining / Next steps**

- 검증 담당자에 의한 §7 (1)~(5) 및 전체 흐름(사주 인생/연도별/월별, 궁합) 수동 점검 1회 후, Verification.md 검증 이력 테이블에 항목별 템플릿으로 기록.
- 필요 시 `cd api && make test-itemncard` 및 `go build .` 한 번 더 실행하여 CI/릴리스 전 확인.
