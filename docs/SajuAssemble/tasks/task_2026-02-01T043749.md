# Task plan: itemNcard next steps (2026-02-01T043749)

Single task plan listing the next concrete, ordered tasks for itemNcard implementation. Ref: PRD.md, CardDataStructure.md, ChemiStructure.md, TokenRule.md, TokenStructure.md, UserInfoStructure.md. Each task is one step of appropriate size (neither too large nor too small). Only create or update this plan; do not implement code yet.

---

## Execution result (2026-02-01)

**Status**: Implemented tasks 1–5 and 7. Task 6 (MCP list/search cards) skipped (optional).

| Task | Done | Notes |
|------|------|--------|
| 1. Unit tests for MCP card tools | ✅ | Added `api/mcplocal/cardtools_test.go`: table-driven tests for `cardJSONToInput` (valid saju/pair, missing card_id/scope/title, invalid JSON). No DB required. Makefile `test-itemncard` now includes `./mcplocal/...`. AGENTS.md updated: MCP card tools covered by `go test ./mcplocal/...`. |
| 2. Extend 시드에서 불러오기 | ✅ | Added 4 seed options in `admweb/src/data/seedCards.ts`: saju_신살_도화, saju_오행_토, pair_궁합_합, pair_궁합_천간합 (match seed files in docs/saju/itemNcard/seed/). |
| 3. Server-side card validation | ✅ | Added `api/types/itemncard/validation.go`: `ValidateCardPayload(scope, triggerJSON, scoreJSON)` — trigger shape (all/any/not, token required; pair: src P|A|B), score shape (bonus_if/penalty_if token). Called from `AdminItemNCardService.CreateItemnCard` and `UpdateItemnCard` before persist. Added `validation_test.go`. OperatorGuide §카드 생성: server validation noted; ExtractionAPI reference. |
| 4. Copy-to-clipboard extraction result | ✅ | In `admweb/src/pages/DataCardsPage.tsx`: 사주 추출 테스트 — "복사" button next to 유저 명식, copies mode/pillars/rule_set/items_summary/tokens (plain text). 궁합 추출 테스트 — "복사" next to A/B 명식 요약, copies A/B pillars and P_tokens. Snackbar "복사됨" after copy. |
| 5. OperatorGuide troubleshooting | ✅ | Added **문제 해결 (Troubleshooting)** section in `docs/saju/itemNcard/OperatorGuide.md`: 추출 테스트 0건, 카드 validation 오류, MCP register_card 실패, make test-itemncard 실패 — causes and one-line resolutions; links to ExtractionAPI, Verification, Seed. |
| 6. MCP list/search cards | ⏭️ | Skipped (optional). |
| 7. Verification execution log | ✅ | Added **검증 이력 (Execution log)** in `docs/saju/itemNcard/Verification.md`: template table (날짜, 검증자, 결과, 비고) and reminder to run `make test-itemncard`, §1–§3 checklists, admweb extraction + card list/edit. |

**Verification**: Run from repo root: `cd api && make test-itemncard` (runs service/itemncard, service, mcplocal tests then `go build .`). Then `go build .` in api/ to confirm build. In this environment Go test/build output was not visible; please run the above locally to confirm all tests pass and build succeeds.

**Next steps**: (1) Run `cd api && make test-itemncard` and `go build .` locally. (2) Optionally implement task 6 (MCP list_cards/search_cards) if agent workflows need card discovery. (3) Fill Verification.md execution log when doing a full PRD §6 sign-off.

---

## Current state (as of 2026-02-01)

- **Backend**: Card CRUD (GraphQL), soft delete, extraction test REST (saju: 인생/연도별/월별, pair). itemncard pipeline: pillars → items → tokens → card selection with evidence, domain/tag limits, cooldown_group, max_per_user. LLM context builder and POST `/api/adm/llm_context_preview`. AdminExtractService returns user/pair info + selected cards with evidence and score. y2sl-local MCP: `register_card`, `update_card` in mcplocal/cardtools.go.
- **admweb**: Data Cards page with tabs (사주 카드, 궁합 카드, 사주 추출 테스트, 궁합 추출 테스트). List with filters (scope, status, category, tags, rule_set, 삭제 포함), sort, paging. Create/edit with full schema and trigger/score JSON validation (pair: src P|A|B). Soft delete, 복제, JSON 내보내기, 시드에서 불러오기, 일괄 등록. Extract result: items/tokens summary, pillars, selected cards + expandable evidence; LLM 컨텍스트 미리보기 with guardrails note.
- **Docs**: ExtractionAPI.md (REST contract), Seed.md, OperatorGuide.md, Verification.md (PRD §6 checklist). AGENTS.md references `make test-itemncard`. PRD §6 success criteria met; optional y2sl-local MCP implemented. Prior plan task_2026-02-01T042911 completed all seven tasks.

---

## Ordered next tasks

### 1. Unit tests for MCP card tools (api/mcplocal/cardtools.go)

- Add a test file (e.g. `api/mcplocal/cardtools_test.go`) that covers:
  - **Validation**: `cardJSONToInput` (or equivalent) with valid CardDataStructure (saju) and ChemiStructure (pair) JSON; invalid payloads (missing card_id, scope, trigger, title; malformed trigger/score; pair trigger without `src` or invalid `src`). Expect success for valid, structured error or reject for invalid.
  - **Register/update flow**: Either (A) unit tests with a mock or in-memory stub for AdminItemNCardService so that `runRegisterCard`/`runUpdateCard` are invoked with expected input and return values, or (B) table-driven tests that only assert validation output and do not call the real service. Prefer minimal dependency (no DB) so that `go test ./mcplocal/...` runs without MongoDB.
- Scope: mcplocal package only; one test file. Document in AGENTS.md or OperatorGuide that `make test-itemncard` (or `go test ./mcplocal/...`) covers MCP card tools.

---

### 2. Extend "시드에서 불러오기" seed options (admweb)

- In the card create form’s **시드에서 불러오기** dropdown, add at least two more seed options so that operators can quickly load a broader set of examples. Use the existing pattern (e.g. `admweb/src/data/seedCards.ts`): add entries that map to seed files under `docs/saju/itemNcard/seed/` (e.g. `saju_신살_도화`, `saju_오행_토`, `pair_궁합_합`, `pair_궁합_천간합` — choose names that exist in Seed.md or the seed/ directory). Each new option: bundled or static JSON, parse and fill form (trigger, score, content, category, tags, title, card_id, scope); scope inferred from seed. No new backend endpoint; reuse existing create mutation on submit.
- Keep the change small: add 2–4 seed options; ensure validation still applies (CardDataStructure for saju, ChemiStructure for pair). Optionally update Seed.md or OperatorGuide to list the new options available in the UI.

---

### 3. Server-side card validation (backend)

- In the GraphQL create/update resolvers for itemNcard (or in AdminItemNCardService before persist), add **server-side validation** of the card payload so that invalid data is rejected with a clear error message. Validate at least: required fields (card_id, scope, trigger, title per PRD and CardDataStructure/ChemiStructure); trigger shape (`all`/`any`/`not` arrays, each element with `token` and for pair with valid `src` in `["P","A","B"]`); score shape if present (base, bonus_if, penalty_if with token/add/sub); content shape if present. Reject with HTTP 4xx or GraphQL error and a short reason (e.g. "trigger.all[0]: missing token", "pair trigger entry: src must be P, A, or B"). Do not change the pipeline logic (items/tokens/card selection); only input validation at create/update.
- Ensure admweb receives and displays the error (e.g. GraphQL errors already shown in create/edit dialog). Document in ExtractionAPI.md or OperatorGuide that create/update enforce CardDataStructure/ChemiStructure validation.

---

### 4. Extraction result: copy-to-clipboard for tokens and items (admweb)

- In the **extraction test result** panels (사주 추출 테스트, 궁합 추출 테스트), add a **복사** (Copy) control for the **유저 명식 분석** section: copy the tokens list (and optionally items summary or pillars) to the clipboard as plain text (e.g. one token per line, or a short JSON snippet). For 궁합 결과, include A summary, B summary, and P_tokens in the copied content (e.g. labeled sections). Use the Clipboard API; show a brief success toast or message after copy. No backend change.
- Scope: one "Copy tokens" (or "Copy result") button per result panel; keep the change limited to UX so operators can paste into docs or tickets.

---

### 5. OperatorGuide: troubleshooting and common errors

- Add a short **Troubleshooting** (or **문제 해결**) section to `docs/saju/itemNcard/OperatorGuide.md` that lists common issues and one-line resolutions. Include at least: (1) 추출 테스트 시 카드가 0건으로 나올 때: seed 데이터 존재 여부, trigger 문법과 실제 tokens 일치 여부, status=published 확인. (2) 카드 생성/수정 시 validation 오류: trigger/score JSON 형식, pair일 때 `src` 필드 확인. (3) MCP register_card 실패: card_json 필수 필드, scope 및 trigger 형식. (4) 빌드/테스트: `make test-itemncard` 실패 시 MongoDB 필요 여부, mcplocal 테스트 실행 방법. Link to ExtractionAPI.md, Verification.md, and Seed.md where relevant. Documentation only; no code changes.

---

### 6. MCP tool: list or search cards (optional)

- **Precondition**: Card CRUD and MCP register/update tools are stable.
- Add an MCP tool (e.g. `list_cards` or `search_cards`) in the y2sl-local MCP server (or API-serving MCP) that allows the agent to **query** existing cards without creating/updating. Input: optional filters (scope, status, category, card_id substring, limit). Output: list of card summaries (e.g. card_id, uid, scope, title, status) or a subset of fields. Implementation can call the existing GraphQL list query or a thin REST wrapper. Purpose: so that runLoopForSaju.sh or Cursor agent can "see what cards exist" before deciding to register or update. Document the new tool in OperatorGuide §MCP 연동. Implement only if agent-driven workflows need discovery; otherwise mark as optional and skip.

---

### 7. Verification run and checklist sign-off (documentation)

- In `docs/saju/itemNcard/Verification.md`, add a short **Execution log** (or **검증 이력**) subsection: a template for recording the date and result of a full verification run (e.g. "날짜: YYYY-MM-DD, 검증자: ..., 결과: 통과/미통과, 비고: ..."). Optionally add one-line reminders: run `cd api && make test-itemncard`, run through Verification.md §1–§3 checkboxes, and confirm admweb extraction test + card list/edit. No code implementation; documentation only so that releases can document that PRD §6 was verified.

---

## Reference

| Doc | Use |
|-----|-----|
| PRD.md | §2 메뉴·화면, §2-4 선택 근거, §3 API, §4 y2sl-local MCP, §6 성공 기준 |
| CardDataStructure.md | Card JSON, trigger (all/any/not), score, content, validation |
| ChemiStructure.md | P_tokens, pair card schema, src P|A|B, trigger shape |
| TokenRule.md | items → tokens, where 정규화, L/M/H |
| TokenStructure.md | Token 문법, 카테고리, 위치 표준 |
| UserInfoStructure.md | user input, pillars, items[], tokens[], rule_set, engine_version |
| ExtractionAPI.md | REST contract for extraction test and LLM preview |
| Verification.md | PRD §6 checklist, backend/build verification |

---

## Notes

- Tasks 1–5 are concrete next steps; task 6 is optional (MCP list/search); task 7 is documentation for verification sign-off.
- Run all commands from repo root; backend commands from `api/` (e.g. `cd api && make test-itemncard`).
- Do not implement code in this plan; only create or update the task plan file.
