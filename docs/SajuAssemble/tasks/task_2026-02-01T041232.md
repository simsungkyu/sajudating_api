# Task plan: itemNcard next steps (2026-02-01T041232)

Single task plan listing the next concrete, ordered tasks for itemNcard implementation. Ref: PRD.md, CardDataStructure.md, ChemiStructure.md, TokenRule.md, TokenStructure.md, UserInfoStructure.md. Each task is one step of appropriate size (neither too large nor too small). Do not implement code in this cycle; only create or update this plan.

---

## Execution result (2026-02-01)

**Done**

1. **List: reset offset when filters or sort change** — Implemented. In `admweb/src/pages/DataCardsPage.tsx`, `CardListFilters` callbacks for saju and pair now reset offset to 0 when any of status, category, tags, rule_set, orderBy, or orderDirection change. Filter/sort state is unchanged; only pagination (offset) resets.
2. **LLM context preview (optional)** — Implemented.
   - **Backend**: POST `/api/adm/llm_context_preview` in `api/routes/route_adm.go`. Request body: `card_uids` ([]string) or `card_ids` ([]string) + `scope` ("saju"|"pair"). Service in `AdminExtractService.RunLLMContextPreview` loads cards via `dao.ItemNCardRepository` (`FindByUID` or `FindByCardIDsAndScope`), calls `itemncard.BuildLLMContextFromCards`, returns `{ context, length }`. DTOs in `api/dto/itemncard_dto.go`. Repository method `FindByCardIDsAndScope` added in `api/dao/itemn_card_repository.go`. Unit tests in `AdminExtractService_test.go`: `TestRunLLMContextPreview_MethodNotAllowed`, `_InvalidBody`, `_MissingParams`.
   - **admweb**: In 사주 추출 테스트 and 궁합 추출 테스트 result panels, added "LLM 컨텍스트 미리보기" button when there are selected cards. On click, calls `llmContextPreview({ card_ids, scope })` (in `admweb/src/api/itemncard_api.ts`) and shows the context in a dialog. Dialog shows loading state and errors.

**Verification**

- Run from repo root: `cd api && go test ./...` and `cd api && go build .` (dev server and gqlgen are in watch mode; not run). If the environment suppresses Go command output, run locally to confirm tests and build pass.

**Remaining / next steps**

- **Task 3 (optional)**: Seed data or templates — Option A (document how to load seed JSON) or Option B (Load from seed in card create form). Not implemented.
- **Task 4 (optional)**: y2sl-local MCP card registration — Implement only if MCP server is in use. Not implemented.

---

## Current state (as of 2026-02-01)

- **Backend**: Card CRUD (GraphQL), extraction test REST (saju, pair), itemncard pipeline (pillars → items → tokens → card selection with evidence, domain/tag limits, cooldown_group, max_per_user). 연도별/월별 pillar (歲運/月運). LLM context builder `BuildLLMContextFromCards`. AdminExtractService returns user/pair info + selected cards with evidence and score.
- **admweb**: Data Cards page with tabs (사주 카드, 궁합 카드, 사주 추출 테스트, 궁합 추출 테스트). List with filters (scope, status, category, tags, rule_set), sort, and **paging**. Create/edit dialogs with full schema and trigger/score JSON validation (pair: src P|A|B). **Delete** (hard delete with confirmation). Saju extract result: items_summary, tokens_summary, pillars, period, selected cards + evidence. Pair extract result: A/B pillars, P_tokens summary, selected cards + evidence.
- **Remaining from prior plan**: Optional—LLM context preview, seed/templates, y2sl-local MCP. UX: reset list offset when filters or sort change.

---

## 1. List: reset offset when filters or sort change

- In admweb Data Cards list (saju and pair tabs), **reset `offset` to 0** whenever the user changes any filter (scope, status, category, tags, rule_set) or sort (e.g. sort field or direction). This avoids showing an empty or inconsistent page when the result set changes. Keep existing filter/sort state; only reset pagination.

---

## 2. LLM context preview (optional)

- **Backend**: Add a test/preview endpoint (e.g. POST `/api/adm/extract/llm_context_preview` or GraphQL) that accepts either (a) a list of card uids, or (b) an extract result payload (e.g. saju or pair extract response). Call `BuildLLMContextFromCards` with the corresponding selected cards and return the context string (and optionally length). No change to card selection logic.
- **admweb**: In 사주 추출 테스트 and 궁합 추출 테스트 result panels, add a **"Preview context"** (또는 "LLM 컨텍스트 미리보기") action that calls this endpoint with the current selected cards and displays the context in a dialog or expandable block. Purpose: let operators verify the string before wiring into reply flow (PRD §2-3, CardDataStructure Step 5).

---

## 3. Seed data or templates (optional)

- **Option A (docs)**: Document in `docs/saju/itemNcard/` or in the Data Cards UI help how to load seed JSON from `docs/saju/itemNcard/seed/` (e.g. `saju_정재_강함.json`, `pair_궁합_충.json`) as initial data—e.g. curl/GraphQL examples or admin procedure.
- **Option B (UI)**: In card create form, add an optional **"Load from seed"** control (dropdown of seed file names or file picker) that fills trigger, score, and content from the chosen seed JSON. Keep scope small (one or two seed files as examples; validate against CardDataStructure/ChemiStructure).
- Implement one of the options; do not require both.

---

## 4. (Optional) y2sl-local MCP card registration

- After card CRUD and extract test are stable: add MCP tools (e.g. `register_card`, `update_card`) in y2sl-local that call the backend card API (GraphQL createItemnCard/updateItemnCard or equivalent). Document in `docs/saju/itemNcard/` or `runLoopForSaju.sh` how Cursor agent or the loop script can use these tools to register/update cards. Implement only if the MCP server is in use (PRD §4).

---

## Reference

| Doc | Use |
|-----|-----|
| PRD.md | Scope, §2-2 list/delete, §2-3 extraction test UX, §2-4 visibility, §4 MCP |
| CardDataStructure.md | Trigger, score, Step 5 LLM context, guardrails |
| ChemiStructure.md | P_tokens, pair card schema, src P/A/B |
| TokenRule.md | items → tokens, where normalization, L/M/H |
| TokenStructure.md | Token syntax, categories |
| UserInfoStructure.md | items schema, pillars, tokens, rule_set, engine_version |
