# itemNcard implementation – task plan (2026-02-01)

Ordered steps for implementing 사주·궁합 데이터 카드 service per PRD and structure docs (CardDataStructure, ChemiStructure, TokenRule, TokenStructure, UserInfoStructure). Execute in order.

---

## Phase A: Backend – data and card CRUD

1. **Define MongoDB collection(s) for cards**
   - One collection (e.g. `itemn_cards`) with `scope` field (`"saju"` | `"pair"`), or separate collections for saju vs pair.
   - Schema aligned with CardDataStructure (saju) and ChemiStructure (pair): `card_id`, `version`, `status`, `rule_set`, `scope` (pair only), `title`, `category`, `tags`, `domains`, `priority`, `trigger`, `score`, `content`, `cooldown_group`, `max_per_user`, `debug`.
   - Unique index on `card_id` (and optionally `scope` if single collection). Indexes for list filters: `scope`, `status`, `category`, `tags`, `priority`.

2. **Implement card DAO**
   - CRUD in `api/dao/`: list with filters (scope, status, category/tags), sort, pagination; get by `card_id`; create; update; delete (hard or soft per PRD).

3. **Expose card CRUD via GraphQL**
   - In `api/admgql/`: types and mutations/queries for list cards, get card, create card, update card, delete card. Resolvers call DAO. Support filtering by scope (saju/pair), status, category/tags, and ordering/pagination.

---

## Phase B: Backend – 명식 and tokens pipeline

4. **UserInfo / items pipeline (saju single user)**
   - Input: birth (date, time, time_precision), timezone, calendar (solar/lunar), optional gender (UserInfoStructure).
   - Reuse or extend existing pillar calculation (e.g. sxtwl) to produce `pillars` (y/m/d/h) and `dm` (일간).
   - Implement items generation: from pillars + rule_set produce `items[]` (십성, 관계, 오행, 신살, 격국, 용신, 육친, 강약, 확신, 지장간 as needed). Follow UserInfoStructure and TokenStructure categories. Populate `k`, `n`, `where`, `w`, `sys` where applicable.

5. **items → tokens compiler (saju)**
   - Per TokenRule: from each item emit tokens (existence `k:n`, location `k:n@where`, grade `k:n#L|M|H`, combined `k:n@where#grade`, optional `~sys`). Use standard L/M/H bands (e.g. 0–49, 50–69, 70–100). Normalize `where` (년→월→일→시 order for relations). Dedupe and optionally sort. Output `tokens[]` / `tokenSet`.

6. **Saju card trigger evaluation**
   - Per CardDataStructure: for each published card with `scope: "saju"` (or no scope / default saju), evaluate trigger against `tokenSet`: (1) if any `not` matches → skip; (2) all `all` must match; (3) if `any` non-empty, at least one must match. Collect passing cards. Optionally compute score (base + bonus_if − penalty_if), sort by priority/score, apply cooldown_group / max_per_user / domain caps. Return selected cards plus, for each, evidence tokens (which trigger tokens matched).

---

## Phase C: Backend – pair (궁합) pipeline and test APIs

7. **Pair items and tokens (A, B, P)**
   - For two users A and B: run step 4 for each → A_items, B_items; run step 5 for each → A_tokens, B_tokens.
   - Implement P_items generation (ChemiStructure): from A/B pillars compute pair facts (충/합/형/파/해, 천간합, 삼합, 테마 점수, 확신 등). Schema: `k: "궁합"`, `n`, `where` (A.pos-B.pos), `w`, `sys`. Then P_items → P_tokens using same token rules (궁합:n[@where][#L|M|H][~sys]).

8. **Pair card trigger evaluation**
   - For each published card with `scope: "pair"`, evaluate trigger: each condition has optional `src` (P | A | B). Resolve token in P_tokens, A_tokens, or B_tokens accordingly. Same all/any/not logic. Return selected pair cards with evidence.

9. **Extraction test API (admweb-only)**
   - **Saju test endpoint**: accept birth (date, time, time_precision), timezone, calendar, mode (인생 | 연도별 | 월별), optional gender. Run steps 4–6 (for chosen mode; 연도별/월별 imply 대운·세운 or 월운 if defined). Response: UserInfo summary (pillars, items/tokens summary, rule_set, engine_version) + selected saju cards with card_id, title, evidence, score.
   - **Pair test endpoint**: accept A birth, B birth (same format). Run steps 4–5 for A and B, step 7 for P, step 8. Response: A/B 명식 summary, P_tokens summary, selected pair cards with card_id, title, evidence, score.

---

## Phase D: admweb – UI for cards and tests

10. **Add “데이터 카드” menu**
    - New menu entry (e.g. “데이터 카드” or “사주/궁합 카드”) with submenu or tabs: “사주 카드”, “궁합 카드”.

11. **Card list and management**
    - **사주 카드** tab: list cards (scope saju); filters (status, category, tags), sort (e.g. priority), pagination. Columns: card_id, scope, status, title, category/tags, priority. Actions: create, edit, delete, toggle status.
    - **궁합 카드** tab: same for scope pair.
    - Create/Edit form: form or JSON editor conforming to CardDataStructure (saju) or ChemiStructure (pair). Validate required fields (card_id, title, trigger, status, etc.).

12. **Saju extraction test UI**
    - Mode: 인생(원국) / 연도별(대운·세운) / 월별. Inputs: birth date, time, time_precision, timezone, optional gender. “Run” calls saju test API.
    - Result view: (1) 유저 명식 분석 정보 (pillars, items/tokens 요약, rule_set, engine_version); (2) 선택된 데이터 카드 목록 with card_id, title, evidence (matched tokens), score.

13. **Pair extraction test UI**
    - Inputs: A birth (date, time, time_precision, timezone), B birth (same). “Run” calls pair test API.
    - Result view: (1) A/B 명식 요약; (2) P_tokens 요약; (3) 선택된 궁합 카드 목록 with card_id, title, evidence, score.

---

## Phase E: Optional – MCP and automation

14. **y2sl-local MCP card tools (optional)**
    - After card CRUD API is stable: add MCP tools (e.g. register card, update card) that call the GraphQL or REST card API. Document usage so runLoopForSaju.sh (or Cursor agent) can register/update cards via MCP.

---

## Reference

| Doc | Use |
|-----|-----|
| PRD.md | Scope, menus, extraction test UX, API summary |
| CardDataStructure.md | Saju card schema, trigger logic, scoring, content |
| ChemiStructure.md | P_tokens, pair card schema, src P/A/B |
| TokenRule.md | items → tokens rules, where normalization |
| TokenStructure.md | Token syntax, categories, positions |
| UserInfoStructure.md | Input, pillars, items, tokens schema |

---

## Execution result (2026-02-01)

**Status:** Phases A–D implemented. Phase E (MCP) optional and not done.

### Done

- **Phase A**
  - MongoDB collection `itemn_cards` with entity (`api/dao/entity/itemn_card_entity.go`), unique index on `(card_id, scope)`, list indexes on scope/status/category/tags/priority.
  - DAO `api/dao/itemn_card_repository.go`: Create, FindByUID, FindByCardIDAndScope, FindWithPagination, Update, Delete, ListPublishedByScope.
  - GraphQL: types/mutations/queries in `api/admgql/admgql.graphql` (ItemNCard, ItemNCardSearchInput, ItemNCardInput, itemnCards, itemnCard, itemnCardByCardId, createItemnCard, updateItemnCard, deleteItemnCard). Resolvers in `api/admgql/admgql.resolvers.go` and `AdminItemNCardService` in `api/service/AdminItemNCardService.go`.
- **Phase B**
  - UserInfo/items: `api/types/itemncard/types.go` (Item, PillarsText, GradeFromW). `api/service/itemncard/saju.go`: PillarsFromBirth (sxtwl), ItemsFromPillars (십성 from TenStems + 오행 + 확신 placeholder), ItemsToTokens (k:n, @where, #L|M|H, ~sys), NormalizeWhere, EvaluateSajuTrigger, SelectSajuCards.
- **Phase C**
  - Pair: `api/service/itemncard/pair.go`: PItemsFromPillars (placeholder 궁합:확신), EvaluatePairTrigger (src P|A|B), SelectPairCards.
  - Test APIs: `api/service/AdminExtractService.go` (RunSajuExtractTest, RunPairExtractTest), `api/routes/route_adm.go`, `POST /api/adm/saju_extract_test`, `POST /api/adm/pair_extract_test`; DTOs in `api/dto/itemncard_dto.go`.
- **Phase D**
  - admweb: “데이터 카드” menu in `ProtectedLayout.tsx`, route `/data-cards` and `DataCardsPage` in `App.tsx`.
  - `admweb/src/pages/DataCardsPage.tsx`: tabs 사주 카드 / 궁합 카드 / 사주 추출 테스트 / 궁합 추출 테스트. Card list (scope filter, delete). Saju test: birth date/time, timezone, Run → user_info + selected_cards. Pair test: A/B birth, Run → summary_a/b, p_tokens_summary, selected_cards.
  - GraphQL operations in `admweb/src/graphql/csr.graphql` (itemnCardBasic, itemnCards, itemnCard, createItemnCard, updateItemnCard, deleteItemnCard). REST client in `admweb/src/api/itemncard_api.ts` (sajuExtractTest, pairExtractTest).

### Remaining / next steps

- **Card create/edit UI:** DataCardsPage currently lists and deletes only. Add create/edit form or JSON editor for ItemNCard (card_id, title, trigger, status, scope, etc.) using createItemnCard/updateItemnCard mutations.
- **Filters/sort on list:** Optional status, category, tags filters and orderBy/orderDirection in itemnCards query (backend supports them).
- **Phase E (optional):** y2sl-local MCP tools for card register/update; document for runLoopForSaju.sh.
- **Items/tokens depth:** Current items are 십성 (from TenStems), 오행 (day stem), 확신 placeholder; P_items are placeholder 궁합:확신. Extend with 관계, 신살, 격국, 용신, 지장간, and real pair facts (충/합/형/파/해, 천간합 등) per docs.
- **연도별/월별 mode:** Saju test API accepts mode but only 인생(원국) is implemented; 연도별/월별 would need 대운·세운 or 월운 logic.
