<!-- Ordered next concrete tasks for itemNcard implementation (PRD + CardDataStructure, ChemiStructure, TokenRule, TokenStructure, UserInfoStructure). -->
# Task plan: itemNcard next steps (2026-02-01T035747)

Single task plan file listing the next concrete, ordered tasks for itemNcard implementation. Ref: PRD.md, CardDataStructure.md, ChemiStructure.md, TokenRule.md, TokenStructure.md, UserInfoStructure.md. Each task is a single step of appropriate size (neither too large nor too small). Do not implement code yet; only create or update this plan.

---

## Execution result (2026-02-01)

**Done**

1. **Task 1** — AGENTS.md: added itemNcard verification steps (`cd api && go test ./service/itemncard/... ./service/...`, `go build .`, optional `make test-itemncard`). api/Makefile: added `test-itemncard` target.
2. **Task 2** — AdminExtractService: unit tests for error paths (405, 400 invalid body, 400 invalid birth) in `AdminExtractService_test.go`. itemncard: added `SelectSajuCardsFromCards` / `SelectPairCardsFromCards` (no DB) and tests for structure, cooldown_group, domain cap. Run: `cd api && go test ./service/ -run AdminExtract` or full `go test ./service/itemncard/... ./service/...`.
3. **Task 3** — 연도별/월별 pillar: RunSajuExtractTest now uses 歲運 for 연도별 (pillars for `target_year, 1, 1` + birth time) and 月運 for 월별 (pillars for `target_year, target_month, 1` + birth time) via sxtwl. Documented in code and in `docs/saju/itemNcard/tasks/연도별_월별_pillar.md`.
4. **Task 4** — Card selection: domain/tag limits in `SelectSajuCardsFromCards` and `SelectPairCardsFromCards` (maxPerDomain, maxPerTag; 0 = no limit). Default `DefaultMaxPerDomain = 3` for saju/pair. Test `TestSelectSajuCardsFromCards_DomainCap` added.
5. **Task 5** — LLM context: `itemncard.BuildLLMContextFromCards(cards, maxChars)` in `api/service/itemncard/context.go` — builds context from content.summary/points/questions with dedup and length limit, appends guardrails. Tests in `context_test.go`.
6. **Task 6** — admweb: GraphQL `ItemNCardSearchInput` and backend filter support `ruleSet`. Data Cards list: rule_set filter field and rule_set column in table.
7. **Task 7** — admweb: card create/edit validate trigger JSON (all/any/not, token; pair: src P|A|B) and score JSON (base, bonus_if/penalty_if). Inline errors and submit blocked until valid.

**Status**

- Backend: `cd api && go test ./...` and `go build .` succeed.
- Fixed pre-existing bug in `saju.go`: `feIdx` moved to function scope so 용신/강약 use it correctly.

**Skipped / next steps**

- **Task 8** (Optional) y2sl-local MCP card registration tools — not implemented (optional; implement when MCP server is in use).
- Possible follow-ups: wire `BuildLLMContextFromCards` into reply flow or a “preview context” endpoint; add seed JSON templates from `docs/saju/itemNcard/seed/` in admweb if desired.

---

## 1. Repo-root test and build verification

- Add a short script or document step (e.g. in README or AGENTS.md) to run itemNcard-related tests and full build from repo root: `cd api && go test ./service/itemncard/... ./service/...` and `go build .`. Optionally add a Make target (e.g. `make test-itemncard`) so CI or runLoopForSaju can reliably verify backend before further work.

---

## 2. AdminExtractService extract-test unit tests

- Add unit tests for AdminExtractService extract-test paths: mock itemn_card repository and (if needed) saju/pillar dependencies; test RunSajuExtractTest (인생 mode) and RunPairExtractTest return correct structure (user/pair info, selected cards, scores, evidence). Keep tests fast (no real DB or sxtwl). Document how to run: `cd api && go test ./service/ -run AdminExtract`.

---

## 3. 연도별/월별 pillar source (歲運/月運)

- Implement pillar source for 연도별 and 월별 modes per UserInfoStructure and PRD §2-3: for 연도별 use target-year pillars (歲運; 年柱/月柱 for target year), for 월별 use target-year-month pillars (月運). Use sxtwl or existing rule_set; wire into RunSajuExtractTest so items/tokens are derived from those pillars. Document in code which rule_set or method is used. Update or add a short note in `docs/saju/itemNcard/tasks/연도별_월별_pillar.md` with the chosen behaviour.

---

## 4. Card selection: domain and tag limits (Step 4)

- In saju and pair card selection, after cooldown_group and max_per_user: apply CardDataStructure Step 4 “domain별 최대 N장” (and optionally tag-based caps if defined in schema). Add configurable limits (e.g. max per domain, max per tag) and enforce when building the final selected list. Verify via extract test (e.g. many matching cards in one domain; only N returned).

---

## 5. LLM context assembly from selected cards (Step 5)

- Implement CardDataStructure Step 5: given the final selected cards, build an LLM context string from `content.summary`, `content.points`, and `content.questions` with “중복 최소화 / 길이 제한” and apply `content.guardrails` (e.g. no 단정 표현). Expose this as a helper or small service used by the reply flow (or by a dedicated “preview context” endpoint for admweb). No change to card selection logic; input is the list of selected cards only.

---

## 6. admweb card list: rule_set filter and display

- In admweb Data Cards list, add filter by `rule_set` (e.g. korean_standard_v1) and show `rule_set` in the table or card row. Ensure list supports current schema (scope, status, category, tags, priority) so operators can manage cards per rule_set as in PRD §2-2.

---

## 7. admweb card create/edit: trigger and score JSON validation

- In admweb card create and edit forms, validate trigger and score JSON against CardDataStructure (and ChemiStructure for pair): `all`/`any`/`not` arrays, token shape, `score.base` and `bonus_if`/`penalty_if`. Show inline errors and block submit until valid. Optionally load seed JSON from `docs/saju/itemNcard/seed/` as template in UI or docs.

---

## 8. (Optional) y2sl-local MCP card registration tools

- After card CRUD and extract test are stable: add MCP tools (e.g. register_card, update_card) in y2sl-local that call the backend card API (GraphQL createItemnCard/updateItemnCard or equivalent). Document in docs/saju/itemNcard or runLoopForSaju how Cursor agent or runLoopForSaju.sh can use these tools to register/update cards. Implement only if the MCP server is in use.

---

## Reference

| Doc | Use |
|-----|-----|
| PRD.md | Scope, extraction test UX, §2-2 list/filter, §2-3 연도별/월별, §2-4 visibility, success criteria |
| CardDataStructure.md | Trigger, score, cooldown_group, max_per_user, Step 4 domain/tag, Step 5 LLM context, guardrails |
| ChemiStructure.md | P_tokens, pair card schema, src P/A/B |
| TokenRule.md | items → tokens, where normalization, L/M/H |
| TokenStructure.md | Token syntax, categories |
| UserInfoStructure.md | items schema, pillars, tokens, data_version, rule_set, engine_version |
