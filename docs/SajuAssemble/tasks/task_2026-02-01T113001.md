<!-- Ordered next-step task plan for itemNcard implementation (PRD + CardDataStructure, ChemiStructure, TokenRule, TokenStructure, UserInfoStructure). -->
# Task plan: itemNcard next steps (2026-02-01T113001)

Ordered concrete tasks for itemNcard implementation. Ref: PRD.md, CardDataStructure.md, ChemiStructure.md, TokenRule.md, TokenStructure.md, UserInfoStructure.md.

---

## Current state (reference)

- **Backend**: Card CRUD (GraphQL), itemn_card entity/repo/dto, AdminItemNCardService, AdminExtractService; itemncard package (pillars → items → tokens → card selection per CardDataStructure/ChemiStructure); extraction REST (saju 인생/연도별/월별, pair); LLM context preview; y2sl-local MCP (register_card, update_card, list_cards); types/itemncard validation; cooldown_group and max_per_user in selection.
- **admweb**: Data Cards page, tabs (사주 카드 / 궁합 카드 / 사주 추출 테스트 / 궁합 추출 테스트); list filter/sort/paging; create/edit with seed load and bulk register; PillarDisplay (양=볼드, 오행=컬러); extraction result panels (A/B 명식 요약, selected cards, evidence, LLM 요청 전체 내용 textarea).
- **Previous plan (task_2026-02-01T112608)**: Tasks 4 and 7 done; Tasks 1–3 pending manual verification; Task 6 attempted (test exit 1 in env); Tasks 8–10 optional and skipped.

---

## Ordered next tasks

### 1. Run PRD §7 checklist (1)–(5) and record

- **Goal**: Confirm PRD §7 five items are satisfied and record pass/fail per item.
- **Work**: Follow Verification.md **§7 체크리스트** in order: (1) 사주 추출 결과화면 — 원국 음양 볼드·오행 컬러, (2) 궁합 추출 결과화면 — A/B 명식 요약, (3) seed 폴더 참조·시드에서 불러오기·일괄 등록, (4) 사주 추출 — LLM 요청 전체 내용 textarea, (5) 궁합 추출 — LLM 요청 전체 내용 textarea. For each item note pass/fail and one-line finding. Add one row (or one row per item) to Verification.md **검증 이력**.
- **Scope**: Manual check + Verification.md update; no code change unless a defect is found and handled in a separate task.

---

### 2. Full-flow verification (saju 인생/연도별/월별, pair) and record

- **Goal**: Confirm end-to-end flow for saju (3 modes) and pair extraction and record result.
- **Work**: Follow Verification.md **전체 흐름 점검**: (1) 사주 인생 모드 → result panel (원국·items/tokens·selected cards·evidence·LLM textarea), (2) 사주 연도별 mode same check, (3) 사주 월별 mode same check, (4) pair 추출 A/B input → result panel (A/B 명식·P_tokens·selected cards·evidence·LLM textarea). Note any issue (one-line). Add full-flow result to Verification.md 검증 이력.
- **Scope**: Manual check + Verification.md update; no code change unless a defect is found and handled in a separate task.

---

### 3. Seed–extraction linkage verification and record

- **Goal**: Confirm that cards loaded from seed/ appear in the extraction pool and can be selected when triggers match.
- **Work**: In admweb use "시드에서 불러오기" to load one or more seeds (e.g. saju_정재_강함, pair_궁합_충), bulk-register, then run extraction test with birth data (or A/B pair) that satisfies those triggers. Confirm selected cards include the seeded cards. If not: document cause in one line (e.g. card not registered, trigger mismatch, token rules). If yes: add "seed 연동 확인 완료" to Verification.md 검증 이력.
- **Scope**: Manual check + one doc row or one-line issue; no code change unless a separate fix task is created.

---

### 4. Confirm date/time format (yyyy-MM-dd HH:mm) on data card screens

- **Goal**: Ensure PRD §7 requirement — data card screens use yyyy-MM-dd HH:mm for birth date/time input — is met.
- **Work**: In admweb Data Cards → 사주 추출 테스트 and 궁합 추출 테스트, verify birth date and time inputs display and accept values in yyyy-MM-dd HH:mm (or equivalent formatting rule). Check any date/time picker or text field used for birth input. If not compliant: document in Verification.md and create a single follow-up task for the fix; if compliant: add one row to Verification.md 검증 이력.
- **Scope**: Manual check + one Verification.md row; no code change unless a separate fix task is created.

---

### 5. Consolidate verification history in Verification.md

- **Goal**: Consolidate results from tasks 1–4 into Verification.md 검증 이력.
- **Work**: Verification.md의 §7 체크리스트·전체 흐름·seed 연동·날짜 포맷에 맞춰, 태스크 1–4 결과를 날짜·항목·결과(통과/이슈 1줄)로 1행 이상 추가. 이미 동일 이력이 있으면 중복 없이 보완만.
- **Scope**: Verification.md만 수정.

---

### 6. (Conditional) Fix one highest-priority verification finding

- **Goal**: If tasks 1–4 recorded one or more issues, fix the single highest-priority one.
- **Work**: From verification history pick **one** issue (e.g. PillarDisplay 양/오행, A/B summary layout, evidence display, LLM textarea, seed options, date format). Implement the fix. If no issues or already tracked elsewhere, mark this task "해당 없음" and skip.
- **Scope**: One fix only.

---

### 7. Run automated verification from repo root and record

- **Goal**: Ensure itemNcard tests and build pass from repo root and reflect in Verification.md.
- **Work**: From repo root run `cd api && make test-itemncard && go build .` (or `bash docs/saju/itemNcard/run_verification.sh`). If pass: verify Verification.md 검증 이력 has this run (date, result, note); if missing add one row. If fail: fix one cause or record issue, then re-run.
- **Scope**: Command run + Verification.md check or one row; optional one fix.

---

### 8. Flow sanity and test scope review (PRD §7)

- **Goal**: Confirm overall flow has no obvious gaps and tests cover appropriate logic and scope.
- **Work**: Review end-to-end flow (input → pillars → items → tokens → card selection → LLM context) against CardDataStructure Step 0–6 and ChemiStructure Step 1–5. Review TestScope.md and `make test-itemncard` coverage (itemncard package, AdminExtractService, mcplocal/cardtools). Note one-line finding (OK or one gap) in Verification.md or docs/saju/itemNcard/todo.md.
- **Scope**: Review only; doc one row or skip if already documented.

---

### 9. (Optional) LLM context preview E2E and OperatorGuide

- **Goal**: Confirm admweb LLM context preview works and procedure is documented.
- **Work**: In Data Cards run saju or pair extraction test, then trigger LLM context preview. Confirm `POST /api/adm/llm_context_preview` is called and response is shown. If OperatorGuide or Verification.md lacks this procedure, add 1–2 paragraphs. If problem found, fix one or record issue.
- **Scope**: Manual check + doc or one fix if needed.

---

### 10. (Optional) y2sl-local MCP E2E and runLoopForSaju.sh docs

- **Goal**: Confirm y2sl-local MCP card registration works and runLoopForSaju.sh/OperatorGuide MCP steps are documented (PRD §4).
- **Work**: Start API with `LOCAL_MCP=true`. From MCP client call `register_card` for one card; confirm card appears in admweb Data Cards list. Compare runLoopForSaju.sh and OperatorGuide §MCP to ensure steps are documented. If not implemented, skip check. If docs missing, add 1–2 paragraphs to OperatorGuide or runLoopForSaju.sh.
- **Scope**: Manual check + doc update if needed.

---

### 11. (Optional) PRD §6 success criteria final check

- **Goal**: Confirm PRD §6 three success criteria are reflected in verification history.
- **Work**: Compare Verification.md checklist §1 (list·register·manage), §2 (extraction result·selection evidence), §3 (optional MCP) with PRD §6. If each was checked at least once and recorded, mark "완료". If any missing, run that check once and add row to Verification.md.
- **Scope**: Doc comparison + one-time check and one row if needed.

---

## Reference

| Doc | Use |
|-----|-----|
| PRD.md | §2 메뉴·화면, §2-4 선택 근거, §3 API, §4 y2sl-local MCP, §6 성공 기준, §7 추가 요청사항(날짜 포맷 포함) |
| CardDataStructure.md | Card JSON, trigger (all/any/not), score, content, Step 4 정렬·cooldown_group·max_per_user |
| ChemiStructure.md | P_tokens, pair card schema, src P\|A\|B |
| TokenRule.md | items → tokens, where 정규화, L/M/H |
| TokenStructure.md | Token 문법, 카테고리, 위치 표준 |
| UserInfoStructure.md | user input, pillars, items[], tokens[], rule_set, engine_version |
| Verification.md | §6·§7 체크리스트, 전체 흐름 점검, 검증 이력, run_verification.sh |
| Seed.md | Seed 파일 참조, 시드에서 불러오기, 일괄 등록 |
| TestScope.md | Go 테스트 위치, make test-itemncard |
| ExtractionAPI.md | REST (saju_extract_test, pair_extract_test, llm_context_preview) |

---

## Notes

- Tasks 1–4: manual verification + Verification.md 검증 이력.
- Task 4: PRD §7 "데이터 카드 메뉴 이하의 화면에서 생일 및 시간의 입력에 대해서는 yyyy-MM-dd HH:mm 형식으로 텍스트 포매팅 룰을 사용하여 작동하도록 해줘."
- Task 5: doc-only; consolidate after 1–4.
- Task 6: only if an issue was recorded in 1–4; otherwise skip.
- Task 7: run from repo root; recommended before release.
- Task 8: PRD §7 "전체적인 흐름에 이상한점은 없는지, 테스트는 적당한 로직과 범위로 수행되고 있는지 확인" — review only.
- Tasks 9–11: optional; do when resources allow.
- All commands and checks are from repo root unless stated otherwise.

---

## Execution result (task_2026-02-01T113001)

| Task | Status | What was done |
|------|--------|----------------|
| **1** | 수동 수행 대기 | PRD §7 체크리스트 (1)–(5)는 검증 담당자 1회 실행 후 Verification.md 검증 이력에 항목별 결과 기록 필요. 에이전트는 수동 UI 점검 불가. |
| **2** | 수동 수행 대기 | 전체 흐름 점검(사주 인생/연도별/월별, 궁합)은 검증 담당자 1회 실행 후 이력 기록 필요. |
| **3** | 수동 확인 대기 | seed 연동(시드에서 불러오기→일괄 등록→추출 테스트) 검증 담당자 1회 확인 후 "seed 연동 확인 완료" 또는 이슈 1줄 기록 필요. |
| **4** | 수동 확인 대기 | 데이터 카드 화면 생일/시간 입력 yyyy-MM-dd HH:mm 포맷 확인은 검증 담당자 1회 확인 후 Verification.md 행 추가 필요. |
| **5** | Done | Verification.md 검증 이력에 task_2026-02-01T113001 통합 행 추가: Task 1–4 수동 점검 대기, Task 6 해당 없음, Task 7 자동 검증 완료. |
| **6** | 해당 없음 | Tasks 1–4에서 기록된 이슈 없음. 수정 작업 없이 스킵. |
| **7** | Done | Repo root에서 `bash -c 'cd api && make test-itemncard && go build .'` 실행. **통과**: types/itemncard, service/itemncard, service, mcplocal 모두 통과; go build . 성공. Verification.md 검증 이력에 Task 7 행 추가. |
| **8** | Done | 흐름·테스트 범위 검토 완료. TestScope.md 및 make test-itemncard 범위(types/itemncard, service/itemncard, service, mcplocal) 대조. CardDataStructure Step 0–6, ChemiStructure Step 1–5 흐름 대조. **갭 없음**. Verification.md 검증 이력에 Task 8 행 추가. |
| **9** | Skipped | Optional. LLM context preview E2E·OperatorGuide — 선택 항목으로 생략. |
| **10** | Skipped | Optional. y2sl-local MCP E2E·runLoopForSaju.sh docs — 선택 항목으로 생략. |
| **11** | Skipped | Optional. PRD §6 성공 기준 최종 점검 — 선택 항목으로 생략. |

**Remaining / next steps**

- 검증 담당자가 Task 1–4를 1회 수행한 뒤 Verification.md §7 체크리스트·전체 흐름·seed 연동·날짜 포맷에 맞춰 검증 이력 테이블에 항목별 결과(통과/이슈 1줄) 기록.
- 필요 시 Tasks 9–11(LLM context preview E2E, MCP E2E, PRD §6 최종 점검) 선택 실행.
