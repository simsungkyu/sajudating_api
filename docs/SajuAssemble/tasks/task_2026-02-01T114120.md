<!-- Task plan: 사주 추출 결과화면에 LLM 요청 전체 내용 textarea 표시 (CheckList §1). -->
# Task plan: 사주 추출 결과 — LLM 요청 전체 내용 textarea (2026-02-01T114120)

Ordered concrete tasks for **CheckList.md** first remaining item:  
**사주 추출 테스트의 결과화면에, 종합하여 llm에 요청되어야 하는 전체 내용에 대해 textarea 내에 표시하도록 해줘.**

Ref: PRD.md, CardDataStructure.md, ChemiStructure.md, TokenRule.md, UserInfoStructure.md, ExtractionAPI.md, Verification.md.

---

## Current state (reference)

- **admweb**: 사주 추출 테스트 결과 패널에 "LLM 요청 전체 내용" 접기/펼치기 섹션과 read-only textarea가 있음. 사용자가 **불러오기** 버튼을 눌러야 `POST /api/adm/llm_context_preview`로 카드 컨텍스트를 가져와 textarea에 채움.
- **Backend**: `saju_extract_test`는 `user_info` + `selected_cards`만 반환. LLM 컨텍스트는 별도 `llm_context_preview` (card_ids + scope)로 조회.
- **CheckList**: 위 항목이 "remaining"이므로, 결과 화면에서 **종합된 LLM 요청 전체 내용**이 textarea에 **표시**되도록 하는 구체 작업이 필요.

---

## Ordered next tasks

### 1. 정의: "종합하여 llm에 요청되어야 하는 전체 내용" 범위 확정

- **목표**: 사주 추출 결과에서 textarea에 넣을 "전체 내용"이 (a) 카드 컨텍스트만인지, (b) 유저 명식 요약 + 카드 컨텍스트를 한 블록으로 합친 것인지 결정.
- **작업**: ExtractionAPI.md, UserInfoStructure.md를 참고해, 실제 LLM 호출 시 사용할 페이로드 형태(명식 요약 블록 + 카드 컨텍스트 순서/포맷)가 문서에 있는지 확인. 없으면 1문단으로 "사주 추출 시 LLM 요청 전체 내용 = 명식 요약(선택) + 카드 컨텍스트" 정의를 ExtractionAPI.md 또는 본 task 파일 Notes에 추가.
- **범위**: 문서 정리만. 코드 변경 없음.

---

### 2. Backend: 사주 추출 응답에 LLM 컨텍스트 포함 여부 결정 및 구현

- **목표**: 결과 화면에서 추가 클릭 없이 textarea를 채우려면, (A) `saju_extract_test` 응답에 `llm_context`(또는 `llm_request_content`) 필드를 넣을지, (B) 프론트에서 추출 결과 수신 후 바로 `llm_context_preview`를 호출할지 결정.
- **작업**:  
  - (A) 선택 시: `api/dto/itemncard_dto.go`의 `SajuExtractTestResponse`에 선택 필드 추가. `AdminExtractService`(또는 호출처)에서 `selected_cards`가 있을 때 기존 `itemncard.BuildLLMContextFromCards`(또는 LLM 컨텍스트 조립 로직)를 호출해 해당 필드에 담아 반환. ExtractionAPI.md §1 Response에 필드 설명 추가.  
  - (B) 선택 시: 백엔드 변경 없음. 다음 작업에서 프론트가 추출 성공 후 자동으로 `llm_context_preview` 호출.
- **범위**: (A)일 때만 DTO·서비스·문서 수정. 한 가지 방식만 적용.

---

### 3. Frontend: 사주 추출 결과 수신 시 textarea 자동 채우기

- **목표**: 사주 추출 테스트 실행 후 결과가 있고 `selected_cards.length > 0`이면, "LLM 요청 전체 내용" textarea를 사용자 클릭 없이 채움.
- **작업**:  
  - `admweb/src/pages/DataCardsPage.tsx`의 `SajuExtractTestTab`에서, `handleRun` 성공 후 `setResult(res)` 직후(또는 `result`가 바뀐 직후) `selected_cards`가 있으면 `llmContextPreview({ card_ids, scope: 'saju' })` 호출(또는 응답에 `llm_context`가 있으면 그 값 사용).  
  - 가져온(또는 응답의) 문자열을 `llmTextareaContent` 상태에 set.  
  - "LLM 요청 전체 내용" 섹션을 펼친 상태로 두거나, 최소한 한 번 로드되면 펼치기 기본으로 할지 결정 후 반영.  
  - 로딩 중에는 해당 섹션에 로딩 표시(스피너 또는 "로딩…").  
  - `selected_cards.length === 0`이면 기존처럼 "선택된 카드가 없어 LLM 요청 내용이 없습니다." 메시지 유지.  
  - 기존 "불러오기" 버튼은 유지(다시 불러오기용)하거나, 자동 로드로 대체 후 제거(선택).
- **범위**: DataCardsPage.tsx 내 SajuExtractTestTab만. 다른 탭/API 시그니처 변경 없음.

---

### 4. (선택) 종합 내용 = 명식 요약 + 카드 컨텍스트일 때의 조립

- **목표**: Task 1에서 "전체 내용"을 (b) 명식 요약 + 카드 컨텍스트로 정한 경우에만, 한 문자열로 조립해 textarea에 표시.
- **작업**:  
  - 백엔드가 `llm_context`만 줄 경우: 프론트에서 `user_info`(pillars, items_summary, tokens_summary, rule_set, engine_version, mode, period)를 고정 포맷 문자열로 만든 뒤, 그 다음 줄에 카드 컨텍스트를 이어붙여 `llmTextareaContent`에 set.  
  - 백엔드가 "명식 요약 + 카드 컨텍스트" 한 블록을 새 필드로 줄 경우: 해당 필드만 textarea에 set.  
  - 포맷(구분선, 헤더 등)은 ExtractionAPI.md 또는 OperatorGuide에 1문단으로 문서화.
- **범위**: Task 1에서 (b)로 정한 경우에만 수행. (a) 카드 컨텍스트만이면 생략.

---

### 5. 검증 및 문서 반영

- **목표**: 사주 추출 결과 화면에서 LLM 요청 전체 내용이 textarea에 표시되는지 확인하고, 체크리스트/검증 문서에 반영.
- **작업**:  
  - 데이터 카드 → 사주 추출 테스트에서 실행 후, 결과 패널의 "LLM 요청 전체 내용" 섹션에 **추가 클릭 없이** textarea가 채워지는지 확인(선택 카드가 있을 때).  
  - 선택 카드가 없을 때 안내 문구만 나오는지 확인.  
  - Verification.md §7 체크리스트 (4) 항목 설명을 필요 시 수정(예: "불러오기 시" → "결과 표시 시(또는 불러오기 시) textarea에 전체 내용 표시").  
  - 검증 이력에 task_2026-02-01T114120, 항목(4) 결과(통과/이슈 1줄) 추가.
- **범위**: 수동 확인 + Verification.md 최소 수정.

---

## Reference

| Doc | Use |
|-----|-----|
| PRD.md | §2-3 추출 테스트 UI, §2-4 테스트 결과 가시성 |
| CheckList.md | 첫 번째 미완료 항목(사주 추출 결과 — LLM 요청 전체 내용 textarea) |
| ExtractionAPI.md | §1 Saju extraction test, §3 LLM context preview |
| UserInfoStructure.md | 명식 요약 필드(pillars, items_summary, tokens_summary, rule_set, engine_version) |
| CardDataStructure.md | 카드 content → LLM 컨텍스트 조립(Step 5) |
| Verification.md | §7 (4) 사주 추출 결과 — LLM 요청 전체 내용 textarea |

---

## Notes

- Task 1에서 (a)만 쓰기로 하면 Task 4는 생략 가능.
- Task 2에서 (B)를 선택하면 프론트만 수정하고, 자동 호출 시 네트워크 요청이 추출 1회 + llm_context_preview 1회로 늘어남. (A) 선택 시 추출 응답 한 번에 컨텍스트 포함.
- 모든 작업은 repo root 기준으로 실행. 코드 구현은 본 task plan 작성 후 별도 단계에서 수행.

---

## Execution result (2026-02-01)

### Done

1. **Task 1 (정의)**  
   - ExtractionAPI.md §1 Response에 `llm_context` 필드 설명 및 단락 추가: "LLM 요청 전체 내용 = 카드 컨텍스트(선택 카드 content 조립). 명식 요약은 별도 user_info로 전달."

2. **Task 2 (Backend — A 선택)**  
   - `api/dto/itemncard_dto.go`: `SajuExtractTestResponse`에 `LLMContext string` (`json:"llm_context,omitempty"`) 추가.  
   - `api/service/AdminExtractService.go`: `len(selected) > 0`일 때 `itemncard.BuildLLMContextFromCards(selected, defaultLLMContextMaxChars)` 호출 후 `resp.LLMContext` 설정.  
   - ExtractionAPI.md §1 Response 테이블에 `llm_context` 행 추가(이미 반영).

3. **Task 3 (Frontend)**  
   - `admweb/src/api/itemncard_api.ts`: `SajuExtractTestResponse`에 `llm_context?: string` 추가.  
   - `admweb/src/pages/DataCardsPage.tsx` `SajuExtractTestTab`:  
     - `handleRun` 성공 후 `setResult(res)` 직후, `res.selected_cards?.length`이 있으면:  
       - `res.llm_context`가 있으면 그 값으로 `llmTextareaContent` 설정 및 "LLM 요청 전체 내용" 섹션 펼침.  
       - 없으면(구 API 대비) `llmContextPreview({ card_ids, scope: 'saju' })` 자동 호출 후 결과로 textarea 채우고 섹션 펼침, 로딩 중 스피너 표시.  
     - "불러오기" 버튼 유지(재불러오기용).  
     - 선택 카드 없을 때 기존 안내 문구 유지.  
     - 로딩 시 "불러오기" 옆에 `CircularProgress` 표시.

4. **Task 4**  
   - 생략. "전체 내용"을 카드 컨텍스트만으로 정의(ExtractionAPI.md 반영).

5. **Task 5 (검증·문서)**  
   - Verification.md §7 체크리스트 (4): "불러오기 시" → "결과 표시 시(또는 불러오기 시)" 로 수정.  
   - Verification.md 검증 이력에 task_2026-02-01T114120, §7 (4) 구현 완료 행 추가.  
   - CheckList.md 첫 번째 항목 "사주 추출 테스트의 결과화면에 … textarea …" 를 `- [x]`로 변경.

### Status

- **구현**: 완료.  
- **API 빌드**: `cd api && go build .` 성공 확인.  
- **테스트**: `go test ./...` / `make test-itemncard` 는 환경에 따라 MongoDB 등으로 실패할 수 있음. 로컬에서 `cd api && make test-itemncard` 및 `go build .` 실행 권장.

### Remaining / Next steps

- §7 (4) 수동 확인: 데이터 카드 → 사주 추출 테스트 실행 후, 결과 패널의 "LLM 요청 전체 내용" 섹션에 **추가 클릭 없이** textarea가 채워지는지(선택 카드가 있을 때), 선택 카드가 없을 때 안내 문구만 나오는지 확인.  
- (선택) 궁합 추출 테스트에도 동일하게 결과 수신 시 LLM textarea 자동 채우기 적용 시 CheckList §2 항목 진행.
