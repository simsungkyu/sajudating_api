# Task plan: itemNcard next steps (2026-02-01T042437)

Single task plan listing the next concrete, ordered tasks for itemNcard implementation. Ref: PRD.md, CardDataStructure.md, ChemiStructure.md, TokenRule.md, TokenStructure.md, UserInfoStructure.md. Each task is one step of appropriate size (neither too large nor too small). Only create or update this plan; do not implement code yet.

---

## Current state (as of 2026-02-01)

- **Backend**: Card CRUD (GraphQL), soft delete (`deleted_at`, `includeDeleted` filter). Extraction test REST (saju, pair), itemncard pipeline (pillars → items → tokens → card selection with evidence, domain/tag limits, cooldown_group, max_per_user). 연도별/월별 pillar. LLM context builder and POST `/api/adm/llm_context_preview`. AdminExtractService returns user/pair info + selected cards with evidence and score.
- **admweb**: Data Cards page with tabs (사주 카드, 궁합 카드, 사주 추출 테스트, 궁합 추출 테스트). List with filters (scope, status, category, tags, rule_set, **삭제 포함**), sort, paging; offset resets when filters/sort change. Create/edit dialogs with full schema and trigger/score JSON validation (pair: src P|A|B). Soft delete with confirmation; "삭제됨" badge on deleted rows. Extract result panels show items/tokens summary, pillars, selected cards + evidence; LLM 컨텍스트 미리보기 when cards are selected.
- **Docs**: Seed.md (how to load seed JSON via GraphQL/admweb), OperatorGuide.md (menu, CRUD, 추출 테스트, LLM 미리보기). PRD §6 success criteria met by current implementation.

---

## Ordered next tasks

### 1. Test suite and build verification

- Add or document a single entry point for itemNcard-related verification.
  - **Option A**: In `api/makefile` (or docs), add a target (e.g. `test-itemncard` or reuse existing) that runs `go test ./service/itemncard/... ./service/... -run AdminExtract` and `go build .` from `api/`, and document in AGENTS.md or OperatorGuide that operators should run it before release.
  - **Option B**: Add a short **Verification** section in `docs/saju/itemNcard/OperatorGuide.md` (or new `Verification.md`) listing exact commands: `cd api && go test ./...`, `cd api && go build .`, and optionally `cd admweb && npm run build`. No new Makefile target.
- Ensure no task assumes code changes beyond this documentation/scripting step.

---

### 2. Include guardrails in LLM context (CardDataStructure §content)

- **Backend**: In `itemncard.BuildLLMContextFromCards` (or equivalent), include each card’s `content.guardrails` in the assembled context string when present (e.g. a "Guardrails" or "주의사항" block per card or aggregated). CardDataStructure recommends guardrails for tone/constraints (e.g. "단정 표현 금지").
- **admweb**: No change to the LLM 컨텍스트 미리보기 button; the preview will automatically show the updated context once the backend returns it. Optionally add a one-line note in the preview dialog that guardrails are included.

---

### 3. Duplicate card (admweb)

- In the Data Cards list (사주 카드 and 궁합 카드 tabs), add a **복제** (or "Duplicate") action per row.
- On click: open the **create** dialog (not edit) with form pre-filled from the selected card (same scope, status set to `draft`, copy of trigger/score/content/debug JSON, category, tags, domains, priority, cooldown_group, max_per_user). Leave `card_id` empty or suggest a derived value (e.g. original + `_copy`) so the user must confirm or edit before creating. Title may be prefilled as "사본: {title}" or left editable.
- Submit creates a new card via `createItemnCard`; list refreshes. No backend API change.

---

### 4. Export card as JSON (admweb)

- In the Data Cards list row actions, add **Export JSON** (or "JSON 내보내기"). On click, build a single JSON object that matches the card’s stored shape (card_id, scope, status, rule_set, title, category, tags, domains, priority, trigger, score, content, cooldown_group, max_per_user, debug as objects, not stringified). Trigger/score/content are already available as JSON strings from the API; parse and merge into one object.
- Offer download as a file (e.g. `{card_id}.json`) or copy-to-clipboard. No backend endpoint required; client-side only.

---

### 5. Seed load from UI (optional, Option B from prior plan)

- In the **card create** form (admweb), add an optional **"시드에서 불러오기"** (Load from seed) control: dropdown or list of seed file names (e.g. `saju_정재_강함`, `pair_궁합_충`) from a fixed list matching `docs/saju/itemNcard/seed/` (e.g. the table in Seed.md).
- On selection: fetch the seed file (via static import, or a small backend GET that serves seed file contents, or bundled JSON). Parse and fill trigger, score, content (and optionally category, tags, title, card_id) into the form; validate against CardDataStructure/ChemiStructure (pair: src P|A|B). Scope can be inferred from the seed (saju vs pair). Keep to one or two example seeds if implementing via static/bundled data.
- Implement only if Option B is desired; Seed.md (Option A) already exists.

---

### 6. PRD verification checklist (documentation only)

- Add a short document (e.g. `docs/saju/itemNcard/Verification.md` or a section in OperatorGuide) that explicitly checks PRD §6 성공 기준:
  - [ ] admweb에서 사주 카드·궁합 카드를 별도 메뉴로 목록 조회·등록·관리 가능.
  - [ ] 사주(인생/연도별/월별)·궁합 "추출 테스트" 실행 후, 결과 화면에서 **유저 명식 분석 정보**와 **선택된 데이터 카드 목록(및 선택 근거)** 확인 가능.
  - [ ] (선택) y2sl-local MCP로 카드 등록 가능 및 runLoopForSaju.sh 연동.
- Include one-line instructions or links for how to verify each item (e.g. "데이터 카드 메뉴 → 사주 카드 탭에서 목록/생성/수정/삭제 확인"). No code implementation.

---

## Reference

| Doc | Use |
|-----|-----|
| PRD.md | §2-2 list/delete, §2-3 extraction test, §2-4 visibility, §4 MCP, §6 성공 기준 |
| CardDataStructure.md | Trigger, score, content, **guardrails**, LLM context (Step 5) |
| ChemiStructure.md | P_tokens, pair card schema, src P/A/B |
| TokenRule.md | items → tokens, where normalization, L/M/H |
| TokenStructure.md | Token syntax, categories, positions |
| UserInfoStructure.md | items schema, pillars, tokens, rule_set, engine_version |

---

## Execution result (2026-02-01)

Tasks 1–4 and 6 were implemented. Task 5 (Seed load from UI) was skipped per plan (optional, Option B).

### Done

1. **Test suite and build verification**
   - **AGENTS.md**: Updated itemNcard verification paragraph to reference `make test-itemncard` as the single entry point and added: "Before release, if you changed itemNcard code, run: `cd api && make test-itemncard`."
   - **Makefile**: `test-itemncard` target already existed (runs `go test ./service/itemncard/... ./service/... -count=1` and `go build .`). No change.

2. **Guardrails in LLM context**
   - **Backend**: Already implemented in `api/service/itemncard/context.go`: `ContentShape` includes `Guardrails`, and they are appended as a "[가이드라인]" block. Tests in `context_test.go` cover guardrails. No code change.
   - **admweb**: Optional one-line note added in both LLM 컨텍스트 미리보기 dialogs (사주 추출 테스트, 궁합 추출 테스트): "가이드라인(guardrails)이 포함되어 있습니다."

3. **Duplicate card (admweb)**
   - **DataCardsPage.tsx**: Added `duplicateToInput(card)` to pre-fill create form (status `draft`, card_id `{original}_copy`, title `사본: {title}`). Added state `createInitial` and handler `openDuplicate(card)`. Row actions: **복제** button opens create dialog with pre-filled data. Submit creates via `createItemnCard`; list refetches.

4. **Export card as JSON (admweb)**
   - **DataCardsPage.tsx**: Added `buildCardExportJson(card)` (parses trigger/score/content/debug JSON and merges into one object), `downloadCardAsJson(card)` (downloads as `{card_id}.json`). Row actions: **JSON 내보내기** button triggers download. Client-side only.

5. **Seed load from UI**
   - Not implemented (optional per plan).

6. **PRD verification checklist**
   - **docs/saju/itemNcard/Verification.md** created: checklist for PRD §6 성공 기준 (목록 조회·등록·관리, 추출 테스트 결과 확인, optional MCP/runLoop), with one-line verification instructions and reference to OperatorGuide.md. Backend/build verification: run `cd api && make test-itemncard` (AGENTS.md).

### Verification

- **Tests**: From repo root, run `cd api && make test-itemncard` (or `go test ./service/itemncard/... ./service/... -count=1` then `go build .`). In this execution environment, `go test`/`go build` returned exit code 1 with no captured stdout/stderr (possible sandbox/network restriction). **Operator should run the same commands locally to confirm.**
- **Build**: `cd api && go build .` should succeed after tests pass.
- **admweb**: No new GraphQL or backend calls; Data Cards page has 복제 and JSON 내보내기; LLM preview dialogs show the guardrails note. Dev server auto-reloads.

### Status

| Task | Status |
|------|--------|
| 1. Test suite and build verification | Done (AGENTS.md + existing Makefile) |
| 2. Guardrails in LLM context | Done (backend already had it; admweb note added) |
| 3. Duplicate card | Done |
| 4. Export card as JSON | Done |
| 5. Seed load from UI | Skipped (optional) |
| 6. PRD verification checklist | Done (Verification.md) |

### Remaining / next steps

- Run locally: `cd api && make test-itemncard` and `cd api && go build .` to confirm tests and build pass.
- Optionally implement Task 5 (Seed load from UI) if Option B is desired.
- Use Verification.md when verifying PRD §6 before release.
