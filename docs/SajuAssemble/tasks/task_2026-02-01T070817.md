<!-- Ordered task plan for itemNcard next steps; ref PRD, CardDataStructure, ChemiStructure, TokenRule, TokenStructure, UserInfoStructure. -->
# Task plan: itemNcard next steps (2026-02-01T070817)

Ordered concrete tasks for itemNcard implementation. Ref: PRD.md, CardDataStructure.md, ChemiStructure.md, TokenRule.md, TokenStructure.md, UserInfoStructure.md.

---

## Current state (as of 2026-02-01)

- **Backend**: Card CRUD (GraphQL), soft delete; extraction REST (saju: 인생/연도별/월별, pair); itemncard pipeline (pillars → items → tokens → card selection with evidence per CardDataStructure/ChemiStructure); LLM context builder and `POST /api/adm/llm_context_preview`; y2sl-local MCP (register_card, update_card, list_cards). Seed structure validation in `api/types/itemncard/`.
- **admweb**: Data Cards page with tabs (사주 카드, 궁합 카드, 사주 추출 테스트, 궁합 추출 테스트); list/filter/sort/paging; create/edit with trigger/score JSON validation (pair: src P|A|B); PillarDisplay (양=볼드, 오행=컬러); A/B 명식 요약; selected cards + evidence; LLM 요청 전체 내용 textarea (saju/pair); 시드에서 불러오기, 일괄 등록.
- **Docs**: ExtractionAPI.md, Seed.md, OperatorGuide.md, Verification.md (§6·§7, 전체 흐름, 검증 이력), TestScope.md, run_verification.sh.
- **Pending from prior plan**: PRD §7 체크리스트 (1)–(5) 수동 점검, 전체 흐름 점검, seed 연동 확인이 검증 이력에 미기록 상태. 선택 항목(LLM 미리보기 E2E, MCP E2E·runLoopForSaju.sh, PRD §6 최종 체크) 미실행.

---

## Ordered next tasks

### 1. PRD §7 체크리스트 (1)–(5) 1회 수행 및 Verification.md 이력 기록

- **목표**: PRD §7 추가 요청사항 5항목이 구현대로 동작하는지 1회 점검하고 결과를 Verification.md에 기록.
- **작업**: Verification.md **§7 체크리스트** 5항목을 순서대로 수행: (1) 사주 추출 결과화면 — 원국 음양 볼드·오행 컬러 표시 확인, (2) 궁합 추출 결과화면 — A/B 명식 분석 정보 요약 표시 확인, (3) seed 폴더 참조·시드에서 불러오기·일괄 등록 확인, (4) 사주 추출 — LLM 요청 전체 내용 textarea 확인, (5) 궁합 추출 — LLM 요청 전체 내용 textarea 확인. 각 항목별 통과/미통과와 발견 이슈(있으면 1줄 요약)를 메모한 뒤, Verification.md **검증 이력** 테이블에 항목별 결과를 기록.
- **범위**: 수동 점검 + Verification.md 검증 이력 1행(또는 항목별 행) 추가; 코드 변경 없음.

---

### 2. 전체 흐름 점검 (사주 인생/연도별/월별, 궁합) 및 Verification.md 이력 기록

- **목표**: 사주·궁합 추출 테스트 전체 흐름이 끝까지 정상 동작하는지 1회 점검하고 결과를 문서에 기록.
- **작업**: Verification.md **전체 흐름 점검** 절차에 따라 실행: (1) 사주 추출 — 인생 모드 실행 후 결과 패널(원국·items/tokens·선택 카드·evidence·LLM textarea) 확인, (2) 사주 추출 — 연도별 모드 실행 후 동일 확인, (3) 사주 추출 — 월별 모드 실행 후 동일 확인, (4) 궁합 추출 — A/B 입력 후 실행, 결과 패널(A/B 명식·P_tokens·선택 카드·evidence·LLM textarea) 확인. 이상 유무와 발견 이슈(있으면 1줄 요약)를 메모한 뒤, Verification.md 검증 이력에 전체 흐름 결과(사주 인생·연도별·월별·궁합)를 기록.
- **범위**: 수동 점검 + Verification.md 검증 이력 보강; 코드 변경 없음.

---

### 3. seed 폴더 파일과 추출 결과 연동 확인 (PRD §7 (3) 심화)

- **목표**: seed 폴더 내 JSON이 실제 추출 시 카드 풀에 반영되고, 선택 카드로 등장할 수 있는지 1회 확인.
- **작업**: Seed.md "Seed 파일 참조 현황"과 `docs/saju/itemNcard/seed/` 파일 목록 대조. admweb "시드에서 불러오기"로 1개 이상 시드(예: saju_정재_강함, pair_궁합_충) 불러와 일괄 등록 후, 해당 트리거를 만족하는 생년월일(또는 A/B 쌍)로 추출 테스트 실행. 결과에 해당 카드가 선택되는지 확인. 미반영 시 원인(카드 미등록, trigger 불일치, tokens 생성 규칙) 1줄 문서화; 정상 시 Verification.md 검증 이력에 "seed 연동 확인 완료" 1행 추가.
- **범위**: 수동 확인 + 문서 1행 또는 이슈 1줄; 코드 변경 없음(이슈 발견 시 별도 태스크).

---

### 4. PRD §7 (6) 전체 흐름·테스트 범위 확인 및 문서 반영

- **목표**: PRD §7 (6) "전체적인 흐름에 이상한점은 없는지, 테스트는 적당한 로직과 범위로 수행되고 있는지" 확인하고 문서에 반영.
- **작업**: TestScope.md "흐름·테스트 범위 대조" 및 "테스트 로직·범위 확인" 절과 코드(`api/service/itemncard/`, AdminExtractService, types/itemncard, mcplocal) 대조. 입력→pillars→items→tokens→카드 선택→결과 반환 흐름과 Go 테스트(itemncard, AdminExtractService_test, mcplocal, types/itemncard/validation) 커버리지가 적정한지 확인. 이상 없으면 Verification.md 또는 TestScope.md에 "PRD §7 (6) 흐름·테스트 범위 확인 완료" 1행(또는 기존 문단 보강) 추가; 이상 있으면 1건 이슈 기록 또는 소규모 보완.
- **범위**: 문서·코드 대조 + Verification.md 또는 TestScope.md 1행(또는 문단) 추가; 필요 시 1건 수정.

---

### 5. 검증 발견 이슈 1건 수정 (조건부)

- **목표**: Task 1·2에서 기록된 이슈가 1건 이상 있을 때, 우선순위 높은 1건만 수정.
- **작업**: 검증 이력에 정리된 이슈(표시 오류, 누락, 버그) 중 **1건**을 선정하여 수정. 예: PillarDisplay(양/오행), A/B 명식 요약 레이아웃, evidence 표시, LLM textarea 접기/펼치기·복사, 시드 옵션 대응 등. 이슈가 없거나 이미 별도 태스크로 정리된 경우 이 태스크는 "해당 없음"으로 생략.
- **범위**: 1건 수정에 그침.

---

### 6. 로컬 자동 검증 재실행 및 Verification.md 이력 확인/추가

- **목표**: itemNcard 관련 테스트·빌드가 통과하는지 repo root 기준으로 1회 확인하고 검증 이력에 반영.
- **작업**: repo root에서 `cd api && make test-itemncard && go build .` 실행(또는 `bash docs/saju/itemNcard/run_verification.sh`). 통과 시 Verification.md 검증 이력 테이블에 해당 실행 결과(날짜, 결과, 비고)가 있으면 확인만, 없으면 1행 추가. 미통과 시 원인 1건 수정 또는 이슈 기록 후 재실행.
- **범위**: 명령 실행 + Verification.md 확인 또는 1행 추가; 필요 시 1건 수정.

---

### 7. (선택) LLM 컨텍스트 미리보기 E2E 수동 확인 및 문서 보강

- **목표**: admweb에서 "LLM 컨텍스트 미리보기" 호출 후 대화상자에 결과가 표시되는지 확인하고, 절차가 문서에 있으면 정합성 확인.
- **작업**: 데이터 카드 → 사주 또는 궁합 추출 테스트 실행 후, LLM 컨텍스트 미리보기 버튼/액션으로 `POST /api/adm/llm_context_preview` 호출이 이루어지고, 응답이 UI에 표시되는지 수동 확인. OperatorGuide 또는 Verification.md에 해당 절차가 없으면 1~2문단 추가. 문제가 있으면 1건 수정 또는 이슈 기록.
- **범위**: 수동 확인 + 필요 시 문서 1~2문단 또는 1건 수정.

---

### 8. (선택) y2sl-local MCP E2E 및 runLoopForSaju.sh 문서화 확인

- **목표**: Verification.md §3 "y2sl-local MCP로 카드 등록 가능 및 runLoopForSaju.sh 연동" 체크 가능 여부 및 문서 정합성 확인.
- **작업**: API를 `LOCAL_MCP=true`로 띄운 뒤, MCP 클라이언트에서 `register_card`로 카드 1건 등록하고 admweb 데이터 카드 목록에서 해당 card_id 조회되는지 확인. runLoopForSaju.sh 및 OperatorGuide §MCP 연동 문서와 대조하여 절차가 문서화되어 있는지 확인. 미구현 시 체크 생략 가능. 문서 누락 시 OperatorGuide 또는 runLoopForSaju.sh 주석 1~2문단 보강.
- **범위**: 수동 확인 + 필요 시 문서 1~2문단 보강.

---

### 9. (선택) PRD §6 성공 기준 최종 체크 및 이력 반영

- **목표**: PRD §6 성공 기준 3항이 검증 이력에 반영되었는지 1회 확인.
- **작업**: Verification.md 체크리스트 §1(목록·등록·관리), §2(추출 테스트 결과·선택 근거), §3(선택, MCP)와 PRD §6 대조. 각 항목이 1회 이상 점검되었고 이력에 기록되어 있으면 "완료" 메모. 누락 시 해당 항목 1회 점검 후 이력에 추가.
- **범위**: 문서 대조 + 필요 시 1회 점검 및 Verification.md 1행 추가.

---

## Reference

| Doc | Use |
|-----|-----|
| PRD.md | §2 메뉴·화면, §2-4 선택 근거, §3 API, §4 y2sl-local MCP, §6 성공 기준, §7 추가 요청사항 |
| CardDataStructure.md | Card JSON, trigger (all/any/not), score, content, guardrails, Step 4 정렬 |
| ChemiStructure.md | P_tokens, pair card schema, src P\|A\|B |
| TokenRule.md | items → tokens, where 정규화, L/M/H |
| TokenStructure.md | Token 문법, 카테고리, 위치 표준 |
| UserInfoStructure.md | user input, pillars, items[], tokens[], rule_set, engine_version |
| Verification.md | §6·§7 체크리스트, 전체 흐름 점검, 검증 이력, run_verification.sh |
| Seed.md | Seed 파일 참조 현황, 시드에서 불러오기, 일괄 등록, 시드 파일 검증 |
| TestScope.md | Go 테스트 위치, make test-itemncard, 흐름·테스트 범위 대조, PRD §7 (6) |
| ExtractionAPI.md | REST 계약 (saju_extract_test, pair_extract_test, llm_context_preview) |

---

## Notes

- Task 1–3: 검증 담당자 수동 점검 + Verification.md 검증 이력 기록.
- Task 4: PRD §7 (6) 흐름·테스트 범위 확인 — 문서·코드 대조 후 Verification.md 또는 TestScope.md에 1행 추가.
- Task 5: 발견 이슈가 있을 때만 1건 수정; 없으면 "해당 없음".
- Task 6: 릴리스 전 권장; make test-itemncard + go build 확인 후 이력 확인/추가.
- Task 7–9: 선택 항목; 리소스 허용 시 수행.
- 모든 명령·점검은 repo root 기준으로 수행(명령 예시는 repo root 또는 api 디렉터리 명시).

---

## Execution result (2026-02-01)

**Done**

- **Task 4 (PRD §7 (6) 흐름·테스트 범위 확인)**  
  TestScope.md "흐름·테스트 범위 대조" 및 "테스트 로직·범위 확인" 절과 코드(`api/service/AdminExtractService.go`, `api/service/itemncard/`) 대조 완료. 입력→pillars→items→tokens→카드 선택→결과 반환 흐름이 AdminExtractService에서 itemncard 패키지(PillarsFromBirth, ItemsFromPillars, ItemsToTokens, SelectSajuCards/SelectPairCards) 호출로 구현됨. Go 테스트(itemncard, AdminExtractService_test, mcplocal, types/itemncard/validation)가 해당 로직·범위를 커버함. Verification.md 검증 이력에 1행 추가(PRD §7 (6) 흐름·테스트 범위 재확인).

- **Task 6 (로컬 자동 검증)**  
  repo root에서 `go -C api test ./types/itemncard/... ./service/itemncard/... ./service/... ./mcplocal/... -count=1` 및 `go -C api build .` 실행. **통과.** types/itemncard, service/itemncard, service, mcplocal 패키지 모두 PASS. 추가로 `go -C api test ./... -count=1` 실행하여 전체 테스트 통과 확인(ext_dao, mcplocal, service, service/itemncard, types/itemncard, utils). 빌드 성공(외부 의존 go-m1cpu 경고만 있음). Verification.md 검증 이력에 해당 실행 결과 1행 추가.

**Status**

- **Task 1 (PRD §7 체크리스트 (1)–(5))**  
  미수행. 검증 담당자 수동 점검 필요. Verification.md §7 체크리스트 5항목 순서대로 수행 후 항목별 통과/미통과와 발견 이슈를 검증 이력에 기록해야 함.

- **Task 2 (전체 흐름 점검)**  
  미수행. 검증 담당자 수동 점검 필요. Verification.md "전체 흐름 점검" 절차에 따라 사주 인생/연도별/월별·궁합 흐름 1회 실행 후 결과를 검증 이력에 기록해야 함.

- **Task 3 (seed 폴더 연동 확인)**  
  미수행. 검증 담당자 수동 확인 필요. Seed.md와 seed/ 폴더 대조, "시드에서 불러오기"·일괄 등록 후 추출 테스트로 카드 반영 여부 확인 및 이력 기록.

- **Task 5 (검증 발견 이슈 1건 수정)**  
  해당 없음. Task 1·2 수동 점검 후 이슈가 기록되면 1건 수정.

- **Task 7–9 (선택)**  
  미수행. LLM 미리보기 E2E, MCP E2E·runLoopForSaju.sh 문서화, PRD §6 최종 체크는 리소스 허용 시 수행.

**Remaining / Next steps**

1. 검증 담당자: Task 1·2·3 수동 수행 → Verification.md 검증 이력에 §7 (1)–(5) 항목별 결과 및 전체 흐름(사주 인생/연도별/월별, 궁합)·seed 연동 결과 기록.
2. 이슈 발견 시 Task 5로 1건 수정.
3. (선택) Task 7–9 수행.
4. 로컬에서 추가 확인 시: `cd api && make test-itemncard && go build .` (repo root 기준 `go -C api` 동일).
