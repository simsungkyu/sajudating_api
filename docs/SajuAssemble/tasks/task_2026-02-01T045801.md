# Task plan: itemNcard next steps (2026-02-01T045801)

Single task plan listing the next concrete, ordered tasks for itemNcard implementation. Ref: PRD.md, CardDataStructure.md, ChemiStructure.md, TokenRule.md, TokenStructure.md, UserInfoStructure.md. Each task is one step of appropriate size (neither too large nor too small). Only create or update this plan; do not implement code yet.

---

## Current state (as of 2026-02-01)

- **Backend**: Card CRUD (GraphQL), soft delete, extraction test REST (saju: 인생/연도별/월별, pair). itemncard pipeline: pillars → items → tokens → card selection with evidence; domain/tag limits, cooldown_group, max_per_user. LLM context builder and POST `/api/adm/llm_context_preview`. AdminExtractService returns user/pair info + selected cards with evidence and score. y2sl-local MCP: `register_card`, `update_card`, `list_cards` in mcplocal/cardtools.go.
- **admweb**: Data Cards page with tabs (사주 카드, 궁합 카드, 사주 추출 테스트, 궁합 추출 테스트). List with filters, sort, paging; create/edit with full schema and trigger/score JSON validation (pair: src P|A|B). Soft delete, 복제, JSON 내보내기, 시드에서 불러오기 (6 options), 일괄 등록. Extract result: items/tokens summary, PillarDisplay (양=볼드, 오행=컬러), A/B 명식 요약, selected cards + expandable evidence; LLM 요청 전체 내용 textarea (saju/pair); copy-to-clipboard; LLM 컨텍스트 미리보기.
- **Docs**: ExtractionAPI.md, Seed.md (Seed 파일 참조 현황), OperatorGuide.md, Verification.md (PRD §6 + §7 체크리스트), 연도별_월별_pillar.md, run_verification.sh. PRD §6 성공 기준 충족. PRD §7 추가 요청사항 대부분 반영; §7 마지막 항목(흐름 점검·테스트 범위 확인)은 미수행.

---

## Ordered next tasks

### 1. 전체 흐름 점검 문서화 (Verification.md)

- PRD §7: "전체적인 흐름에 이상한점은 없는지" 대응. **Verification.md**에 **"전체 흐름 점검"** 절을 추가한다.
- 내용: (1) **사주 추출** — 인생/연도별/월별 각 모드에서 생년월일시 입력 → 실행 → 결과 패널에 원국·items/tokens 요약·선택 카드·evidence·LLM textarea가 표시되는지 확인하는 단계별 체크리스트. (2) **궁합 추출** — A/B 생년월일시 입력 → 실행 → 결과에 A/B 명식 요약·P_tokens 요약·선택 궁합 카드·evidence·LLM textarea가 표시되는지 확인하는 단계별 체크리스트.
- 문서만 추가; 코드 변경 없음. 검증 담당자가 한 번씩 따라 할 수 있는 수준으로 작성.

---

### 2. 테스트 범위 문서화 및 한 건 보강

- PRD §7: "테스트는 적당한 로직과 범위로 수행되고 있는지 확인" 대응.
- **Verification.md** 또는 **docs/saju/itemNcard/** 내 짧은 **TestScope.md**에 다음을 정리한다: (1) itemncard 관련 Go 테스트가 어디에 있는지(예: `api/service/itemncard/`, `api/service/AdminExtractService_test.go`, `api/mcplocal/cardtools_test.go`). (2) 커버하는 범위 요약(items→tokens, trigger 평가, 사주/궁합 카드 선택, MCP 도구). (3) 수동 검증이 필요한 부분(admweb 추출 테스트 UI, LLM preview 호출).
- 이어서 **한 건**만 보강: 빠져 있는 명확한 엣지가 있으면 해당 테스트 추가(예: pair 카드에서 `src: "A"` / `src: "B"` 조건 평가, 또는 빈 tokens일 때 카드 0건 반환). 엣지 케이스가 이미 충분히 커버되어 있으면 테스트 추가 생략하고 문서만 반영.

---

### 3. Seed 옵션 확대 또는 미참조 파일 정리

- **시드에서 불러오기**는 현재 6개 옵션만 노출; `seed/` 폴더에는 그 외 다수 JSON이 있음(Seed.md "seed/ 폴더 중 UI에서 참조되지 않는 파일" 참고).
- **선택 A**: admweb **시드에서 불러오기**에 2~3개 옵션을 추가해 `seed/` 내 다른 파일(예: saju_격국_정재격, pair_궁합_형, saju_확신_전체 등)을 참조하도록 한다. `admweb/src/data/seedCards.ts` 및 Seed.md 표 업데이트.
- **선택 B**: 코드 변경 없이 **Seed.md**만 보강 — "미참조 파일"을 카테고리별로 정리(십성/격국/용신/궁합 등)하고, 일괄 등록으로 불러오는 방법만 명시. 선택 A/B 중 하나만 수행.

---

### 4. PRD §7 체크리스트 1회 실행 및 이슈 정리

- **Verification.md**의 "PRD §7 (추가 요청사항) 체크리스트" 5항목을 실제로 한 번 수행한다(원국 표시, A/B 명식, seed 참조, 사주 LLM textarea, 궁합 LLM textarea).
- 발견된 이슈(표시 오류, 누락, 버그)가 있으면 **한 건씩** 구체적인 수정 태스크로 정리하거나 즉시 수정한다. 이슈 없으면 "검증 완료"로 체크리스트에 기록. 범위는 §7 체크리스트 수행 및 그로 인한 소규모 수정만.

---

### 5. y2sl-local MCP 사용 안내 보강

- PRD §4(선택): "runLoopForSaju.sh 등에서 agent가 해당 MCP를 사용하도록 프롬프트/설정 참조."
- **OperatorGuide.md** 또는 **runLoopForSaju.sh** 주석/인라인 문서에 다음을 추가한다: (1) y2sl-local MCP의 `register_card`, `update_card`, `list_cards` 호출 방법 요약. (2) 카드 JSON 전달 방식(시드 파일 경로 참조 또는 에이전트가 생성한 JSON). (3) API 서버를 `LOCAL_MCP=true` 등으로 띄운 뒤 MCP를 사용하는 절차 한 줄 요약.
- 문서/주석만 추가; MCP 서버·API 코드 변경 없음.

---

### 6. 추출 파이프라인 엣지 케이스 테스트 1건

- **AdminExtractService** 또는 **itemncard** 카드 선택 로직에서 아직 테스트되지 않은 **엣지 1건**을 골라 테스트를 추가한다. 예: (A) 사주 추출 시 `any`가 비어 있고 `all`만 있는 카드가 올바르게 선택되는지, (B) pair 추출 시 `not`만 만족해서 탈락하는 카드가 결과에 포함되지 않는지, (C) 동일 우선순위/score일 때 정렬이 안정적인지 등.
- 테스트 1개 추가에 그침; 대규모 리팩터링 없음.

---

## Reference

| Doc | Use |
|-----|-----|
| PRD.md | §2 메뉴·화면, §2-4 선택 근거, §3 API, §4 y2sl-local MCP, §6 성공 기준, **§7 추가 요청사항(흐름·테스트 확인)** |
| CardDataStructure.md | Card JSON, trigger (all/any/not), score, content |
| ChemiStructure.md | P_tokens, pair card schema, src P\|A\|B |
| TokenRule.md | items → tokens, where 정규화, L/M/H |
| TokenStructure.md | Token 문법, 카테고리, 위치 표준 |
| UserInfoStructure.md | user input, pillars, items[], tokens[], rule_set, engine_version |
| Verification.md | PRD §6·§7 체크리스트, 검증 이력, (추가) 전체 흐름 점검·테스트 범위 |
| Seed.md | Seed 파일 참조 현황, 시드에서 불러오기 옵션 |

---

## Notes

- Tasks 1–2: PRD §7 흐름 점검·테스트 범위 확인을 문서화하고 테스트 한 건 보강.
- Task 3: seed 옵션 확대 또는 미참조 파일 문서 정리(둘 중 하나).
- Task 4: §7 체크리스트 실제 실행 및 발견 이슈 소규모 수정.
- Task 5: MCP 사용 안내(문서/주석).
- Task 6: 추출 파이프라인 엣지 케이스 테스트 1건.
- 모든 명령은 repo root 기준; 백엔드 검증은 `cd api && make test-itemncard` 등으로 수행.

---

## Execution result (2026-02-01)

**Done**

1. **Task 1 — 전체 흐름 점검 문서화**: Verification.md에 "전체 흐름 점검" 절 추가. 사주 추출(인생/연도별/월별) 단계별 체크리스트, 궁합 추출 단계별 체크리스트 포함.
2. **Task 2 — 테스트 범위 문서화 및 한 건 보강**: docs/saju/itemNcard/TestScope.md 신규 작성 — Go 테스트 위치(api/service/itemncard/, AdminExtractService_test.go, mcplocal/cardtools_test.go, types/itemncard/validation_test.go), 커버 범위 요약, 수동 검증 필요 부분. 엣지 1건: api/service/itemncard/saju_test.go에 TestSelectSajuCardsFromCards_EmptyTokenSet_ZeroCards 추가(빈 tokenSet 시 0건 반환).
3. **Task 3 — Seed 미참조 파일 정리 (선택 B)**: Seed.md만 보강. "미참조 파일 카테고리별 정리" 표 추가(십성/격국/용신/강약/관계/오행/신살/육친/확신/궁합). 일괄 등록으로 불러오는 방법 명시.
4. **Task 4 — §7 체크리스트**: Verification.md에 §7 체크리스트 실행 안내 문단 추가; 검증 이력 테이블에 "§7 체크리스트 수동 수행 대기" 행 추가. (실제 1회 실행은 검증 담당자 수행 후 체크 및 이력 기록.)
5. **Task 5 — y2sl-local MCP 사용 안내**: OperatorGuide.md "MCP 연동"에 "y2sl-local MCP 사용 안내" 서브섹션 추가 — 절차 한 줄, register_card/update_card/list_cards 요약, 카드 JSON 전달 방식(A: 시드 파일, B: 에이전트 생성). runLoopForSaju.sh 주석에 list_cards 및 카드 JSON 전달 방식 보강.
6. **Task 6 — 추출 파이프라인 엣지 테스트 1건**: api/service/itemncard/pair_test.go에 TestEvaluatePairTrigger_NotFails 추가 — pair 카드에서 not-token(P set에 존재)이 있으면 탈락하는지 검증.

**Status**

- 문서: Verification.md, TestScope.md, Seed.md, OperatorGuide.md, runLoopForSaju.sh 반영 완료.
- 코드: saju_test.go(EmptyTokenSet_ZeroCards), pair_test.go(NotFails) 테스트 추가만 수행.

**Verification**

- 테스트·빌드: 실행 환경에서 `cd api && make test-itemncard` 및 `go build .` 출력이 캡처되지 않았음. 로컬에서 확인 권장: repo root에서 `cd api && make test-itemncard` 실행 후 `go build .` 성공 여부 확인.

**Remaining / next steps**

- 검증 담당자가 Verification.md §7 체크리스트 5항목 및 "전체 흐름 점검" 체크리스트를 1회 수행 후, 발견 이슈 수정 또는 검증 완료로 이력 기록.
- 필요 시 TestScope.md 참고하여 추가 테스트 범위 확대.
