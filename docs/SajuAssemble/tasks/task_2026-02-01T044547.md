# Task plan: itemNcard next steps (2026-02-01T044547)

Single task plan listing the next concrete, ordered tasks for itemNcard implementation. Ref: PRD.md, CardDataStructure.md, ChemiStructure.md, TokenRule.md, TokenStructure.md, UserInfoStructure.md. Each task is one step of appropriate size (neither too large nor too small). Only create or update this plan; do not implement code yet.

---

## Execution result (2026-02-01)

**Status**: Executed. All seven tasks implemented.

| Task | Done | Notes |
|------|------|--------|
| 1. MCP list_cards | ✅ | Added `list_cards` MCP tool in api/mcplocal (listCardsArgs, runListCards calling GetItemnCards). Optional filters: scope, status, category, card_id substring, limit. Output: card_id, uid, scope, title, status. Documented in OperatorGuide §MCP 연동. |
| 2. Items→tokens where 표준화 검증 | ✅ | Added TestNormalizeWhere_ConsistentOrder and tightened TestItemsToTokens_RelationWhere in api/service/itemncard/saju_test.go (assert normalized token 관계:충@년지-일지#H only). Documented engine enforcement in TokenRule.md §D. |
| 3. Extraction result: download as JSON | ✅ | Added "JSON 저장" button in 사주 추출 테스트 and 궁합 추출 테스트 result panels (handleDownloadSajuResult, handleDownloadPairResult). Filename: saju_extract_YYYY-MM-DD.json / pair_extract_YYYY-MM-DD.json. No backend change. |
| 4. Card list: domain and cooldown_group filters | ✅ | Backend: ItemNCardSearchInput + domain, cooldownGroup; ItemNCardListFilter and FindWithPagination (domains contains value; cooldown_group regex). admweb: CardListFilters + domain, cooldown_group text fields; saju/pair input and query variables extended. |
| 5. OperatorGuide: 연도별·월별 추출 상세 | ✅ | Added subsection "연도별·월별 추출 상세" in OperatorGuide.md: when to use 인생/연도별/월별, required inputs (target year; target year+month), result pillars/period; link to docs/saju/itemNcard/tasks/연도별_월별_pillar.md. |
| 6. Verification: execution log snippet | ✅ | Added docs/saju/itemNcard/run_verification.sh (runs make test-itemncard and go build ., outputs markdown row for 검증 이력 table). Documented in Verification.md. |
| 7. Copy result: mode and period | ✅ | 사주 추출 테스트 copy already included mode and period; clarified clipboard line to "기간" for period. No backend change. |

**Verification**: Run from repo root: `cd api && make test-itemncard` and `go build .` to confirm. Admweb: run `npm run build` if frontend types were regenerated (domain/cooldownGroup in ItemNCardSearchInput). Optional: run `./docs/saju/itemNcard/run_verification.sh` for verification log snippet.

---

## Current state (as of 2026-02-01)

- **Backend**: Card CRUD (GraphQL), soft delete, extraction test REST (saju: 인생/연도별/월별, pair). itemncard pipeline: pillars → items → tokens → card selection with evidence, domain/tag limits, cooldown_group, max_per_user. LLM context builder and POST `/api/adm/llm_context_preview`. AdminExtractService returns user/pair info + selected cards with evidence and score. y2sl-local MCP: `register_card`, `update_card` in mcplocal/cardtools.go.
- **admweb**: Data Cards page with tabs (사주 카드, 궁합 카드, 사주 추출 테스트, 궁합 추출 테스트). List with filters (scope, status, category, tags, rule_set, 삭제 포함), sort, paging. Create/edit with full schema and trigger/score JSON validation (pair: src P|A|B). Soft delete, 복제, JSON 내보내기, 시드에서 불러오기, 일괄 등록. Extract result: items/tokens summary, pillars, selected cards + expandable evidence; copy-to-clipboard; LLM 컨텍스트 미리보기.
- **Docs**: ExtractionAPI.md, Seed.md, OperatorGuide.md, Verification.md, 연도별_월별_pillar.md. PRD §6 success criteria met; optional y2sl-local list_cards not implemented.

---

## Ordered next tasks

### 1. MCP list_cards (optional)

- Add an MCP tool (e.g. `list_cards`) in y2sl-local (api/mcplocal or API-serving MCP) so the agent can **query** existing cards. Input: optional filters (scope, status, category, card_id substring, limit). Output: list of card summaries (card_id, uid, scope, title, status). Implementation can call the existing GraphQL list query or a thin REST wrapper. Document in OperatorGuide §MCP 연동. Skip if agent workflows do not need discovery.

---

### 2. Items→tokens where 표준화 검증 (backend)

- Add a unit test that verifies **relationship where** (e.g. `일지-년지`, `년지-일지`) is normalized per TokenRule: fixed order (년→월→일→시) so that the same logical pair always yields the same token string. Target: the package that compiles items to tokens (e.g. `api/service/itemncard` or equivalent). One test file or table-driven cases; no DB. Document in TokenRule.md or code comment that the engine enforces this ordering.

---

### 3. Extraction result: download as JSON (admweb)

- In the **extraction test result** panels (사주 추출 테스트, 궁합 추출 테스트), add a **다운로드** (Download) or **JSON 저장** button that saves the full extraction result (user_info / summary_a, summary_b, p_tokens_summary, selected_cards with evidence and score) as a JSON file. Use the same shape as the API response (see ExtractionAPI.md, itemncard_dto.go). One button per result panel; filename hint e.g. `saju_extract_YYYY-MM-DD.json` or `pair_extract_YYYY-MM-DD.json`. No backend change.

---

### 4. Card list: domain and cooldown_group filters

- Add **optional list filters** for `domain` (e.g. “domains contains”) and `cooldown_group` (exact or substring) on the card list. Backend: extend the GraphQL list query (or resolver) to accept optional `domain`, `cooldown_group` arguments and apply them to the MongoDB query. admweb: add filter controls (text or chip) in the Data Cards list toolbar and pass values into the list query. Keep scope small: two new filter dimensions; existing pagination/sort unchanged.

---

### 5. OperatorGuide: 연도별·월별 추출 상세

- In `docs/saju/itemNcard/OperatorGuide.md`, add a short **연도별·월별 추출** subsection: (1) when to use 인생 vs 연도별 vs 월별; (2) which inputs are required for 연도별 (target year) and 월별 (target year + month); (3) what the result pillars and period represent (e.g. 歲運/月運). Link to `docs/saju/itemNcard/tasks/연도별_월별_pillar.md`. Documentation only; no code.

---

### 6. Verification: execution log snippet

- Provide a **one-liner or tiny script** (e.g. in Verification.md or a small script under docs/saju/itemNcard/) that runs `cd api && make test-itemncard` and outputs a markdown snippet suitable for pasting into the Verification.md **검증 이력** table (e.g. date, result, note). Optionally include `go build .` result. Purpose: make it easy to record verification runs for PRD §6 sign-off. Documentation or script only; no change to test logic.

---

### 7. Copy result: include mode and period (admweb)

- Ensure the **사주 추출 테스트** copy-to-clipboard content includes **mode** (인생/연도별/월별) and **period** (e.g. "2025", "2025-03") when present, so pasted text is self-describing. Align with `user_info.mode` and `user_info.period` from ExtractionAPI.md. Small UX change only; no backend change.

---

## Reference

| Doc | Use |
|-----|-----|
| PRD.md | §2 메뉴·화면, §2-4 선택 근거, §3 API, §4 y2sl-local MCP, §6 성공 기준 |
| CardDataStructure.md | Card JSON, trigger (all/any/not), score, content |
| ChemiStructure.md | P_tokens, pair card schema, src P\|A\|B |
| TokenRule.md | items → tokens, where 정규화, L/M/H |
| TokenStructure.md | Token 문법, 카테고리, 위치 표준 |
| UserInfoStructure.md | user input, pillars, items[], tokens[], rule_set, engine_version |
| ExtractionAPI.md | REST contract for extraction test and LLM preview |
| Verification.md | PRD §6 checklist, 검증 이력 |
| 연도별_월별_pillar.md | 연도별/월별 pillar source (歲運/月運) |

---

## Notes

- Task 1 is optional (MCP list_cards); tasks 2–7 are concrete next steps.
- Run all commands from repo root; backend commands from `api/` (e.g. `cd api && make test-itemncard`).
- Do not implement code in this plan; only create or update the task plan file.
