<!-- Next concrete tasks for itemNcard after task_034117 (card UI, filters, items/tokens, pair facts, saju mode done). -->
# itemNcard – next tasks (2026-02-01T035020)

Ordered next steps for itemNcard implementation. Ref: PRD.md, CardDataStructure.md, ChemiStructure.md, TokenRule.md, TokenStructure.md, UserInfoStructure.md. Execute in order. Each task is a single, concrete step (neither too large nor too small).

---

## 1. Go tests and build verification

- Add or extend Go tests for itemncard: `api/service/itemncard/saju_test.go`, `pair_test.go` (or equivalent), and `AdminExtractService` extract-test paths where feasible. Ensure `cd api && go test ./...` passes and `go build .` succeeds. Document in README or AGENTS.md how to run tests from repo root.

---

## 2. Card selection: score and sort

- In saju and pair card selection (SelectSajuCards, SelectPairCards), after trigger evaluation: compute per-card score from `score.base` + `bonus_if` (matched tokens) − `penalty_if` (matched tokens) per CardDataStructure. Sort candidates by priority first, then by computed score (desc). Return selected cards with a `score` field in the extract-test response so admweb can display it.

---

## 3. Card selection: cooldown_group and max_per_user

- Apply CardDataStructure Step 4 limits: when building the final selected list, respect `cooldown_group` (e.g. at most one card per cooldown_group) and `max_per_user` (max N cards per user for that card_id or group, if defined). Implement for both saju and pair selection. No UI change; verify via extract test (e.g. add two cards in same cooldown_group and confirm only one is returned when both match).

---

## 4. Saju items: add 격국, 용신, 강약

- In `api/service/itemncard/saju.go`, add items for 격국, 용신, 강약 per TokenStructure/UserInfoStructure. Schema: `k`, `n`, optional `where`, `w`, optional `sys`. Emit tokens (e.g. `격국:정재격`, `용신:수`, `강약:신강#M`) so cards can trigger on them. Use a minimal rule set (e.g. simple 격국/용신/강약 from pillars or placeholder logic) and document `sys` for future variants. Verify via saju extract test (items/tokens summary).

---

## 5. admweb: extraction result – score and evidence per card

- In DataCardsPage 사주 추출 테스트 and 궁합 추출 테스트 result view, for each selected card display: card_id, title, **score** (if returned by API), and **evidence** (matched tokens or debug description) in a clear, readable way (e.g. list or chips). Ensure the “무엇이 선택되었는지” requirement from PRD §2-4 is satisfied.

---

## 6. Sample saju and pair cards (seed data)

- Create 2–3 sample saju cards and 2–3 sample pair cards (JSON) that match current items/tokens (e.g. 십성, 관계, 신살, 궁합:충/합). Store in `docs/saju/itemNcard/` or a `seed/` folder. Add a short note (e.g. in tasks README or PRD) on how to import them via admweb “카드 생성” or GraphQL createItemnCard for manual and regression testing.

---

## 7. 연도별/월별: pillar source (대운·세운·월운)

- Clarify and, if needed, implement pillar source for 연도별 and 월별 modes. If the current implementation reuses “인생” pillars with a shifted date only, add a small step: for 연도별 use target-year pillars (e.g. 세운 from sxtwl or rule_set), for 월별 use target-year-month pillars (e.g. 월운). Produce items/tokens from those pillars so “연도별/월별” truly reflect that period. If the codebase already has 대운/세운/월운 helpers, wire them into RunSajuExtractTest for the corresponding mode. Document in code which rule_set or method is used.

---

## 8. (Optional) y2sl-local MCP card tools

- After card CRUD and extract test are stable: add MCP tools (e.g. register_card, update_card) that call the backend card API (GraphQL createItemnCard/updateItemnCard or REST). Document how runLoopForSaju.sh or Cursor agent can use these tools to register/update cards. Implement only if the MCP server is in use.

---

## Reference

| Doc | Use |
|-----|-----|
| PRD.md | Scope, extraction test UX, success criteria, §2-4 visibility |
| CardDataStructure.md | Trigger, score, cooldown_group, max_per_user, Step 4 |
| ChemiStructure.md | P_tokens, pair card schema, src P/A/B |
| TokenRule.md | items → tokens, where normalization, L/M/H |
| TokenStructure.md | Token syntax, categories (격국, 용신, 강약) |
| UserInfoStructure.md | items schema, pillars, tokens |

---

## Execution result

**Executed:** 2026-02-01. Run from repo root; dev server and gqlgen not started (per instructions).

### Done

1. **Go tests and build verification**
   - Extended `api/service/itemncard/saju_test.go`: `TestEvaluateSajuTrigger_Empty`, `TestEvaluateSajuTrigger_All`, `TestEvaluateSajuTrigger_NotFails`, `TestComputeScore`, `TestItemsFromPillars_GyeokYongStrong`.
   - Added `api/service/itemncard/pair_test.go`: `TestPItemsFromPillars`, `TestEvaluatePairTrigger_Empty`, `TestEvaluatePairTrigger_AnyP`.
   - Documented in AGENTS.md: run tests with `cd api && go test ./...` (from repo root).
   - `go build .` in `api/` succeeds. `go test ./...` may fail in environments without MongoDB/sxtwl if other packages have integration tests.

2. **Card selection: score and sort**
   - In `saju.go`: added `ScoreRule`, `ComputeScore(tokenSet, scoreJSON)`, and `selectedCardWithMeta`. `SelectSajuCards` now computes per-card score from `score.base` + `bonus_if` − `penalty_if`, sorts by priority then score (desc), and returns `([]ItemNCard, [][]string, []int, error)` with computed scores.
   - In `pair.go`: `SelectPairCards` uses merged A/B/P token set for scoring, same sort and return signature with `[]int` scores.
   - `AdminExtractService` passes computed scores into `dto.SelectedCard.Score` for both saju and pair extract responses.

3. **Card selection: cooldown_group and max_per_user**
   - Applied in both `SelectSajuCards` and `SelectPairCards`: after sorting, at most one card per `cooldown_group` (first occurrence kept), and `max_per_user` per `card_id` enforced. No UI change; verify via extract test with two cards in same cooldown_group.

4. **Saju items: 격국, 용신, 강약**
   - In `ItemsFromPillars`: 격국 from 월지 十神 (`parts[3]+"격"`), `where: ["월지"]`, `sys: "simple_month_stem_v1"`. 용신 = 日主 오행, `sys: "simple_day_stem_v1"`. 강약 from 月令 vs 日主: same→신강, 月令克日主→신약, else 중화; `sys: "simple_month_ling_v1"`. Added `dzToFiveElement`, `monthKeDay`. Tokens emitted (e.g. `격국:정재격`, `용신:수`, `강약:신강#M`). Tests: `TestItemsFromPillars_GyeokYongStrong`, `TestComputeScore`.

5. **admweb: extraction result – score and evidence per card**
   - DataCardsPage 사주 추출 테스트 and 궁합 추출 테스트: each selected card shown in a `Paper` with card_id, title, score (chip if present), and evidence as chips (matched tokens). Subtitle “무엇이 선택되었는지” added.

6. **Sample saju and pair cards (seed data)**
   - Created `docs/saju/itemNcard/seed/`: README.md (how to import via admweb “카드 생성” or GraphQL createItemnCard), `saju_정재_강함.json`, `saju_관계_충.json`, `saju_신살_도화.json`, `pair_궁합_충.json`, `pair_궁합_합.json`. Logical JSON (trigger/score/content as objects); README explains stringifying for form fields.

7. **연도별/월별: pillar source**
   - Clarified in code comment in `AdminExtractService.RunSajuExtractTest`: 연도별 = pillars for (target_year, birth_month, birth_day, birth_time); 월별 = (target_year, target_month, birth_day, birth_time). Current behaviour is calendar 4-pillar of that day, not 歲運/月運 (年柱/月柱 only). Added `docs/saju/itemNcard/tasks/연도별_월별_pillar.md` with current behaviour and future steps for 大運/歲運/月運.

### Status

- Tasks 1–7: **implemented**.
- Task 8 (Optional MCP card tools): **not done**; implement when y2sl-local MCP is in use.

### Remaining / next steps

- Run `cd api && go test ./...` and `go build .` locally to confirm full test suite and build (some tests may require MongoDB or sxtwl).
- Optionally add AdminExtractService handler tests (e.g. mock repo) for extract endpoints.
- Task 8: add MCP tools (register_card, update_card) if MCP server is used.
- For true 歲運/月運: wire sxtwl or rule_set to produce 年柱/月柱 for target year/month and use in RunSajuExtractTest.
