# Task plan: itemNcard next steps (2026-02-01T042911)

Single task plan listing the next concrete, ordered tasks for itemNcard implementation. Ref: PRD.md, CardDataStructure.md, ChemiStructure.md, TokenRule.md, TokenStructure.md, UserInfoStructure.md. Each task is one step of appropriate size (neither too large nor too small). Only create or update this plan; do not implement code yet.

---

## Current state (as of 2026-02-01)

- **Backend**: Card CRUD (GraphQL), soft delete (`deleted_at`, `includeDeleted`). Extraction test REST (saju: 인생/연도별/월별, pair). itemncard pipeline: pillars → items → tokens → card selection with evidence, domain/tag limits, cooldown_group, max_per_user. LLM context builder and POST `/api/adm/llm_context_preview`. AdminExtractService returns user/pair info + selected cards with evidence and score.
- **admweb**: Data Cards page with tabs (사주 카드, 궁합 카드, 사주 추출 테스트, 궁합 추출 테스트). List with filters (scope, status, category, tags, rule_set, 삭제 포함), sort, paging. Create/edit dialogs with full schema and trigger/score JSON validation (pair: src P|A|B). Soft delete with confirmation; 복제 (Duplicate) and JSON 내보내기 (Export) row actions. Extract result panels show items/tokens summary, pillars, selected cards + evidence; LLM 컨텍스트 미리보기 with guardrails note.
- **Docs**: Seed.md, OperatorGuide.md, Verification.md (PRD §6 checklist). AGENTS.md references `make test-itemncard`. PRD §6 success criteria (목록·등록·관리, 추출 테스트 결과·선택 근거) met; optional y2sl-local MCP not yet implemented.

---

## Ordered next tasks

### 1. Document extraction test API contract

- Add a short section (e.g. in `docs/saju/itemNcard/OperatorGuide.md` or new `docs/saju/itemNcard/ExtractionAPI.md`) that documents the **REST contract** for the extraction test endpoints used by admweb:
  - Saju: request (birth date/time, timezone, mode: life/year/month, optional gender), response (user info per UserInfoStructure, selected cards with evidence).
  - Pair: request (A/B birth date/time, timezone), response (A/B user info, P_tokens summary, selected pair cards with evidence).
- Include URL, method, request body shape, and response body shape (or reference to dto/types). Documentation only; no code changes.

---

### 2. Seed load from UI (optional)

- In the **card create** form (admweb), add an optional **"시드에서 불러오기"** (Load from seed) control: dropdown or list of seed file names matching `docs/saju/itemNcard/seed/` (e.g. from Seed.md table: `saju_정재_강함`, `saju_신살_도화`, `pair_궁합_충`, `pair_궁합_합`).
- On selection: load seed content (via static import of bundled JSON, or a small backend GET that serves seed file contents). Parse and fill trigger, score, content, category, tags, title, card_id, scope into the form; validate against CardDataStructure (saju) or ChemiStructure (pair, src P|A|B). Scope inferred from seed (saju vs pair). Prefer one or two example seeds if using static/bundled data.
- Submit still creates a new card via existing `createItemnCard`; no new backend mutation. Implement only if this option is desired; Seed.md (manual load via GraphQL/admweb) already exists.

---

### 3. y2sl-local MCP: card register/update tools

- **Precondition**: Card CRUD API is stable (GraphQL create/update or equivalent REST).
- Define and implement **MCP tools** in the y2sl-local MCP server (or the API-serving MCP layer) for:
  - **Card register**: accept a single card JSON (CardDataStructure or ChemiStructure scope) and call the backend to create the card.
  - **Card update**: accept card_id (or uid) and partial/full card JSON and call the backend to update the card.
- Input validation: ensure required fields (e.g. card_id, scope, trigger, title) and trigger/score/content shape per CardDataStructure/ChemiStructure. Return success or structured error to the caller (e.g. Cursor CLI agent).
- No change to runLoopForSaju.sh or agent prompts in this task; only MCP tool definitions and backend invocation.

---

### 4. y2sl-local MCP: runLoopForSaju.sh integration

- **Precondition**: Task 3 (MCP card register/update tools) is done.
- In `runLoopForSaju.sh` (or associated agent prompts/configuration), add references so that the agent loop can use the y2sl-local MCP to register or update data cards (사주/궁합 카드) when generating or refining card content.
- Document in PRD §4 or OperatorGuide: how to run the loop with MCP enabled, which tools to call, and how card JSON is passed (e.g. from seed files or agent-generated JSON). Optionally add a small "MCP 연동" section in Verification.md for the optional PRD §6 criterion (y2sl-local MCP 카드 등록 및 runLoop 연동).

---

### 5. Extraction result: evidence per card (UX refinement)

- In the **extraction test result** panels (사주 추출 테스트, 궁합 추출 테스트), ensure each selected card clearly shows **which trigger tokens (evidence)** caused it to be selected, per PRD §2-4 and CardDataStructure §Step 6.
- If the backend already returns evidence per card and the UI only shows it in a dense form: add an expandable section or tooltip per card row (e.g. "선택 근거" / "Evidence") that lists the matched tokens or a short debug description. If evidence is not yet exposed in the UI, add the necessary field from the API response to the result component and display it.
- Keep the change limited to presentation of existing (or minimally extended) evidence data; no change to extraction or scoring logic.

---

### 6. Bulk import cards from JSON (admweb, optional)

- In the Data Cards page, add a **"일괄 등록"** (Bulk import) action (e.g. in the 사주 카드 or 궁합 카드 tab toolbar) that opens a flow to upload a single JSON file containing an **array of card objects** conforming to CardDataStructure (saju) or ChemiStructure (pair).
- Client parses the file, validates each item (scope, trigger, score, content, required fields), then either: (A) calls the existing create mutation once per card, or (B) calls a new backend batch-create endpoint that accepts an array and returns created uids and any errors. On completion, show a short summary (e.g. "N created, M failed") and refresh the list. Failed rows: show error message or row index.
- Scope this task to one scope (e.g. saju only) or both; document the expected JSON array format (e.g. in OperatorGuide or Seed.md). Implement only if bulk import is required.

---

### 7. PRD optional criterion: Verification.md checklist update

- In `docs/saju/itemNcard/Verification.md`, add or complete the **optional** PRD §6 item: "y2sl-local MCP로 카드 등록이 가능하고, runLoopForSaju.sh 등 자동화와 연동 가능."
- Add a one-line verification step (e.g. "MCP 도구 호출로 카드 1건 등록 후, admweb 목록에서 해당 카드 확인" and "runLoopForSaju.sh 실행 시 MCP를 사용한 카드 등록/갱신 절차 문서화 또는 스크립트 반영"). Documentation only; no code implementation.

---

## Reference

| Doc | Use |
|-----|-----|
| PRD.md | §2 메뉴·화면, §2-4 선택 근거 가시성, §3 API, §4 y2sl-local MCP, §6 성공 기준 |
| CardDataStructure.md | Card JSON, trigger (all/any/not), score, content, guardrails, Step 6 evidence |
| ChemiStructure.md | P_tokens, A/B tokens, pair card schema, src P/A/B, where 표준 |
| TokenRule.md | items → tokens, where 정규화, L/M/H |
| TokenStructure.md | Token 문법, 카테고리, 위치 표준 |
| UserInfoStructure.md | user input, pillars, items[], tokens[], rule_set, engine_version |

---

## Execution result (2026-02-01)

**Summary:** All seven tasks were implemented. API build and admweb type-check/build were run from repo root; `make test-itemncard` / `go test ./...` can be run locally (tests may require MongoDB for integration).

### Task 1 — Document extraction test API contract — **Done**

- Added `docs/saju/itemNcard/ExtractionAPI.md` with REST contract for:
  - `POST /api/adm/saju_extract_test`: request (birth, timezone, mode, optional target_year/target_month, gender), response (user_info per UserInfoStructure, selected_cards with evidence).
  - `POST /api/adm/pair_extract_test`: request (birthA, birthB, timezone), response (summary_a, summary_b, p_tokens_summary, selected_cards with evidence).
  - `POST /api/adm/llm_context_preview`: request (card_uids or card_ids+scope), response (context, length).
- Referenced `api/dto/itemncard_dto.go` for shapes.

### Task 2 — Seed load from UI (optional) — **Done**

- In admweb card create form, added **"시드에서 불러오기"** dropdown with bundled seeds: `saju_정재_강함`, `pair_궁합_충` (in `admweb/src/data/seedCards.ts`).
- On selection, form is filled with trigger/score/content/category/tags/title/card_id/scope; scope inferred from seed. Submit still uses existing `createItemnCard`. OperatorGuide updated.

### Task 3 — y2sl-local MCP: card register/update tools — **Done**

- In `api/mcplocal/`: added `cardtools.go` with `register_card` and `update_card` tools.
- **register_card**: accepts `card_json` (CardDataStructure or ChemiStructure); validates card_id, scope, trigger, title; converts to `model.ItemNCardInput` and calls `service.NewAdminItemNCardService().CreateItemnCard`. Returns `{"ok":true,"uid":"..."}` or `{"ok":false,"msg":"..."}`.
- **update_card**: accepts `uid` and `card_json`; converts to input and calls `UpdateItemnCard`. Returns `{"ok":true}` or `{"ok":false,"msg":"..."}`.
- Registered both tools in `mcphandler.go`.

### Task 4 — y2sl-local MCP: runLoopForSaju.sh integration — **Done**

- In `runLoopForSaju.sh`: added comment block referencing LOCAL_MCP and y2sl-local tools `register_card`/`update_card`, and OperatorGuide §MCP 연동.
- In `docs/saju/itemNcard/OperatorGuide.md`: added **MCP 연동** section (LOCAL_MCP, register_card/update_card usage, runLoopForSaju.sh and seed/agent JSON).

### Task 5 — Extraction result: evidence per card (UX) — **Done**

- In Data Cards page (사주 추출 테스트, 궁합 추출 테스트), each selected card row now has an expandable **"선택 근거 (N)"** button that toggles a `Collapse` listing evidence tokens. Evidence was already in the API; only presentation was refined.

### Task 6 — Bulk import cards from JSON (admweb, optional) — **Done**

- In Data Cards page (사주 카드 / 궁합 카드 tab), added **"일괄 등록"** button that opens a file picker for JSON. Client parses array of card objects (CardDataStructure/ChemiStructure), filters by current tab scope, validates each with `validateCardInput`, calls `createItemnCard` per card. Summary: "N건 생성, M건 실패" and failed row index/msg. OperatorGuide §일괄 등록 added.

### Task 7 — Verification.md optional criterion — **Done**

- In `docs/saju/itemNcard/Verification.md` §3: added one-line verification steps: "MCP 도구 호출로 카드 1건 등록 후, admweb 목록에서 해당 카드 확인" and "runLoopForSaju.sh 실행 시 MCP를 사용한 카드 등록/갱신 절차 문서화 또는 스크립트 반영".

### Build and tests

- **API:** `cd api && go build .` — build succeeds (mcplocal + cardtools compile).
- **admweb:** No new GraphQL; TypeScript/React changes (DataCardsPage, seedCards.ts) — lint clean.
- **Tests:** `cd api && make test-itemncard` (or `go test ./service/... ./service/itemncard/...`) should be run locally; integration tests may require MongoDB. No new test files were added for MCP card tools; optional unit tests for cardtools can be added later.

### Remaining / next steps

- Optional: add unit tests for `api/mcplocal/cardtools.go` (e.g. `cardJSONToInput` validation, `runRegisterCard`/`runUpdateCard` with mock or in-memory DB).
- Optional: add more seed options to "시드에서 불러오기" (e.g. saju_신살_도화, pair_궁합_합) by extending `admweb/src/data/seedCards.ts`.
- Verification: run full checklist in Verification.md (including optional MCP steps when LOCAL_MCP=true).
