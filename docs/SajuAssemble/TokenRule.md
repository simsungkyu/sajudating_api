# 1페이지: items → tokens 생성 규칙(등급 기준 포함)

## A) 전제: items 최소 필드

각 item은 최소 아래 중 일부를 가진다.

- **k** (카테고리) 필수: 예 십성, 관계, 오행, 신살, 격국, 용신, 육친, 강약, 확신
- **n** (이름) 필수: 예 정재, 충, 토, 도화 …
- **where** (위치 배열) 선택: 예 `["월간"]`, `["일지-년지"]`, `["월지.지장간"]`
- **w** (0~100 정수 가중치) 선택
- **sys** 선택(유파/방법이 갈리면 권장)

### 토큰 문법(표준)

```
<k>:<n>[@<where>][#<L|M|H>][~<sys>]
```

- `@where`, `#등급`, `~sys`는 필요할 때만 붙임
- `~sys`는 신살/용신/격국/강약/확신처럼 방법이 갈릴 때만

---

## B) 등급(L/M/H) 기준(가중치 w → 등급)

기본(가장 단순, 전 카테고리 공통):

| 등급 | w 범위 |
|------|--------|
| L    | 0–49   |
| M    | 50–69  |
| H    | 70–100 |

**운영 팁:** 경계 튐이 걱정되면(옵션)  
M→H는 72 이상, H→M은 68 이하 같은 “완충”을 엔진에만 넣고, 토큰은 최종 등급만 생성.

**등급 토큰 생성 조건:**  
w가 존재하면 항상 `#L` / `#M` / `#H`를 추가 생성(카테고리별로 끄고 켤 수 있음).

---

## C) 토큰 생성 규칙(“항상 / 조건부”)

### 1) 기본(항상 생성)

**T1: 존재 토큰**

- 형식: `k:n`
- 예: `십성:정재`, `관계:충`, `오행:토`

### 2) 위치(where)가 있으면

**T2: 위치 토큰**(여러 개면 각각 생성)

- 형식: `k:n@where`
- 예: `십성:정재@월간`
- 예(지장간): `십성:정재@월지.지장간`
- 예(관계): `관계:충@일지-년지`

### 3) 가중치(w)가 있으면

**T3: 등급 토큰**

- 형식: `k:n#H` (또는 `#M` / `#L`)
- 예: `십성:정재#H`, `오행:토#M`, `관계:충#H`

### 4) 위치+등급(가장 많이 쓰는 토큰)

**T4: 위치+등급 토큰** (where가 있고 w가 있으면 생성)

- 형식: `k:n@where#grade`
- 예: `십성:정재@월간#H`
- 예: `관계:충@일지-년지#H`

### 5) sys(룰셋/방법)가 있고, 혼선 가능성이 있으면

**T5: sys 포함 토큰**(선택이지만 강추)

- `k:n~sys`
- `k:n@where~sys`
- `k:n#grade~sys`

예:

- `신살:도화~common_v1`
- `용신:수~useful_v1`
- `강약:중화#M~simple_weight_v1`

sys는 토큰을 늘리므로, 정말 필요한 카테고리에만 쓰는 게 좋음(신살/용신/격국/강약/확신).

---

## D) where 표준화 규칙(토큰 생성 전 정규화)

토큰 품질은 **“where 표준화”**가 전부다.

- **단일 위치**는 표준어로 고정  
  `년간` / `년지` / `월간` / `월지` / `일간` / `일지` / `시간` / `시지`
- **지장간:** `년지.지장간` / `월지.지장간` / `일지.지장간` / `시지.지장간`
- **관계**(where가 “A-B” 형식)일 때 **순서 고정**(중요)
  - 순서 규칙: 년 → 월 → 일 → 시 우선순위로 정렬
  - 예: 입력이 `년지-일지`든 `일지-년지`든 결과 토큰은 항상 규칙에 맞는 고정 순서로 만들기
  - 추천 고정 순서: `년간 < 월간 < 일간 < 시간`, `년지 < 월지 < 일지 < 시지`  
  (원하는 방향으로 1번만 정하면 됨. 핵심은 “항상 같은 형태”)

---

- **엔진 적용**: `api/service/itemncard`의 `NormalizeWhere` 및 `ItemsToTokens`가 위 순서를 적용하며, 단위 테스트(`TestNormalizeWhere_ConsistentOrder`, `TestItemsToTokens_RelationWhere`)로 검증됩니다.

---

## E) 출력(tokens) 후처리 규칙

- **중복 제거:** Set으로 dedupe
- **정렬(선택):** 디버깅/테스트 재현성을 위해 사전순 정렬 추천
- **요약 토큰(선택):** 너무 자주 쓰는 것만 추가로 만들어도 됨  
  예: `관계:충#H`가 하나라도 있으면 `관계:충_강함` 같은 별칭 토큰(별칭은 최소화 권장)

---

## F) 짧은 예시(1개 item → tokens)

**item:**

```json
{ "k": "십성", "n": "정재", "where": ["월간", "월지.지장간"], "w": 78 }
```

**생성 tokens:**

```
십성:정재
십성:정재#H
십성:정재@월간
십성:정재@월지.지장간
십성:정재@월간#H
십성:정재@월지.지장간#H
```

---

## 한 줄 결론

**존재(`k:n`), 위치(`@where`), 등급(`#L`/`#M`/`#H`), (필요시) 방법(`~sys`)**  
이 4가지를 조합해 토큰을 만들면, 카드 트리거는 거의 전부 “Set 멤버십 체크”로 끝난다.
