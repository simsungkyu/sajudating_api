# admgql.graphql: 관리자용 GraphQL 스키마 (쿼리/뮤테이션, 공통·사주·AI·카드·로그 등)

scalar BigInt

interface Node {
  id: ID
}

# 키-값 공통 타입
type KV {
  k: String!
  v: String!
}
input KVInput {
  k: String!
  v: String!
}

# 공통 응답 래퍼 (목록/단건/에러/페이징 등)
type SimpleResult {
  ok: Boolean!
  uid: String
  err: String
  msg: String
  value: String
  base64Value: String
  node: Node
  nodes: [Node!]
  kvs: [KV!]
  total: Int
  limit: Int
  offset: Int
}

type Query {
  # 관리자 계정
  adminUsers: SimpleResult!

  # 사주 프로필
  sajuProfiles(input: SajuProfileSearchInput!): SimpleResult!
  sajuProfile(uid: String!): SimpleResult!
  sajuProfileSimilarPartners(uid: String!, limit: Int!, offset: Int!): SimpleResult!
  sajuProfileLogs(input: SajuProfileLogSearchInput!): SimpleResult!

  # 이상형 파트너(물리)
  phyIdealPartners(input: PhyIdealPartnerSearchInput!): SimpleResult!
  phyIdealPartner(uid: String!): SimpleResult!

  # AI 메타/실행
  aiMetas(input: AiMetaSearchInput!): SimpleResult!
  aiMeta(uid: String!): SimpleResult!
  aiMetaTypes: SimpleResult!
  aiMetaKVs(input: AiMetaKVsInput!): SimpleResult!
  aiExecutions(input: AiExecutionSearchInput!): SimpleResult!
  aiExecution(uid: String!): SimpleResult!
  palja(birthdate: String!, timezone: String!): SimpleResult!

  # 사주어셈블-ItemNCard (사주/궁합 카드)
  itemnCards(input: ItemNCardSearchInput!): SimpleResult!
  itemnCard(uid: String): SimpleResult
  itemnCardByCardId(cardId: String!, scope: String): SimpleResult

  # 사주어셈블-SajuAssemble: 명식/차트·토큰 추출 및 카드 조회 (설계: docs/SajuAssemble/GraphQL_Extract_Design.md)
  # 사주
  sajuChart(input: SajuChartInput!): SimpleResult!
  itemnCardsByTokens(input: ItemnCardsByTokensInput!): SimpleResult!
  extract_saju(input: ExtractSajuInput!): SimpleResult!
  # 궁합
  sajuPairChart(input: SajuPairChartInput!): SimpleResult!
  pairCardsByTokens(input: PairCardsByTokensInput!): SimpleResult!
  extract_pair(input: ExtractPairInput!): SimpleResult!

  # 로그/시스템
  localLogs(input: LocalLogSearchInput!): SimpleResult!
  systemStats: SimpleResult!
}

type Mutation {
  # 관리자 계정
  login(email: String!, password: String!, otp: String!): SimpleResult!
  logout: SimpleResult!
  createAdminUser(email: String!, password: String!): SimpleResult!
  setAdminUserActive(uid: String!, active: Boolean!): SimpleResult!
  updateAdminUser(uid: String!, email: String!, password: String!): SimpleResult!

  # 사주 프로필
  createSajuProfile(input: SajuProfileCreateInput!): SimpleResult
  deleteSajuProfile(uid: String!): SimpleResult

  # 이상형 파트너
  createPhyIdealPartner(input: PhyIdealPartnerCreateInput!): SimpleResult
  deletePhyIdealPartner(uid: String!): SimpleResult

  # AI 메타
  putAiMeta(input: AiMetaInput!): SimpleResult
  setAiMetaInUse(uid: String!): SimpleResult
  delAiMeta(uid: String!): SimpleResult
  setAiMetaDefault(uid: String!): SimpleResult
  runAiExecution(input: AiExcutionInput!): SimpleResult!

  # 사주어셈블-ItemNCard
  createItemnCard(input: ItemNCardInput!): SimpleResult
  updateItemnCard(uid: String!, input: ItemNCardInput!): SimpleResult
  deleteItemnCard(uid: String!): SimpleResult

  # 사주어셈블-사주/궁합 생성 (실행) (추후 수정 혹은 삭제 예정)
  runSajuGeneration(input: SajuGenerationRequest!): SajuGenerationResponse!
  runChemiGeneration(input: ChemiGenerationRequest!): ChemiGenerationResponse!

  # 사주어셈블-공통 LLM 요청 (프롬프트만 전달, 카드 UID 없음)
  sendLLMRequest(input: SendLLMRequestInput!): SimpleResult!
}

# 관리자 계정 (목록 노드용)
type AdminUser implements Node {
  id: ID
  uid: String!
  createdAt: BigInt!
  updatedAt: BigInt!
  username: String!
  email: String!
  isActive: Boolean!
}

# 사주 프로필
type SajuProfile implements Node {
  id: ID
  uid: String!
  createdAt: BigInt!
  updatedAt: BigInt!
  sex: String!
  birthdate: String!
  palja: String!
  email: String!
  image: String!
  imageMimeType: String!
  nickname: String!
  sajuSummary: String!
  sajuContent: String!
  phySummary: String!
  phyContent: String!
  myFeatureEyes: String!
  myFeatureNose: String!
  myFeatureMouth: String!
  myFeatureFaceShape: String!
  myFeatureNotes: String!
  partnerEmbeddingText: String!
  partnerMatchTips: String!
  partnerSummary: String!
  partnerFeatureEyes: String!
  partnerFeatureNose: String!
  partnerFeatureMouth: String!
  partnerFeatureFaceShape: String!
  partnerPersonalityMatch: String!
  partnerSex: String!
  partnerAge: Int!
  phyPartnerUid: String!
  phyPartnerSimilarity: Float!
}

input SajuProfileSearchInput {
  limit: Int!
  offset: Int!
  orderBy: String
  orderDirection: String
}

input SajuProfileCreateInput {
  image: String!
  birthdate: String!
  sex: String!
}

# 사주 프로필 로그
type SajuProfileLog implements Node {
  id: ID
  uid: String!
  createdAt: BigInt!
  updatedAt: BigInt!
  sajuUid: String!
  status: String!
  text: String!
}
input SajuProfileLogSearchInput {
  limit: Int!
  offset: Int!
  sajuUid: String!
  status: String
}

# 이상형 파트너(물리)
type PhyIdealPartner implements Node {
  id: ID
  uid: String!
  createdAt: BigInt!
  updatedAt: BigInt!
  summary: String!
  featureEyes: String!
  featureNose: String!
  featureMouth: String!
  featureFaceShape: String!
  personalityMatch: String!
  sex: String!
  age: Int!
  image: String!
  embeddingModel: String!
  embeddingText: String!
  similarityScore: Float!
  hasImage: Boolean!
}

input PhyIdealPartnerCreateInput {
  summary: String!
  featureEyes: String!
  featureNose: String!
  featureMouth: String!
  featureFaceShape: String!
  personalityMatch: String!
  sex: String!
  age: Int!
  image: String
}

input PhyIdealPartnerSearchInput {
  limit: Int!
  offset: Int!
  sex: String
  hasImage: Boolean
}

# AI 메타 (프롬프트/모델 설정)
type AiMeta implements Node {
  id: ID
  uid: String!
  createdAt: BigInt!
  updatedAt: BigInt!
  metaType: String!
  name: String!
  desc: String!
  prompt: String!
  model: String!
  temperature: Float!
  maxTokens: Int!
  size: String!
  inUse: Boolean!
}

input AiMetaInput {
  uid: String
  name: String!
  desc: String!
  prompt: String!
  metaType: String
  model: String!
  temperature: Float!
  maxTokens: Int!
  size: String!
}

input AiMetaSearchInput {
  limit: Int!
  offset: Int!
  metaType: String
  inUse: Boolean
}

input AiMetaKVsInput {
  type: String!
  kvs: [KVInput!]!
}

type AiMetaType implements Node {
  id: ID!
  type: String!
  inputFields: [String!]!
  outputFields: [String!]!
  hasInputImage: Boolean!
  hasOutputImage: Boolean!
}

# AI 실행 이력
type AiExecution implements Node {
  id: ID
  uid: String!
  createdAt: BigInt!
  updatedAt: BigInt!
  metaUid: String!
  metaType: String!
  status: String!
  errorMessage: String!
  prompt: String!
  valued_prompt: String!
  inputkvs: [KV!]!
  outputkvs: [KV!]!
  model: String!
  temperature: Float!
  maxTokens: Int!
  size: String!
  inputImageBase64: String
  elapsedTime: Int!
  outputText: String
  outputImageBase64: String
  inputTokens: Int!
  outputTokens: Int!
  totalTokens: Int!
  runBy: String
  runSajuProfileUid: String
}

input AiExcutionInput {
  metaUid: String!
  metaType: String!
  promptType: String!
  prompt: String!
  valued_prompt: String!
  inputkvs: [KVInput!]!
  outputkvs: [KVInput!]!
  model: String!
  temperature: Float!
  maxTokens: Int!
  size: String!
  inputImageBase64: String
}

input AiExecutionSearchInput {
  limit: Int!
  offset: Int!
  metaType: String
  metaUid: String
  runBy: String
  runSajuProfileUid: String
}

# ItemNCard (사주/궁합 카드)
type ItemNCard implements Node {
  id: ID
  uid: String!
  cardId: String!
  version: Int!
  status: String!
  ruleSet: String!
  scope: String!
  title: String!
  category: String!
  tags: [String!]!
  domains: [String!]!
  priority: Int!
  triggerJson: String!
  scoreJson: String!
  contentJson: String!
  cooldownGroup: String!
  maxPerUser: Int!
  debugJson: String!
  deletedAt: BigInt!
  createdAt: BigInt!
  updatedAt: BigInt!
}

input ItemNCardSearchInput {
  limit: Int!
  offset: Int!
  scope: String
  status: String
  category: String
  tags: [String!]
  ruleSet: String
  domain: String
  cooldownGroup: String
  orderBy: String
  orderDirection: String
  includeDeleted: Boolean
}

input ItemNCardInput {
  cardId: String!
  version: Int!
  status: String!
  ruleSet: String!
  scope: String!
  title: String!
  category: String!
  tags: [String!]!
  domains: [String!]!
  priority: Int!
  triggerJson: String!
  scoreJson: String!
  contentJson: String!
  cooldownGroup: String!
  maxPerUser: Int!
  debugJson: String!
}

# ----- SajuAssemble: 명식/차트·토큰·카드 (GraphQL_Extract_Design.md) -----

# 사주 차트 四柱 (년·월·일·시)
type SajuChartPillars {
  y: String!
  m: String!
  d: String!
  h: String!
}

# 사주 차트 출처(기준일·모드·대운 등) 메타
type SajuPillarSource {
  baseDate: String!
  baseTimeUsed: String!
  mode: String!
  period: String!
  description: String!
}

# 단일 명식 차트: pillars 필수, 나머지 옵션 (items/tokens는 includeTokens 등으로 제어)
type SajuChart implements Node {
  id: ID
  pillars: SajuChartPillars!
  dm: String
  itemsSummary: String
  items: [String!]
  ruleSet: String
  engineVersion: String
  mode: String
  period: String
  pillarSource: SajuPillarSource
  tokens: [String!]
}

# 궁합 쌍 차트: A/B 차트 + P토큰
type SajuPairChart implements Node {
  id: ID
  chartA: SajuChart!
  chartB: SajuChart!
  pTokens: [String!]!
  pItemsSummary: String
  pItems: [String!]
  ruleSet: String
  engineVersion: String
}

# 토큰 매칭으로 선별된 카드 한 건 (itemnCardsByTokens / pairCardsByTokens 공통)
type SelectedItemnCard implements Node {
  id: ID
  cardId: String!
  title: String!
  evidence: [String!]!
  score: Int!
  contentSummary: String
}

# sendLLMRequest 응답 (node 또는 value/kvs로 전달)
type LLMRequestResult implements Node {
  id: ID
  responseText: String
  inputTokens: Int
  outputTokens: Int
  totalTokens: Int
  errorMessage: String
}

input SajuChartInput {
  birth: SajuBirthInput!
  timezone: String
  calendar: String
  mode: String!
  targetYear: Int
  targetMonth: Int
  targetDay: Int
  targetDaesoonIndex: Int
  gender: String
  includeTokens: Boolean
}

input SajuPairChartInput {
  birthA: SajuBirthInput!
  birthB: SajuBirthInput!
  timezone: String
  calendar: String
  includeTokens: Boolean
}

input ItemnCardsByTokensInput {
  tokens: [String!]!
  limit: Int
  ruleSet: String
}

input PairCardsByTokensInput {
  tokensA: [String!]!
  tokensB: [String!]!
  pTokens: [String!]!
  limit: Int
  ruleSet: String
}

input SendLLMRequestInput {
  prompt: String!
  systemPrompt: String
  maxTokens: Int
  model: String
  temperature: Float
}

# ----- 로컬 로그 -----
type LocalLog implements Node {
  id: ID
  uid: String!
  createdAt: BigInt!
  expiresAt: BigInt!
  status: String!
  text: String!
}
input LocalLogSearchInput {
  limit: Int!
  offset: Int
  status: String
}

# 시스템 상태
type SystemStats implements Node {
  id: ID
  hostname: String!
  cpuUsage: Float!
  memoryUsage: Int!
  memoryTotal: Int!
}

# 사주 생성: 사용자 정보 + 출력 대상 → 결과 포함 대상 목록
input SajuBirthInput {
  date: String!
  time: String!
  time_precision: String
}
input SajuGenerationUserInput {
  birth: SajuBirthInput!
  timezone: String
  rule_set: String
  gender: String
}
input SajuGenerationTargetInput {
  kind: String!
  period: String!
  max_chars: Int!
}
type SajuGenerationTargetOutput {
  kind: String!
  period: String!
  max_chars: Int!
  result: String!
}
input SajuGenerationRequest {
  user_input: SajuGenerationUserInput!
  targets: [SajuGenerationTargetInput!]!
}
type SajuGenerationResponse {
  targets: [SajuGenerationTargetOutput!]!
}

# 궁합(캐미) 생성: 쌍 입력 + 대상 → 결과 포함 대상 목록
input ChemiGenerationPairInput {
  birthA: SajuBirthInput!
  birthB: SajuBirthInput!
  timezone: String
}
input ChemiGenerationTargetInput {
  perspective: String!
  max_chars: Int!
}
type ChemiGenerationTargetOutput {
  perspective: String!
  max_chars: Int!
  result: String!
}
input ChemiGenerationRequest {
  pair_input: ChemiGenerationPairInput!
  targets: [ChemiGenerationTargetInput!]!
}
type ChemiGenerationResponse {
  targets: [ChemiGenerationTargetOutput!]!
}
