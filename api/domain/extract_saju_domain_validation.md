# extract_saju.go 타입 구성 검증 — 사주(四柱) 도메인 기준

프로젝트 내 다른 파일을 참조하지 않고, **사주(四柱) 도메인 지식만**으로 `extract_saju.go`의 타입 구성이 적절한지 검증한 결과이다.

---

## 1. 기본 식별자·열거형

### 1.1 천간·지지

| 타입 | 정의 | 사주 도메인 검증 |
|------|------|------------------|
| `StemId` | 0..9 | **적절함.** 천간(天干)은 甲·乙·丙·丁·戊·己·庚·辛·壬·癸 10개. 0-based 10개이므로 0..9가 정확함. |
| `BranchId` | 0..11 | **적절함.** 지지(地支)는 子·丑·寅·卯·辰·巳·午·未·申·酉·戌·亥 12개. 0..11이 정확함. |

### 1.2 주(柱) 구분

| 타입 | 정의 | 사주 도메인 검증 |
|------|------|------------------|
| `PillarKey` | "Y"\|"M"\|"D"\|"H" | **적절함.** 사주는 년주·월주·일주·시주 네 기둥. Year/Month/Day/Hour에 대응하는 Y/M/D/H 구성이 맞음. |

### 1.3 오행·음양

| 타입 | 정의 | 사주 도메인 검증 |
|------|------|------------------|
| `FiveEl` | "WOOD"\|"FIRE"\|"EARTH"\|"METAL"\|"WATER" | **적절함.** 오행(五行) 木火土金水에 대응. 영문 표기가 일관됨. |
| `YinYang` | "YIN"\|"YANG" | **적절함.** 천간·지지 각각 음양이 정해져 있음(예: 甲=양목, 乙=음목). |

### 1.4 그래프·관계

| 타입 | 정의 | 사주 도메인 검증 |
|------|------|------------------|
| `NodeId` / `EdgeId` | uint32 | **적절함.** 내부 참조용 ID; 사주 도메인 제약과 무관. |
| `NodeKind` | "STEM"\|"BRANCH"\|"HIDDEN" | **적절함.** 천간(STEM), 지지(BRANCH), 지장간(藏干, HIDDEN) 세 종류를 구분하는 데 부합. |
| `RelType` | string | **적절함.** 합(合)·충(沖)·형(刑)·해(害)·파(破) 등 관계 타입을 문자열로 두는 것은 타당. |

---

## 2. BirthInput·입력

### 2.1 BirthInput

| 필드 | 사주 도메인 검증 |
|------|------------------|
| `DtLocal` | **필수.** 사주는 생년월일시가 근본. ISO local datetime 적절. |
| `Tz` | **필수.** 절기·자시(子時) 경계 등은 시간대에 따라 달라짐. IANA TZ 적절. |
| `Loc` (Geo) | **선택 적절.** 진태양시(真太陽時) 등 보정 시 위도/경도 사용. 선택이 맞음. |
| `Calendar` | "SOLAR"\|"LUNAR" 적절. 양력/음력 구분은 사주 입력에서 필수. |
| `LeapMonth` | **적절.** 음력 사용 시 윤달(閏月) 여부가 월주 계산에 영향. *bool 선택 적절. |
| `Sex` | "M"\|"F" **적절.** 대운(大運) 순행/역행 등 성별 기반 해석에 사용. |
| `TimePrec` | "MINUTE"\|"HOUR"\|"UNKNOWN" **적절.** 시간 정밀도(분/시/미상)를 명시하면 시주 미상 케이스를 안전하게 표현 가능. |
| `Engine` | **적절.** 자평(子平), 궁통보감 등 유파/엔진 구분용. |

### 2.2 Geo

| 필드 | 사주 도메인 검증 |
|------|------------------|
| `Lat`, `Lon` | 위도·경도. 진태양시·지역 보정 시 사용. float64로 충분. |

### 2.3 Engine

엔진명·버전·유파·파라미터를 두는 구성은 사주 해석 룰셋을 구분·추적하기에 **적절함.**

---

## 3. Pillar·Node·Edge (명식 구조)

### 3.1 Pillar

| 필드 | 사주 도메인 검증 |
|------|------------------|
| `K` (PillarKey) | Y/M/D/H 중 하나. **적절.** |
| `Stem` (천간), `Branch` (지지) | 각 주마다 천간 1개·지지 1개. **적절.** |
| `Hidden` ([]StemId) | **적절.** 지장간(藏干): 한 지지 안에 1~3개 천간(本氣·餘氣·雜氣). 슬라이스로 표현 타당. 빈 슬라이스는 "미계산"으로 해석 가능. |

**참고:** `Pillars`는 기본적으로 4개(년·월·일·시)이나, 생시 미상 입력에서는 시주(H)를 제외한 3개(년·월·일)로 표현할 수 있다. 상위 유효성 검사에서 `HourContext.Status`와 `len(Pillars)`의 일관성(예: `KNOWN`이면 4, `MISSING`이면 3)을 보장하는 것이 좋다.

### 3.2 Node

| 필드 | 사주 도메인 검증 |
|------|------------------|
| `Kind` | STEM / BRANCH / HIDDEN. 천간·지지·지장간 노드 구분에 **적절.** |
| `Pillar` | 노드가 어느 주(년/월/일/시) 소속인지. **필요.** |
| `Idx` (*uint8) | HIDDEN일 때 지장간 내 순서(本氣=0, 餘氣=1, 雜氣=2 등). **적절.** |
| `Stem` / `Branch` | Kind에 따라 하나만 의미 있음. 포인터로 선택적 두는 것 **적절.** |
| `El`, `Yy` | 오행·음양은 천간/지지/지장간 모두에 정의됨. **필수로 두는 것 적절.** |

### 3.3 Edge

관계(합·충·형·해 등)를 두 노드 A, B와 관계 타입 T, 선택적 가중치 W·기여 노드 Refs로 표현한 것은 **사주 도메인에 부합함.**

---

## 4. Evidence·Score·Fact·Eval

### 4.1 Evidence / EvidenceInputs

규칙 ID·버전·유파·입력 노드·파라미터를 남기는 구조는 “어떤 규칙이 어떤 입력으로 이 결론을 냈는지” 추적하는 데 **적절함.** 사주 해석의 근거 추적에 잘 맞음.

### 4.2 Score / ScorePart

- `Total`, `Min`, `Max`, `Norm0_100`, `Confidence`: 해석/평가 점수와 신뢰도 표현에 **적절.**
- `Parts`: 가중치·원점수·기여 노드로 분해하는 구성은 **적절.**

### 4.3 FactItem vs EvalItem

- **FactItem:** 명식에서 도출된 **사실**(예: 十神, 用神 후보). `Score`가 선택인 것은 “영향도가 선택적”이라는 사주 해석 관례에 맞음. **적절.**
- **EvalItem:** **평가/해석**(예: 길흉, 점수). 평가는 보통 점수와 함께 다루므로 `Score` 필수. **적절.**

---

## 5. SajuDoc 전체

- `SchemaVer`: 스키마 버전 관리. **적절.**
- `Input`, `Pillars`, `Nodes`, `Edges`, `Facts`, `Evals`: 사주 명식 + 그래프 + 파생 팩트 + 평가 결과를 한 문서로 담는 구성은 **사주 도메인에 맞음.**
- `HourContext`: 시주 확정/미상/추정 상태와 후보 시주별 추가 정보(조건부 노드·팩트·평가)를 분리해 담는 구조로 **적절.**

---

## 6. 종합 결론

| 구분 | 판정 |
|------|------|
| 천간·지지·주·오행·음양 | 타입 범위와 의미가 사주 도메인과 **일치**함. |
| BirthInput·Geo·Engine | 양/음력, 윤달, 성별, 시간대, 위치, 엔진 구분이 **필요·충분**하게 반영됨. |
| Pillar·Node·Edge | 4주·지장간·관계를 그래프로 표현하는 모델이 **적절**함. |
| Evidence·Score·Fact·Eval | 근거 추적·점수·팩트/평가 구분이 **적절**함. |
| SajuDoc | 사주 추출 결과를 담는 문서 구조로 **무리 없음.** |

**최종:** `extract_saju.go`의 타입 구성은 **사주(四柱) 도메인에 부합**한다.  
추가로, 시주 미상 케이스를 포함한 문서 수준 제약(`Pillars` 길이, `HourContext.Status`, 후보 시주 구성)은 타입 외부 유효성 검사에서 함께 검증하는 것을 권장한다.

---

## 7. 추가 고려 사항 (사주 도메인 관점)

### 7.1 반영 완료 항목

| 대상 | 필드 | 사주 도메인 근거 |
|------|------|------------------|
| **BirthInput** | `TimePrec` | 생시 입력 정밀도(분/시/미상)를 명시해 시주 미상 데이터를 안전하게 구분 가능. |
| **SajuDoc** | `HourContext` | 시주 확정/미상/추정과 후보 시주별 조건부 결과를 분리 표현 가능. |
| **SajuDoc** | `EmptyBranches` | 공망(空亡) 지지 2개를 문서 단위로 안정적으로 참조 가능. |
| **SajuDoc** | `CreatedAt` | 계산 시점 기록(캐시/감사/재현)에 유용. |
| **SajuDoc** | `DaeunList` | 대운(大運) 기간 정보를 원국과 함께 저장 가능. |

### 7.2 선택적 추가

| 대상 | 필드 제안 | 사주 도메인 근거 |
|------|-----------|------------------|
| **BirthInput** 또는 **SajuDoc** | `LunarYMD *struct{ Y, M, D int; Leap bool }` | 음력 원문(윤달 포함) 표시·감사용. |
| **SajuDoc** | `RequestId string` | 문서 생성 요청 추적(재현/감사)용. |
| **BirthInput** 또는 **SajuDoc** | `Locale string` (또는 `DisplayLang`) | 다국어 표기 시 유리. |
| **Engine/Evidence** | 절기 기준 메타 | 월주 계산 기준(平氣/定氣, 테이블 버전) 명시 가능. |

---

**요약:**  
- 현재 모델은 시주 미상(Y/M/D만 입력)까지 포함해 사주 데이터를 표현할 수 있다.  
- 운영에서는 `HourContext`와 `Pillars` 길이 일관성 검증을 추가하면 안정성이 높아진다.
